<script>
App.page_mtrade_document_list=(function(){
    var require=[
	    "js/slick/lib/jquery.event.drag-2.3.0.js",
	    "js/slick/slick.core.js",
	    "js/slick/slick.grid.js",
	    "js/slick/plugins/slick.rowselectionmodel.js"];
    var docList;
    var Document;
    function gridInit(){
	function dateFormatter(row, cell, value, columnDef, dataContext){
	    var date_parts=value.split(' ')[0].split('-');
	    var date=date_parts[2]+'.'+date_parts[1]+'.'+date_parts[0];
	    return '<span title="'+value.split(' ')[1]+'">'+date+'</span>';
	}
	function tooltip(row, cell, value, columnDef, dataContext){
	    if( !value ){
		return '';
	    }
	    var parts = value.split(' ');
	    var cmd = parts.shift();
	    if (cmd){
		var style='max-width:16px;height:auto';
		return '<img src="img/' + cmd + '.png" style="'+style+'" title="' + parts.join(' ') + '">';
	    }
	    else{
		return '';
	    }	    
	}

	var settings={
	    columns:[
		{id:"pcomp_label", field: "pcomp_label",name: "Контрагент", width: 120 },
		{id:"doc_type_icon", field: "doc_type_icon",name: "", width: 25,formatter:tooltip},
		{id:"cstamp", field: "cstamp",name: "Дата",  width: 70, sortable: true,formatter:dateFormatter },
		{id:"doc_num", field: "doc_num",name: "Номер", width: 50, sortable: true,cssClass:'slick-align-right' },
		{id:"doc_total", field: "doc_total",name: "Сумма", width: 70, sortable: true },
		{id:"trans_status", field: "trans_status",name: "Оплачен", width: 25, sortable: true,formatter:tooltip},
		{id:"is_commited", field: "is_commited",name: "Проведен", width: 25,formatter:tooltip},
		{id:"doc_type_name", field: "doc_type_name",name: "Тип документа", sortable: true, width: 150 },
		{id:"views", field: "views",name: "Напечатано", width: 70}

	    ],
	    options:{
		enableCellNavigation: true,
		enableColumnReorder: false,
		enableFilter:true,
		multiSelect :false,
		url:'DocumentList/listFetch'
	    }
	};
	var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	$("#doclist_sg").css('height',(h-$("#doclist_sg").position().top-30)+'px');
	$("#doclist_sg_tools .icon-refresh").click(function(){
	    docList.reload();
	});
	docList=$("#doclist_sg").slickgrid(settings);
	docList.onSelectedRowsChanged.subscribe(function(e,selection){
	    var doclistRow=selection.grid.getDataItem(selection.rows[0]);
	    Document.load(doclistRow);
	});
    }
    function init(){
	//gridInit();
	App.Topic('passiveCompanySelected').subscribe(function(company){
	    docList.reload();
	});
	Document.load({doc_type:'sell',doc_id:7180});
    }
    Document=(function(){
	var documentModel;
	var headData={};
	function load(doclistRow){
	    function capitalize(s){
		return s && s[0].toUpperCase() + s.slice(1);
	    }
	    if( $.isNumeric(doclistRow.doc_type) ){
		switch(doclistRow.doc_type){
		    case '1':
			documentModel='DocumentSell';
			break;
		    case '2':
			documentModel='DocumentBuy';
			break;
		    case '3':
			documentModel='DocumentServiceout';
			break;
		    case '4':
			documentModel='DocumentServicein';
			break;
		}
	    } else if( doclistRow.doc_type.length>2 ) {//doc_type name must be at least 3 signs
		documentModel='Document'+capitalize(doclistRow.doc_type);
	    } else {
		documentModel=null;
	    }
	    headInit(documentModel,doclistRow.doc_id);
	    entriesInit(documentModel,doclistRow.doc_id);
	}
	function controlsInit(){
	    function pcompComboInit(){
		var node=$("#doclist_document_head  input[name=passive_company_id]");
		if( !node ){
		    return;
		}
		function pcomploader(param, success, error){
		    if( param.q===undefined ){
			success([{company_id:headData.passive_company_id,label:headData.label}]);
			return;
		    }
		    $.get('Company/listFetch/', param, function (xhr) {
			var resp = App.json(xhr);
			success(resp[0] ? resp : []);
		    });  	    
		}
		function pcomplistfrm(row){
		    var label=row.label;
		    if( row.path ){
			var path_chunks=row.path.split('>');
			var label=path_chunks.slice(path_chunks.length-2).reverse().join('/ ');
		    }
		    return label;
		}
		function openCompanyDetails(company_id){
		    App.loadWindow('page/company/details',{company_id:headData.passive_company_id});
		}
		var options={
		    valueField: 'company_id',
		    textField: 'label',
		    loader:pcomploader,
		    mode: 'remote',
		    hasDownArrow:false,
		    selectOnNavigation:false,
		    formatter:pcomplistfrm,
		    width:220,
		    icons: [
			{iconCls:'icon-settings16',handler: App.user.pcompSelectionDialog},
			{iconCls:'icon-change16',handler:openCompanyDetails}
		     ]
		};
		node.combobox(options);
	    }
	    pcompComboInit();
	    App[documentModel] && App[documentModel].init && App[documentModel].init($("#doclist_document_head"));
	    $("#doclist_document_head .document_toolbar").click(function(e){
		var action=$(e.target).data('action');
		if( action ){
		    headUpdate( action );
		}
	    });
	}
	function headInit(documentModel,doc_id){
	    function headDataLoad(){
		$.get(documentModel+'/headDataGet',{doc_id:doc_id},function(resp){
		    headData=App.json(resp);
		    App.setupForm("#doclist_document_head form",headData).change(function(){
			headUpdate( $(this).attr('name'), $(this).val(), $(this).attr('title') );
		    });
		    $.parser.parse("#doclist_document_head form");//for easy ui
		    controlsInit();
		});
	    }
	    $("#doclist_document_head").load(documentModel+'/headFormGet',headDataLoad);
	}
	function headUpdate( field, value, title ){
	    $.post( documentModel+'/headUpdate',{dac_id:headData.doc_id,field:field,value:value},function(ok){
		ok*1 && title && App.flash("Сохранено: "+title);
	    });
	}
	
	
	
	
	
	function entriesInit(documentModel,doc_id){
	    function tooltip(row, cell, value, columnDef, dataContext){
		if( !value ){
		    return '';
		}
		var parts = value.split(' ');
		var cmd = parts.shift();
		if (cmd){
		    var style='max-width:16px;height:auto';
		    return '<img src="img/' + cmd + '.png" style="'+style+'" title="' + parts.join(' ') + '">';
		}
		else{
		    return '';
		}	    
	    }
	    var curr_queue=0;
	    function queue(){
		return ++curr_queue;
	    }

	    var settings={
		columns:[
		    {id:"queue",name: "№",formatter:queue },
		    {id:"product_code", field: "product_code",name: "Код", width: 25, sortable: true },
		    {id:"product_name", field: "product_name",name: "Название",  width: 70},
		    {id:"product_quantity", field: "product_quantity",name: "Кол-во", width: 40, sortable: true,cssClass:'slick-align-right'},
		    {id:"product_unit", field: "product_unit",name: "Ед.", width: 30, sortable: true },
		    {id:"product_price", field: "product_price",name: "Оплачен", width: 40, sortable: true},
		    {id:"product_sum", field: "product_sum",name: "Проведен", width: 35},
		    {id:"row_status", field: "row_status",name: "Тип документа", sortable: true, width: 25,formatter:tooltip }
		],
		options:{
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    enableFilter:false,
		    multiSelect :true,
		    url:documentModel+'/listFetch'
		}
	    };
	    var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	    $("#doclist_sg").css('height',(h-$("#doclist_sg").position().top-30)+'px');
	    $("#doclist_sg_tools .icon-refresh").click(function(){
		docList.reload();
	    });
	    docList=$("#doclist_sg").slickgrid(settings);
	    docList.onSelectedRowsChanged.subscribe(function(e,selection){
		var doclistRow=selection.grid.getDataItem(selection.rows[0]);
		Document.load(doclistRow);
	    });
	    
	}
	
	return {
	    load:load
	};
    })();
    return {
	require:require,
	init:init
    };
})();
</script>
<style>
    #doclist_document_head input{
	width:110px;
    }
    #doclist_document_head select{
	width:121px;
	height:25px;
    }
    #doclist_document_head .inp_group{
	min-width:230px;
	vertical-align: middle;
    }
</style>
<div style="width:100%;">
    <div style="width:40%;max-width:415px;display: inline-block">
	<div id="doclist_sg_tools">
	    <div style="float: left;font-weight: bold;padding-top: 8px;">
		<img src="img/table16.png" style="width:16px;height: 16px;"> Документы
	    </div>
	    <div style="float: right">
		<span class="icon-24 icon-refresh" title="Обновить"> </span> 
	    </div>
	</div>
	<div id="doclist_sg" style="width:100%;height:700px;"></div>
    </div>
    <div style="width:60%;display: inline-block;vertical-align: top" id="doclist_document_panel" class="transp60">
	<div id="doclist_document_head"></div>
    </div>
</div>

