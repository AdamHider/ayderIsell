<script>
App.page_mtrade_document_list=(function(){
    var require=[
	    "js/slick/lib/jquery.event.drag-2.3.0.js",
	    "js/slick/slick.core.js",
	    "js/slick/slick.grid.js",
	    "js/slick/plugins/slick.rowselectionmodel.js",
	    "js/slick/slick.editors.js"];
    var docList;
    var Document;
    function gridInit(){
	function dateFormatter(row, cell, value, columnDef, dataContext){
	    var date_parts=value.split(' ')[0].split('-');
	    var date=date_parts[2]+'.'+date_parts[1]+'.'+date_parts[0];
	    return '<span title="'+value.split(' ')[1]+'">'+date+'</span>';
	}
	function tooltip(row, cell, value, columnDef, dataContext){
	    if( !value ){
		return '';
	    }
	    var parts = value.split(' ');
	    var cmd = parts.shift();
	    if (cmd){
		var style='max-width:16px;height:auto';
		return '<img src="img/' + cmd + '.png" style="'+style+'" title="' + parts.join(' ') + '">';
	    }
	    else{
		return '';
	    }	    
	}

	var settings={
	    columns:[
		{id:"pcomp_label", field: "pcomp_label",name: "Контрагент", width: 120 },
		{id:"doc_type_icon", field: "doc_type_icon",name: "", width: 25,formatter:tooltip},
		{id:"cstamp", field: "cstamp",name: "Дата",  width: 70, sortable: true,formatter:dateFormatter },
		{id:"doc_num", field: "doc_num",name: "Номер", width: 50, sortable: true,cssClass:'slick-align-right' },
		{id:"doc_total", field: "doc_total",name: "Сумма", width: 70, sortable: true },
		{id:"trans_status", field: "trans_status",name: "Оплачен", width: 25, sortable: true,formatter:tooltip},
		{id:"is_commited", field: "is_commited",name: "Проведен", width: 25,formatter:tooltip},
		{id:"doc_type_name", field: "doc_type_name",name: "Тип документа", sortable: true, width: 150 },
		{id:"views", field: "views",name: "Напечатано", width: 70}

	    ],
	    options:{
		enableCellNavigation: true,
		enableColumnReorder: false,
		enableFilter:true,
		multiSelect :false,
		url:'DocumentList/listFetch'
	    }
	};
	var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	$("#doclist_sg").css('height',(h-$("#doclist_sg").position().top-30)+'px');
	$("#doclist_sg_tools .icon-refresh").click(function(){
	    docList.reload();
	});
	docList=$("#doclist_sg").slickgrid(settings);
	docList.onSelectedRowsChanged.subscribe(function(e,selection){
	    var doclistRow=selection.grid.getDataItem(selection.rows[0]);
	    Document.load(doclistRow);
	});
    }
    function init(){
	//gridInit();
	App.Topic('passiveCompanySelected').subscribe(function(company){
	    docList.reload();
	});
	//Document.init({doc_type:'sell'});
	//Document.load(7180);
	$("#Document").load("page/mtrade/document.html",function(){
	    App.Document.init('sell');
	    App.Document.load(7180);
	});
    }
    Document=(function(){
	var doc_id;
	var doc_entry_sg;
	var document_model;
	var document_data;
	/*
	 * INIT SECTION
	 */
	function init(doclistRow){
	    function capitalize(s){
		return s && s[0].toUpperCase() + s.slice(1);
	    }
	    if( $.isNumeric(doclistRow.doc_type) ){
		switch(doclistRow.doc_type){
		    case '1':
			document_model='DocumentSell';
			break;
		    case '2':
			document_model='DocumentBuy';
			break;
		    case '3':
			document_model='DocumentServiceout';
			break;
		    case '4':
			document_model='DocumentServicein';
			break;
		}
	    } else if( doclistRow.doc_type.length>2 ) {//doc_type name must be at least 3 signs
		document_model='Document'+capitalize(doclistRow.doc_type);
	    } else {
		document_model=null;
	    }
	    initHead();
	    initEntries();
	}
	function initHead(){
	    function initHeadControls(){
		function pcompComboInit(){
		    var node=$("#doclist_document_head  input[name=passive_company_id]");
		    if( !node ){
			return;
		    }
		    function pcomploader(param, success, error){
			if( param.q===undefined ){
			    success([{company_id:headData.passive_company_id,label:headData.label}]);
			    return;
			}
			$.get('Company/listFetch/', param, function (xhr) {
			    var resp = App.json(xhr);
			    success(resp[0] ? resp : []);
			});  	    
		    }
		    function pcomplistfrm(row){
			var label=row.label;
			if( row.path ){
			    var path_chunks=row.path.split('>');
			    var label=path_chunks.slice(path_chunks.length-2).reverse().join('/ ');
			}
			return label;
		    }
		    function openCompanyDetails(company_id){
			App.loadWindow('page/company/details',{company_id:document_data.head.passive_company_id});
		    }
		    var options={
			valueField: 'company_id',
			textField: 'label',
			loader:pcomploader,
			mode: 'remote',
			hasDownArrow:false,
			selectOnNavigation:false,
			formatter:pcomplistfrm,
			width:220,
			icons: [
			    {iconCls:'icon-settings16',handler: App.user.pcompSelectionDialog},
			    {iconCls:'icon-change16',handler:openCompanyDetails}
			 ]
		    };
		    node.combobox(options);
		}
		pcompComboInit();
		App[document_model] && App[document_model].init && App[document_model].init($("#doclist_document_head"));
		$("#doclist_document_head .document_toolbar").click(function(e){
		    var action=$(e.target).data('action');
		    if( action ){
			headUpdate( action );
		    }
		});
	    }
	    $("#doclist_document_head").load(document_model+'/headFormGet',function(){
		App.setupForm("#doclist_document_head form").change(function(){
		    headUpdate( $(this).attr('name'), $(this).val(), $(this).attr('title') );
		});
		$.parser.parse("#doclist_document_head form");//for easy ui
		initHeadControls();		
	    });
	}
	function initEntries(){
	    if( doc_entry_sg ){
		return doc_entry_sg;
	    }
	    var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	    $("#doclist_document_entries_sg").css('height',(h-$("#doclist_document_entries_sg").position().top-30)+'px');

	    
	    var sg=$("#doclist_document_entries_sg").slickgrid(settings);
	    sg.onSelectedRowsChanged.subscribe(function(e,selection){
		//var doclistRow=selection.grid.getDataItem(selection.rows[0]);
	    });
	    sg.onCellChange.subscribe(function(e,data){
		var updatedEntry=data.item;
		var field=settings.columns[data.cell];
		var value=updatedEntry[field];
		entryUpdate(updatedEntry.document_entry_id,field,value);
	    });
	    return sg;
	}
	/*
	 * RENDER SECTION
	 */
	function renderDocument( render_data ){
	    render_data.head && renderHead( render_data.head );
	    render_data.entries && renderEntries(render_data.entries);
	    render_data.footer && renderFooter(render_data.footer);
	    render_data.views && renderViews(render_data.views);
	}
	function renderHead(head){
	    
	}
	function renderEntries(entries){
	    doc_entry_sg.setData(entries);
	    document_data.entries=entries;
	}
	function renderFooter(footer){
	    
	}
	function renderViews(views){
	    
	}
	/*
	 * INTERACTION SECTION
	 */
	function loadDocument( parts_to_load ){
	    var url=document_model+'/documentGet?doc_id='+doc_id;
	    $.post(url,{parts_to_load:parts_to_load},function(resp){
		var render_data=App.json(resp);
		if(render_data){
		    renderDocument( render_data );
		} else {
		    App.flash("Can't load document");
		}
	    });
	}
	    function entryUpdate(document_entry_id,field,value){
		var url=document_model+'/entriesFetch?doc_id='+doc_id;
		$.post(url,{document_entry_id:document_entry_id,field:field,value:value},function(ok){
		    
		});
	    }
	    
	    
	
	    $("#doclist_document_entries_sg_tools .icon-refresh").click(function(){
		doc_entry_sg.reload();
	    });
	
	
	
	function load(_doc_id){
	    doc_id=_doc_id;
	    var url=document_model+'/documentGet?doc_id='+doc_id;
	    $.post(url,function(resp){
		document_data=App.json(resp);
		headRender();
		entriesRender();
		footerRender();
	    });
	}
	function reload(){
	    load(doc_id);
	}
	function headInit(document_model,doc_id){
	    function headDataLoad(){
		$.get(document_model+'/headDataGet',{doc_id:doc_id},function(resp){
		    headData=App.json(resp);
		    App.setupForm("#doclist_document_head form",headData).change(function(){
			headUpdate( $(this).attr('name'), $(this).val(), $(this).attr('title') );
		    });
		    $.parser.parse("#doclist_document_head form");//for easy ui
		    controlsInit();
		});
	    }
	    $("#doclist_document_head").load(document_model+'/headFormGet',headDataLoad);
	}
	function headUpdate( field, value, title ){
	    $.post( document_model+'/headUpdate',{dac_id:headData.doc_id,field:field,value:value},function(ok){
		ok*1 && title && App.flash("Сохранено: "+title);
	    });
	}
	
	
	
	
	
	return {
	    init:init,
	    load:load,
	    reload:reload
	};
    })();
    return {
	require:require,
	init:init
    };
})();





</script>
<style>
    .slim-input input{
	width:110px;
    }
    .slim-input select{
	width:121px;
	height:25px;
    }
    .slim-input .inp_group{
	min-width:230px;
	vertical-align: middle;
    }
    #doclist_document_entries_sg input{
	width:100%;
	border: none;
    }
</style>
<div style="width:100%;">
    <div style="width:40%;max-width:415px;display: inline-block">
	<div id="doclist_sg_tools">
	    <div style="float: left;font-weight: bold;padding-top: 8px;">
		<img src="img/table16.png" style="width:16px;height: 16px;"> Документы
	    </div>
	    <div style="float: right">
		<span class="icon-24 icon-refresh" title="Обновить"> </span> 
	    </div>
	</div>
	<div id="doclist_sg" style="width:100%;height:700px;"></div>
    </div>
    <div style="width:70%;display: inline-block;vertical-align: top" id="Document" class="transp60"></div>
</div>