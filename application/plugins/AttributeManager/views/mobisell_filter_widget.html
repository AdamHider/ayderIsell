<script type="text/javascript">
App.stock.filter = {
    filter_tree:{},
    selected: [],
    last_expanded_filter_group:0,
    init: function () {
        $('#stock_filter_container').accordion({
            duration: 100,
            exclusive: false,
            onOpen: function () {
                App.stock.filter.last_expanded_filter_group=$(this).data('attribute_id');
            }
        });
        $('#stock_filter_container').change(function(){
            App.stock.filter.changed();
        });
        $("#stock_filter_tags").click(function(e){
            var attribute_value_hash=$(e.target).data('attribute_value_hash');
            if(attribute_value_hash){
                App.stock.filter.tags.remove(attribute_value_hash);
            }
        });
        App.Topic('StockEntriesRendered').subscribe(function(){
            App.stock.filter.load();
        });
    },
    load:function(){
        //optimisation: reducing reload of filter. Reload only if category_id or q is changed
        if( this.last_selected_hashes===App.stock.entries.parameters.selected_hashes
            && this.last_q===App.stock.entries.parameters.q 
            && this.last_category_id===App.stock.entries.parameters.category_id ){
            return;
        }
        this.last_selected_hashes=App.stock.entries.parameters.selected_hashes;
        this.last_q=App.stock.entries.parameters.q;
        this.last_category_id=App.stock.entries.parameters.category_id;
        $.post("../AttributeManager/filterGet",function(resp){
            var filter_tree=App.json(resp);
            if( filter_tree ){
                App.stock.filter.render(filter_tree);
            }
        });
    },
    render_prepare:function(filter_tree){
        let actualized_selected=[];
        let actualized_selected_count=0;
        for(let group of filter_tree){
            for(let attribute of group.attribute_values){
                if( attribute.is_selected==1 ){
                    actualized_selected.push(attribute);
                    actualized_selected_count++;
                }
            }
        }
        App.stock.filter.filter_tree=filter_tree;
        App.stock.filter.selected=actualized_selected;
        App.stock.filter.selected_count=actualized_selected_count;
    },
    render: function ( filter_tree ) {
        App.stock.filter.render_prepare(filter_tree);
        App.stock.filter.tags.render();
        App.renderTpl("stock_filter_container",{filter_tree: filter_tree});
        if( App.stock.filter.last_expanded_filter_group ){
            let attribute_id=App.stock.filter.last_expanded_filter_group;
            $('#stock_filter_attribute_' + attribute_id).addClass('active');
            $('#stock_filter_content_attribute_' + attribute_id).addClass('active');
        }
        $('.stock-attributes-button .attributes-selected-length').html(App.stock.filter.selected_count);
        $("#stock_filter_container input[data-attribute_is_selected=1]").prop('checked',1);
    },
    changed: function () {
        let selected_hashes_query=App.stock.filter.compile();
        App.stock.filter.tags.refresh(selected_hashes_query);
        App.stock.filter.apply();
    },
    compile:function(){
        let selected_hashes_query=''
        let selected_hashes={};
        $("#stock_filter_container input:checked").each(function(index,node){
            let attribute_id=$(node).data('attribute_id');
            let attribute_value_hash=$(node).data('attribute_value_hash');
            !selected_hashes[attribute_id] && (selected_hashes[attribute_id]=[]);
            selected_hashes[attribute_id].push(attribute_value_hash);
        });
        for( let i in selected_hashes){
            selected_hashes_query+="&"+selected_hashes[i].join("|");
        }
        App.store('stock_filter_selected_hashes_query',selected_hashes_query.substring(1));
        return selected_hashes_query;
    },
    apply:function(){
        let selected_hashes_query=App.restore('stock_filter_selected_hashes_query');
        if( App.stock.entries.parameters.selected_hashes!==selected_hashes_query ){
            App.stock.entries.parameters.selected_hashes=selected_hashes_query;
            App.stock.filter.load_filtered_entries();
        }
    },
    load_filtered_entries:function(){
        clearTimeout(App.stock.filter.clock);
        App.stock.filter.clock=setTimeout(function(){
            App.stock.entries.show_cart = false;
            App.stock.entries.load();
        },300);
    },
    clearSelected: function () {
        $("#stock_filter_container input:checked").prop('checked',0);
        App.stock.filter.changed();
    },
    tags:{
        render:function(){
            App.renderTpl("stock_filter_tags", {stock_filter_tags: App.stock.filter.selected});
        },
        remove:function( attribute_value_hash ){
            //only for responsivness until filter reloaded
            for(let i in App.stock.filter.selected){
                if( App.stock.filter.selected[i]['attribute_value_hash'] === attribute_value_hash ){
                    App.stock.filter.selected.splice(i,1);
                    break;
                }
            }
            $("#stock_filter_container input[data-attribute_value_hash="+attribute_value_hash+"]").prop('checked',0);
            App.stock.filter.changed();
        },
        refresh:function( selected_hashes_query ){
            //only for responsivness until filter reloaded
            let actualized_selected=[];
            let actualized_selected_count=0;
            for(let group of App.stock.filter.filter_tree){
                for(let attribute of group.attribute_values){
                    if( selected_hashes_query.indexOf(attribute.attribute_value_hash)>-1 ){
                        actualized_selected.push(attribute);
                        actualized_selected_count++;
                    }
                }
            }
            App.stock.filter.selected=actualized_selected;
            App.stock.filter.selected_count=actualized_selected_count;
            App.stock.filter.tags.render();
        }
    }
};
App.stock.filter.init();
</script>
<div id="stock_filter_popup" class="ui  segment " style="margin-bottom: auto;">
    <a  class="ui secondary close icon button" style="float:right; display: none" onclick="$('#stock_filter_popup').hide();
            $('#stock_content').show();"><i class="icon close"></i></a>
    <div class="header" style='padding: 1em;'><h4>Фильтр</h4></div>
    <div class="ui divider"></div>
    <!--TAGS-->
    <div id="stock_filter_tags" class="covert">
        <div class='title' style='margin-bottom: 5px'>
            {{ if stock_filter_tags}}
            <b>Выбрано:</b>
            {{else}}
            <i>Ничего не выбрано</i>
            {{/if}}
        </div>
        <div class="ui blue  labels">
            {{stock_filter_tags}}
            <a class="ui  label">
                {{attribute_name}}: {{attribute_prefix}} {{attribute_value}}{{attribute_unit}} 
                <i class="delete icon" data-attribute_value_hash="{{attribute_value_hash}}"></i>
            </a>
            {{/stock_filter_tags}}
        </div>
    </div>
    <!--/TAGS-->
    <div class="ui divider"></div>
    <div class="ui form" style="padding:1em">
        <div class="ui fields">
            <div class="sixteen wide field">
                <button class=" ui floated right blue fluid button" onclick="App.stock.filter.clearSelected()">
                    Очистить
                </button>
            </div>
        </div>
    </div>
    <div class="ui divider"></div>
    <!--ACCORDION-->
    <div id="stock_filter_container"  class="ui accordion covert">
        {{filter_tree}}
        <div class='attribute-container'>
            <div class="active title" id="stock_filter_attribute_{{attribute_id}}" >
                <i class="dropdown icon"></i>
                {{attribute_name}}
                <label class="attributes_added"></label>
            </div>
            {{if attribute_values}}
            <div class="content" id="stock_filter_content_attribute_{{attribute_id}}" data-attribute_id="{{attribute_id}}">
                <div class="ui form">
                    <div class="grouped fields" >
                        {{attribute_values}}
                        <div class="field">
                            <div class="ui child checkbox">
                                <input type="checkbox" 
                                       name="size" 
                                       value="small" 
                                       data-attribute_id="{{attribute_id}}" 
                                       data-attribute_value_hash="{{attribute_value_hash}}" 
                                       data-attribute_is_selected="{{is_selected}}" 
                                       data-attribute_value="{{attribute_prefix}} {{attribute_value}} {{attribute_unit}}" 
                                       >
                                <label>
                                    {{if product_count|equals>0}}
                                    <span style="color: gray">
                                    {{else}}
                                    <span>
                                    {{/if}}
                                        {{attribute_prefix}} {{attribute_value}} {{attribute_unit}} <span style="color: gray">({{product_count}})</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        {{/attribute_values}}
                    </div>
                </div>  
            </div>
            {{/if}}
        </div>
        {{/filter_tree}}
    </div>
    <!--/ACCORDION-->
</div>
<style type="text/css">
    #stock_filter_container .content {
        max-height: 18em;
        overflow: auto;
    }
    #stock_filter_container .title {
        color: black;
    }
    #stock_filter_container label {
        color: rgb(55, 55, 55);
    }
    .ui.inverted.dimmer{
        background-color: rgba(255, 255, 255, 0.3) !important;
    }
    #stock_filter_container .content{
        border-bottom: 1px solid rgb(232, 232, 232);
    }
    #stock_filter_container .attribute-container .title:hover{
        transition: 0.5s ease;
        background-color: #eee;
    } 

    #stock_filter_popup{
        -display:none;
        width: 90%;
        height: 100%;
        margin: 0 auto;
        z-index: 10;
    }
    #stock_filter_popup .ui.secondary.close.icon.button{
        display:block !important;
    }
    .stock-attributes-button.five.wide.field{
        display:block !important;
    }
</style>