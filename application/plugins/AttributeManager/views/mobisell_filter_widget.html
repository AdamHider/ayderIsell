<script type="text/javascript">
App.stock.filter = {
    tree: [],
    selected: {},
    last_expanded: [],
    init: function () {
        $('#stock_attributes_container').accordion({
            duration: 0,
            exclusive: false,
            onOpen: function () {
                App.stock.filter.last_expanded.push($(this).data('attribute_id'));
            },
            onClose: function () {
                var closed = $(this).data('attribute_id');
                var is_in_list = App.stock.filter.isInList(App.stock.filter.last_expanded, closed);
                App.stock.filter.last_expanded.splice(is_in_list, 1);
            }
        });
        App.stock.filter.load();
    },
    load:function(){
        $.post("../AttributeManager/filterGet",function(resp){
            var filter_tree=App.json(resp);
            if( filter_tree ){
                App.stock.filter.render(filter_tree);
            }
        });
    },
    render_prepare:function(filter_tree){
        let actualized_selected={};
        let actualized_selected_count=0;
        for(let group in filter_tree){
            for(let attribute in group){
                if( attribute.is_checked ){
                    actualized_selected[attribute.attribute_value_hash]=attribute;
                    actualized_selected_count++;
                }
            }
        }
        App.stock.filter.selected=actualized_selected;
        App.stock.filter.selected_count=actualized_selected_count;
    },
    render: function (filter_tree) {
        App.stock.filter.render_prepare(filter_tree);
        App.renderTpl("stock_attributes_container",{filter_tree: filter_tree});
        App.renderTpl("stock_attributes_selected", {stock_attributes_selected: App.stock.filter.selected});
        App.stock.filter.last_expanded.forEach(function (attribute_id) {
            $('#attribute_' + attribute_id).addClass('active');
            $('#content_attribute_' + attribute_id).addClass('active');
        });
        $('.stock-attributes-button .attributes-selected-length').html(App.stock.filter.selected_count);
    },
    select: function (node) {
        var checked = $(node).prop('checked');
        var attribute_value_hash = $(node).data('attribute_value_hash');
        if (checked) {
            App.stock.filter.add(attribute_value_hash);
        } else {
            App.stock.filter.remove(attribute_value_hash);
        }
        App.stock.entries.show_cart = false;
        App.stock.entries.load();
    },
    isInList: function (list, attribute_value_hash) {
        var i = 0;
        list.forEach(function (attribute, index) {
            if (attribute === attribute_value_hash) {
                i = index;
            }
        });
        return i;
    },
    add: function (attribute_value_hash) {
        App.stock.filter.selected[attribute_value_hash] = 1;
    },
    remove: function (e) {
        let attribute_value_hash = $(e.currentTarget).data('attribute_value_hash');
        if (App.stock.filter.selected[attribute_value_hash]) {
            delete App.stock.filter.selected[attribute_value_hash];
        }
    },
    clearSelected: function () {
        if (!App.stock.filter.selected.length) {
            return;
        }
        App.stock.filter.selected = {};
        //App.stock.entries.load();
    }
};
App.stock.filter.init();
</script>
<div id="stock_attribute_popup" class="ui  segment " style="margin-bottom: auto;">
    <a  class="ui secondary close icon button" style="float:right; display: none" onclick="$('#stock_attribute_popup').hide();
            $('#stock_content').show();"><i class="icon close"></i></a>
    <div class="header" style='padding: 1em;'><h4>Фильтр</h4></div>
    <div class="ui divider"></div>
    <div id="stock_attributes_selected" class="covert">
        <div class='title' style='margin-bottom: 5px'>
            {{ if stock_attributes_selected}}
            <b>Выбрано:</b>
            {{else}}
            <i>Ничего не выбрано</i>
            {{/if}}
        </div>
        <div class="ui blue  labels">
            {{stock_attributes_selected}}
            <a class="ui  label">
                {{attribute_name}}: {{attribute_prefix}} {{attribute_value}}{{attribute_unit}} 
                <i class="delete icon" data-attribute_value_hash="{{attribute_value_hash}}" onclick="App.stock.filter.remove();"></i>
            </a>
            {{/stock_attributes_selected}}
        </div>
    </div>
    <div class="ui divider"></div>
    <div class="ui form" style="padding:1em">
        <div class="ui fields">
            <div class="sixteen wide field">
                <button class=" ui floated right blue fluid button" onclick="App.stock.filter.clearSelected()">
                    Очистить
                </button>
            </div>
        </div>
    </div>
    <div class="ui divider"></div>
    <div id="stock_attributes_container"  class="ui accordion covert">
        {{filter_tree}}
        <div class='attribute-container'>
            <div class="active title" id="attribute_{{attribute_id}}" >
                <i class="dropdown icon"></i>
                {{attribute_name}}
                <label class="attributes_added"></label>
            </div>
            {{if attribute_values}}
            <div class="content" id="content_attribute_{{attribute_id}}" data-attribute_id="{{attribute_id}}">
                <div class="ui form">
                    <div class="grouped fields" >
                        {{attribute_values}}
                        <div class="field">
                            <div class="ui child checkbox">
                                <input type="checkbox" 
                                       name="size" 
                                       value="small" 
                                       data-attribute_id="{{attribute_id}}" 
                                       data-attribute_value_hash="{{attribute_value_hash}}" 
                                       data-attribute_value="{{attribute_prefix}} {{attribute_value}} {{attribute_unit}}" 
                                       onchange="App.stock.filter.select(this)">
                                <!--<label  {{ if product_total|falsy }} style="color: gray" {{{/if}}>-->
                                {{attribute_prefix}} {{attribute_value}} {{attribute_unit}} <span style="color: gray">({{product_count}})</span>
                                <!--</label>-->
                            </div>
                        </div>
                        {{/attribute_values}}
                    </div>
                </div>  
            </div>
            {{/if}}
        </div>
        {{/filter_tree}}
    </div>
</div>
<style type="text/css">
    #stock_attributes_container .content {
        max-height: 18em;
        overflow: auto;
    }
    #stock_attributes_container .title {
        color: black;
    }
    #stock_attributes_container label {
        color: rgb(55, 55, 55);
    }
    .ui.inverted.dimmer{
        background-color: rgba(255, 255, 255, 0.3) !important;
    }
    #stock_attributes_container .content{
        border-bottom: 1px solid rgb(232, 232, 232);
    }
    #stock_attributes_container .attribute-container .title:hover{
        transition: 0.5s ease;
        background-color: #eee;
    } 

    #stock_attribute_popup{
        -display:none;
        width: 90%;
        height: 100%;
        margin: 0 auto;
        z-index: 10;
    }
    #stock_attribute_popup .ui.secondary.close.icon.button{
        display:block !important;
    }
    .stock-attributes-button.five.wide.field{
        display:block !important;
    }
</style>