<script>
App.counting = {
    current_product_index: '',
    currentType: 'Document',
    log:[
        {
        product_code: "A0367",
        product_input: "12",
        product_name: "Лампа светодиодная шар 3.5Вт Е14 теплый 320Лм АСД",
        product_quantity: "5",
        time: "27.09.2018 15:19:59"
        }
    ],
    counting_document_list: [
        
    ],
    test_array: [
        {
            product_code: '24130407',
            product_name: 'Nilson Серебро Выключатель проход. без рамки',
            product_quantity: 3,
            product_verified: 0,
            product_unit: 'шт',
            verified: 0,
            box_quantity: 12
        },
        {
            product_code: 'A0367',
            product_name: 'Лампа светодиодная шар 3.5Вт Е14 теплый 320Лм АСД',
            product_quantity: 5,
            product_verified: 0,
            product_unit: 'шт',
            verified: 0,
            box_quantity: 12
        },
        {
            product_code: 'A0596',
            product_name: 'Светильник светодиодный аварийный СБА 8032С 24LED с наклейкой "ВЫХОД" lead-acid АС/DC',
            product_quantity: 2,
            product_verified: 0,
            product_unit: 'уп',
            verified: 0,
            box_quantity: 10
        }
    ],
    init: function (){
            this.initTab();
            this.focus(); 
            
        }
            
    },
    data_in_storage: function(){
        var storage_product_list = App.json(App.restore ('product_list'));
        var storage_log_list = App.json(App.restore ('log_list'));
        console.log('works');
        if (storage_product_list != null && storage_log_list != null){
            return true;
        } else {
            
            console.log('works');
            return false;
        }
    },
    initTab: function () {
        $('.counting_tabs .item').tab({
            onLoad: function (type) {
                App.counting.currentType = type;
                App.counting.load(type);
            }
        });
        $('.counting_tabs .item').tab('change tab', App.counting.currentType);
       
    },
    focus: function () {
        App.title("Учет");
        this.load();
    },
    load: function (type){
        if ( type === 'Document'){
            this.render_document();
        } else if ( type === 'Log'){
            this.render_log();
        }
    },
    render_log: function (){
        var now = new Date();
        var today=now.toLocaleDateString();
        var yesterday = new Date(now.setDate(now.getDate() - 1)).toLocaleDateString();
        //$('.counting_tabs .item').tab('change tab', 'Log');
        var search_data = $("#counting_log_search_input").val();
        var product_log = [];
        for (var i=0; i<App.counting.log.length; i++){
            search_data = search_data.replace(' ', '|');
            var pattern = new RegExp(search_data, 'i');
            var product_data = App.counting.log[i].product_name + ' ' + App.counting.log[i].product_code;
            var test = pattern.test (product_data);
            App.counting.log[i].time = App.counting.log[i].time.replace(today, "Сегодня в ").replace( yesterday, "Вчера в ");
            if( test === true ){
                product_log.push(App.counting.log[i]);
                $('#no_match_message').hide();
            }
        }
        App.renderTpl("log_list", {log_list: product_log});
        if ( product_log.length === 0 ){
            $('#no_match_message').hide();
        }
    },
    render_document: function (){
        $("#counting_log_search_input").val('');
        //$('.counting_tabs .item').tab('change tab', 'Document');
        App.renderTpl("product_list", {products: App.counting.test_array});
    },
    generate_product_log: function (){
        var fvalue = $('#counting_popup_quan_form').form('get values');
        $('.counting_tabs .item').tab('change tab', 'Log');
        $("#counting_log_search_input").val(fvalue.product_code);
        App.counting.render_log();
    },
    edit_quantity: function (node) {
        App.counting.current_product_index = $(node).data('index');
        $('#counting_quantity_popup').modal('show');
        App.renderTpl("quan_popup_content", {products: App.counting.test_array[App.counting.current_product_index]});
    },
    multiply_quantity: function () {
        var fvalue = $('#counting_popup_quan_form').form('get values');
        var product_verified = App.counting.test_array[App.counting.current_product_index].product_verified += fvalue.product_input * 1;
        var product_quantity = App.counting.test_array[App.counting.current_product_index].product_quantity;
        if ( product_verified === product_quantity || product_verified > product_quantity){
            App.counting.test_array[App.counting.current_product_index].verified = 1;
            //$('#verification_indicator_'+App.counting.current_product_index).hide();
        };
        App.counting.write_to_log(fvalue);
        $('#counting_quantity_popup').modal('hide');
        App.counting.render_document();
        App.store('product_list', App.counting.test_array);
    },
    write_to_log: function (entry){
        var date = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString();
        entry.time = date;
        App.counting.log.push(entry);
        App.store('log_list', App.counting.log);
    }
};   
    
    
</script>    
    



<style>
    #counting_list .product_row .three wide column{
        height: 1em;
        overflow: hidden;
    }
    div table .product_row .product_name {
        max-height: 7.3em !important;
        overflow: hidden !important;
    }
    div table .product_row .product_name div .three.wide.column{
        padding-top: 10px !important;
        padding-bottom: 0px !important;
    }
    .ui.celled.unstackable.selectable.table{
        border-top: none;
    }
    .counting_product_name{
        height: 4em;
        overflow-y: hidden;
    }
</style>

 <div class="ui top attached tabular menu counting_tabs">
      <a class="active item" data-tab="Document">Документ</a>
      <a class="item" data-tab="Log">Операции</a>
</div>
<div id="product_list" class="ui bottom attached tab covert" data-tab="Document">
     <table id="counting_list" class="ui celled unstackable selectable table" >
        <tr>
            <th>
                <div class="ui two column grid">
                    <div class="six wide column">Код</div>         
                    <div class="four wide column">Название</div>
                </div>
            </th>  
            <th class="right-aligned"> 
                <div class="five wide column">Проверено</div>
            </th>  
        </tr>
     
     
        <!--{{products}}-->
        <tr class="product_row" data-index="{{#}}" onclick="App.counting.edit_quantity(this)">
            <td class="product_name">
                <div class="ui two column stackable grid">
                    <div class="three wide column"><b>{{product_code}}</b></div>
                    <div class="seven wide column counting_product_name">{{product_name}}</div>
                </div>
            </td>
            <td class="right-aligned">
                <div class="ui grid">
                    <div class="three wide column">{{product_verified}}/{{product_quantity}}</div>
                    <div class="three wide column">{{product_unit}}</div>
                </div>
            </td>
            <td>
                <div id="verification_indicator_{{#}}">
                {{if verified|equals>0}}
                    <div>
                        <i class="exclamation circle red icon"></i>
                    </div>
                {{else}}
                    <div>
                        <i class="check circle green icon"></i>
                    </div>
                </div>
                {{/if}}
            </td>
        <!--{{/products}}-->
        </tr>
     </table>
</div>

<div  class="ui bottom attached  tab" data-tab="Log">
    <div id="counting_log_search" class="ui field">
        <div class="ui field">
            <label><b>Поиск</b></label>
            <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                <i class="search icon"></i>
                <input id="counting_log_search_input" placeholder="Введите название или код..." type="text" 
                       oninput="App.counting.render_log()">
                <div class="ui basic label" onclick="App.counting.clear_searchbar()"><i class="close icon"></i></div>
            </div>
        </div>
    </div>
    <div id='no_match_message' class='ui red floating message' style='display:none'>
        <p>По вашему запросу не найдено ни одной проверки</p>
    </div>
    <div id="log_list" class='covert'>
        <table class="ui celled unstackable selectable table" >
            <tr>
                <th class="left-aligned"> 
                    <div class="five wide column">Время проверки</div>
                </th>  
                <th>
                    <div class="ui three column grid">
                        <div class="three wide column">Код</div>         
                        <div class="six wide column">Название</div>
                        <div class="three wide column">Количество</div>
                    </div>
                </th>  

            </tr>


            <!--{{log_list}}-->
            <tr class="log_list_row" >
                <td class="left-aligned">
                    <div class="ui grid">
                        <div class="five wide column"><i>{{time}}</i></div>
                    </div>
                </td>
                <td class="log_name">
                    <div class="ui three column stackable grid">
                        <div class="three wide column"><b>{{product_code}}</b></div>
                        <div class="seven wide column counting_product_name">{{product_name}}</div>
                        <div class="three wide column">{{product_input}}</div>
                    </div>
                </td>
            </tr>
            <!--{{/log_list}}-->
            
         </table>
    </div>
</div>

<div id="counting_quantity_popup" class="ui small modal">
    
    <div id="quan_popup_content" class="ui segment">
        <div class="ui header centered">Изменение количества</div>
        <!--{{products}}-->
        <table class="ui very basic table">
            <tr class="positive"><td class="center aligned">{{product_name}}</td></tr>
            <tr class="positive"><td class="center aligned">{{product_code}}</td></tr>
            <tr class="positive">
                <td>Проверено:</td>
                <td class='left_aligned'>{{product_verified}}/{{product_quantity}}</td>
            </tr>
        </table>
        <form id='counting_popup_quan_form' class="ui form segment" onsubmit =>
            <div class="field">
                <label>Количество</label>
                <input type='hidden' name='product_name' value='{{product_name}}'>
                <input type='hidden' name='product_code' value='{{product_code}}'>
                <input type='hidden' name='product_quantity' value='{{product_quantity}}'>
                <input type="number" name="product_input" placeholder="Количество"
                       onfocus="this.select()"
                       value="{{box_quantity|blank>1}}">
            </div>
        
            <div class="actions" style="margin-left: auto; margin-right: auto">
            <button type="submit" class="ui labeled green icon submit button" onclick="App.counting.multiply_quantity(); return false">
                Готово
            </button>
            <button class="ui labeled icon cancel button" onclick="App.counting.generate_product_log('Type'); return false">
                 <i class="ban icon"></i>
                 Отмена
            </button>
            {{if product_verified|more>0}}    
            <button class="ui fluid labeled icon approve button" onclick="App.counting.generate_product_log(); return false">
                 <i class="ban icon"></i>
                 История операций
            </button>
            {{/if}}
            </div>
            <!--{{/products}}-->
        </form>
    </div>
</div>
