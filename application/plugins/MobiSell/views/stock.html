<script>
    App.stock = {
        
        init: function () {
            App.title("Каталог товаров");
            App.stock.head.init();
            App.stock.cart.init();
            App.stock.entries.init();
            App.stock.utils.initControls();
            App.Topic('passiveCompanySelected').subscribe(function () {
                $("#stock_pcomp_notice").hide();
                App.stock.entries.load();   
            });
            App.Topic('hashChange').subscribe(function () {
                App.stock.productInfoModal.showProductInfo(App.state['productInfoModal.showProductInfo']);
            });
            
            
            
            
        },
        focus: function () {
            App.title("Каталог товаров");
            App.stock.cart.setTotal();
            App.stock.entries.show_cart = false;
            App.stock.entries.load();    
        },
        render: function (){
        },
        head: {
            init: function(){
                App.stock.head.pcompInit();
                App.stock.categories.init();
                $('.limit-dropdown').dropdown();
                $('.order-by-dropdown').dropdown();
            },
            pcompInit: function () {
                $('.pcomp_id').dropdown({
                    apiSettings: {
                        url: 'compListFetch/'
                    },
                    fields: {
                        value: 'company_id',
                        name: 'label',
                        text: 'label'
                    },
                    filterRemoteData: true,
                    fullTextSearch: true,
                    onChange: function (value, text, $choice) {
                        if (value * 1 > 0) {
                            App.user.setPassiveCompany({company_id: value, label: text});
                        } else {
                            $(".pcomp_id").dropdown('set text', "Выберите клиента");
                            $(".pcomp_id").dropdown('show');
                        }
                    }
                }).dropdown("set text", App.user.pcomp.label || '');
            },
            clearSearchbar: function () {
                App.stock.entries.show_cart = 0;
                $("#stock_search_input").val('');
                App.stock.entries.load();
            }
            
        },
        categories: {
            list: [],
            init: function (){
                App.stock.categories.load();
            },
            load: function () {
                var params = {
                    id: 0,
                    depth: "3"
                };
                $.get("../Stock/branchFetch", params, function (response) {
                    App.stock.categories.list = App.json(response);
                    App.stock.categories.render();
                }); 
            },
             render: function () {
                App.renderTpl("categories_container", {categories: App.stock.categories.list});
            },
            find: function(query){
                if(query === ''){
                    App.stock.categories.clearSearchbar();
                    return;
                }
                var result = App.stock.categories.flatten(App.stock.categories.list,query.toLowerCase());
                App.renderTpl("categories_search_container", {categories: result});
                $("#categories_search_container").show();
                $(".categories-container").hide();
                
            },
            flatten: function(array,query){
                var result = [];
                array.forEach(function (a) {
                    if(a.label.toLowerCase().indexOf(query) > -1){
                       result.push(a);
                    }
                    
                    if (Array.isArray(a.children)) {
                        result = result.concat(App.stock.categories.flatten(a.children,query));
                    }
                });
                return result;  
            },
            clearSearchbar: function () {
                $("#categories_search_input").val('');
                $("#categories_search_container").hide();
                $(".categories-container").show();
                
            }
        },
        entries: {
            list: [],
            current_list: [],
            offset: 0,
            loading_finished: 0,
            show_cart:0,
            order_by: 'popularity,DESC',
            limit:12,
            category_id:0,
            init: function(){
                App.stock.entries.load();
            },
            load: function (load_more) {
                if (!App.user.pcomp.company_id) {
                    $("#stock_pcomp_notice").show();
                    return;
                };
                if (load_more) {
                    App.stock.entries.offset += App.stock.entries.limit;
                } else {
                    App.stock.entries.offset = 0;
                };
                var params = {
                    q: $('#stock_search_input').val(),
                    category_id: App.stock.entries.category_id,
                    offset: App.stock.entries.offset,
                    limit: App.stock.entries.limit+1,
                    sortby: App.stock.entries.order_by.split(',')[0],
                    sortdir: App.stock.entries.order_by.split(',')[1],
                    pcomp_id: App.user.pcomp.company_id
                };
                
                $('#stock_categories_header').html("");
                App.flash("Загрузка товаров...");
                $.post("../Stock/matchesListFetch", params, function (resp) {
                    App.flash("Загрузка товаров:ОК");
                    var new_loaded_items = App.json(resp);
                    
                    
                    console.log(new_loaded_items);
                    return;
                    
                    if ( load_more ) {
                        App.stock.entries.list = App.stock.entries.list.concat(new_loaded_items);
                    } else {
                        App.stock.entries.list = new_loaded_items;
                    };
                    if ( new_loaded_items.length < App.stock.entries.limit + 1 ) {
                        App.stock.entries.loading_finished = 1;
                    } else {
                        App.stock.entries.list.pop();
                        App.stock.entries.loading_finished = 0;
                    }
                    App.stock.entries.render();
                });
            },
            addSpecailProductFeatures: function () {
                for (var i = 0; i < App.stock.entries.current_list.length; i++) {
                    App.stock.entries.current_list[i].product_quantity = App.stock.cart.findInCart(App.stock.entries.current_list[i].product_id).product_quantity;
                    App.stock.entries.current_list[i].is_promo = (App.stock.entries.current_list[i].product_price_total !== App.stock.entries.current_list[i].product_price_total_raw) ? 1 : 0;
                }
            },
            render: function () {
                if(App.stock.entries.show_cart){
                    $('#stock_list').addClass('cart');
                    $('#stock_head_form .field').addClass('disabled');
                    App.stock.entries.current_list = App.stock.cart.list;
                } else {
                    $('#stock_list').removeClass('cart');
                    $('#stock_head_form .field').removeClass('disabled');
                    App.stock.entries.current_list = App.stock.entries.list;
                }
                App.stock.entries.addSpecailProductFeatures();
                var gridview=localStorage.getItem('stockGridView');
                App.stock.entries.gridViewConfigure(gridview); 
                App.stock.cart.renderButton(); 
                $('.cart-quantity').html(App.stock.cart.list.length);
                App.renderTpl("stock_list", {products: App.stock.entries.current_list, loading_finished: App.stock.entries.loading_finished, show_cart: App.stock.entries.show_cart});
            }, 
            renderItem: function (index, product_quantity){    
                var item_node = '#product_item_'+index;
                if(product_quantity<1 || !product_quantity){
                    $(item_node + ' .product-clear-button-container').hide();
                    App.stock.entries.render();
                }else{
                    $(item_node).css('background-color','#ffd');
                    $(item_node + ' .minus-button').removeClass('disabled');
                    $(item_node + ' .product-clear-button-container').show();
                    $(item_node + ' .product_quantity').val(product_quantity);
                    $(item_node + ' .product-clear-button').data('delta', product_quantity*-1);
                    if(App.stock.entries.show_cart){
                        $(item_node + ' .product-total').html(App.stock.cart.list[index].product_sum + ' ₽');
                    }
                }
            },
            gridViewConfigure: function(gridview){
                if(gridview>0){
                    $('#stock_list').addClass('grid-view');
                } else {
                    $('#stock_list').removeClass('grid-view');
                }
                return;
            },
            gridViewToggle: function(enable){
                localStorage.setItem('stockGridView',enable);
                App.stock.entries.gridViewConfigure(enable);
                App.stock.entries.render();
            }
        },
        utils: {
            getEntryByCode: function(product_code,array){
                for (var i = 0; i < array.length; i++) {
                    if (product_code == array[i].product_code) {
                        return array[i];
                    };
                };
            },
            initControls: function(){
                $('#stock_render_mode').click(function(e){
                    App.stock.entries.show_cart = $(e.target).data('show_cart');
                    $(e.target).data('show_cart', !App.stock.entries.show_cart);
                    App.stock.entries.render();
                });
                $('#stock_list').change(function(e){
                    var index = $(e.target).data('index');
                    
                    var product_object = App.stock.entries.current_list[index];
                    var new_quantity = e.target.value*1;
                    App.stock.cart.update(product_object,false,new_quantity, index);
                });
                $('#stock_list').click(function(e){
                    var delta = $(e.target).data('delta');
                    var action = $(e.target).data('action');
                    if(delta || action){
                        var index = $(e.target).data('index');
                        var product_object = App.stock.entries.current_list[index];
                        if(action){
                            App.stock.cart.update(product_object,0,product_object.product_quantity*-1, index); 
                            return;
                        } 
                        App.stock.cart.update(product_object,delta,false, index); 
                    }
                    
                });
                $('#stock_category_tree').click(function(e){
                    $('#categoriesPopup').modal({ inverted: true, duration:0}).modal('show');
                });
                $('.limit-dropdown').change(function(e){
                    App.stock.entries.limit = $(this).dropdown('get value')*1;
                    App.stock.entries.load();
                });
                $('.order-by-dropdown').change(function(e){
                    App.stock.entries.order_by = $(this).dropdown('get value');
                    App.stock.entries.load();
                });
                $(document).click(function(e){
                    var expand = $(e.target).data('action');
                    if(expand === 'expand_category'){
                       var toggle_id = e.target.parentNode.id;
                       $('#toggle_for_'+toggle_id.split('_')[1]).toggle('fast');
                    }
                    var category_id = $(e.target).data('category_id');
                    if(!category_id && category_id !== '0'){return;};
                    category_id === 'All' ? category_id = 0 : 0;
                    $('#stock_category_tree label.placeholder').html($(e.target).html());
                    App.stock.entries.category_id = category_id;
                    App.stock.entries.load();
                    $('#categoriesPopup').modal('hide');
                }); 
            }
        },
        cart: {
            list: [],
            total: '0.00',
            init: function(){
                App.stock.cart.restore();
            },
            renderButton: function(){
                App.renderTpl("stock_render_mode", {show_cart: App.stock.entries.show_cart, cart_quantity: App.stock.cart.list.length, total: App.stock.cart.total});
            },
            update: function (product_object,delta,new_quantity, index) {
                var founded_product=App.stock.cart.findInCart(product_object.product_id);
                var product_quantity = 0;
                if( !founded_product ){
                    if(!delta && new_quantity<=0){return};
                    product_object.product_quantity = delta || new_quantity;
                    product_quantity = App.stock.cart.add(product_object);
                } else {
                    if( founded_product.product_quantity+delta<=0 && new_quantity<=0 || new_quantity + founded_product.product_quantity<=0 || new_quantity===0 ){
                        product_quantity = App.stock.cart.delete(founded_product.index);
                    } else {
                        product_quantity = App.stock.cart.modify(founded_product.index,delta,new_quantity);
                    }
                }
                App.stock.cart.store();
                App.stock.cart.setTotal();
                App.stock.cart.renderButton();
                App.stock.entries.renderItem(index, product_quantity); 
            },
            delete: function(index){
                
                App.stock.cart.list.splice(index, 1);
                return false;
            },
            add:function(product_object){
                App.stock.cart.list.push(product_object);
                return product_object.product_quantity;
            },
            modify:function(index,delta,new_quantity){
                delta ? App.stock.cart.list[index].product_quantity += delta : App.stock.cart.list[index].product_quantity = new_quantity ;
                return App.stock.cart.list[index].product_quantity;
            },
            setTotal: function(){
                var total = 0;
                for (var i = 0; i < App.stock.cart.list.length; i++) {
                    App.stock.cart.list[i].product_sum = (App.stock.cart.list[i].product_price_total * App.stock.cart.list[i].product_quantity).toFixed(2);
                    total += App.stock.cart.list[i].product_sum*1 ;
                };
                App.stock.cart.total = total.toFixed(2);
            },
            findInCart: function (product_id) {
                for (var i = 0; i < App.stock.cart.list.length; i++) {
                    if (product_id === App.stock.cart.list[i].product_id) {
                        App.stock.cart.list[i].index=i;
                        return App.stock.cart.list[i];
                    };
                };
                return false;
            },
            store:function(){
                App.store('stock_cart_list',App.stock.cart.list);
            },
            restore:function(){
                var cart_list = App.json(App.restore('stock_cart_list'));
                if(cart_list){
                    App.stock.cart.list = cart_list;
                    App.stock.cart.setTotal();
                };
            },
            createDocument: function () {
                location.hash = "#document.html";
            }
        },
        productInfoModal:{
            showProductInfo: function (product_code) {
                if(!product_code){return;}
                $.post("./productGet", {product_code: product_code}, function (response) {
                        App.flash("Загрузка товаров:ОК");
                        var product_object = App.json(response);
                        if( !product_object.product_id ){return;}
                        product_object.quantity_in_cart = App.stock.cart.findInCart(product_object.product_id).product_quantity;
                        App.renderTpl('stock_product_info_modal', product_object);
                        $("#stock_product_info_modal").modal({ inverted: true, duration:0}).modal('show').modal('can fit');;
                    });
            }
        }
    };
</script>
<script src="../AttributeManager/view/?path=mobisell_filter_widget.js"></script>

<style>
    @media only screen and (max-width: 400px) {
        .categories-container{
            grid-template-columns: 100% !important;
        }
        #stock_list:not(.grid-view) .product-list-grid, .grid-view .product-list-grid{
            grid-template-columns: 100% !important;
        }
        .grid-view .product-item-grid{
            text-align: center !important;
            grid-template-columns: 100% !important;
        }
        #stock_list:not(.grid-view) .product-item-grid{
             grid-template-columns: 12% 87% !important;
             grid-column-gap: 1em !important;
             font-size: smaller !important;
             position: relative;
        }
        #stock_list:not(.grid-view) .product-info-column{
            width: 43vw !important;
        }
        #stock_list:not(.grid-view) .product-action-column{
           transform: scale(0.9) !important;
           width: 54vw !important;
           right: -12px !important;
           position: absolute !important;
           bottom: 0px !important;
        }
        
        .grid-view .product-image-column ,.grid-view .product-image-column img{
            height: 130px !important;
            width: auto !important;
        }
        #stock_list:not(.grid-view) .product-image-column img, #stock_list:not(.grid-view) .product-image-column {
           height: auto !important;
           width: 40px !important;
        }
        #stock_product_info_modal .content{
            grid-template-columns: 100% !important;
        }
        #stock_product_info_modal .content img{
            max-width: 60% !important;
        }
        #stock_product_info_modal .product-info-image{
            text-align: center;
        }
        #stock_product_info_modal .product-info-name{
            font-size: 16px !important;
        }
        #stock_product_info_modal .content .info-row{
            grid-template-columns: 60% 40% !important;
        }
        #stock_product_info_modal .product-info-details{
            max-height: max-content !important;
            overflow-y: visible !important;
            overflow-x: visible !important;
        }
        #stock_container {
            grid-template-columns: 100% !important;
        }
        
    }  
    @media only screen and (min-width: 400px) and (max-width: 650px) {
        .categories-container{
            grid-template-columns: 50% 50% !important;
        }
        #stock_list:not(.grid-view) .product-clear-button-container{
            position: initial !important;
        }
        .grid-view .product-list-grid{
            grid-template-columns: 50% 50% !important;
        }
        #stock_list:not(.grid-view) .product-list-grid{
            grid-template-columns: 100% !important;
        }
        .grid-view .product-item-grid{
            grid-template-columns: 100% !important;
            text-align: center !important;
        }
        #stock_list:not(.grid-view) .product-item-grid{
             grid-template-columns: 12% 87% !important;
             grid-column-gap: 1em !important;
             font-size: small !important;
             position: relative;
        }
        #stock_list:not(.grid-view) .product-info-column{
            width: 43vw !important;
        }
        #stock_list:not(.grid-view) .product-action-column{
           transform: scale(0.9) !important;
           width: 54vw !important;
           right: -12px !important;
           position: absolute !important;
           bottom: 0px !important;
        }
        
        #stock_list:not(.grid-view) .product-image-column img, #stock_list:not(.grid-view) .product-image-column {
            height: auto !important;
            width: 50px !important;
        }
        .grid-view .product-image-column ,.grid-view .product-image-column img{
            height: 130px !important;
            width: auto !important;
        }
        #stock_list:not(.grid-view) .product-action-column,.grid-view  .product-action-column{
            margin-top:1em;
        }
        #stock_product_info_modal .content{
            grid-template-columns: 100% !important;
        }
        #stock_product_info_modal .content img{
            max-width: 60% !important;
        }
        #stock_product_info_modal .product-info-image{
            text-align: center;
        }
        #stock_product_info_modal .product-info-name{
            font-size: 16px !important;
        }
        #stock_product_info_modal .content .info-row{
            grid-template-columns: 60% 40% !important;
        }
        #stock_product_info_modal .product-info-details{
            max-height: max-content !important;
            overflow-y: visible !important;
            overflow-x: visible !important;
        }
        #stock_container {
            grid-template-columns: 100% !important;
        }
    } 
    @media only screen and (min-width: 650px) and (max-width: 1000px) {
        #stock_list .stock_product_table{
            width: calc(50% - 8px);
        }
        .categories-container{
            grid-template-columns: 33% 33% 33% !important;
        }
         #stock_list:not(.grid-view) .product-list-grid{
            grid-template-columns: 100% !important;
        }
        #stock_list:not(.grid-view) .product-item-grid{
            grid-template-columns: 8% 25% 31% 29% !important
        }
        #stock_list:not(.grid-view) .product-image-column img{
            width: 70px !important;
        }
        #stock_list:not(.grid-view) .product-clear-button-container{
            position: initial !important;
        }
        .grid-view .product-list-grid{
            grid-template-columns: 33% 33% 33% !important;
        }
        .grid-view .product-image-column img , .grid-view .product-image-column{
            height: 130px !important;
        }
        #stock_container {
            grid-template-columns: 100% !important;
        }
    } 
    @media only screen and (min-width: 1000px) and (max-width: 1300px) {
        #stock_list .stock_product_table{
            width: calc(33% - 8px);
        }
        #stock_list:not(.grid-view) .product-clear-button-container{
             position: initial !important;
            right: -16vw;
        }
        .grid-view .product-list-grid{
            grid-template-columns: 33% 33% 33% !important;
        }
        .grid-view .product-image-column img , .grid-view .product-image-column{
            height: 130px !important;
        }
        #categoriesPopup{
            width: 80% !important;
            left: 10% !important;
        }
        #categoriesPopup .categories-container{
            grid-template-columns: 25% 25% 25% 25%  !important;
        }
    } 
    @media only screen and (min-width: 1300px) {
        #stock_list .stock_product_table{
            width: calc(25% - 8px);
        }
        #categoriesPopup{
            width: 80% !important;
            left: 10% !important;
        }
        .grid-view .product-list-grid{
            grid-template-columns: 33% 33% 33% !important;
        }
        #categoriesPopup .categories-container{
            grid-template-columns: 20% 20% 20% 20% 20% !important;
        }
    } 
    @media only screen and (min-width: 1600px) {
        #stock_list .stock_product_table{
            width: calc(25% - 8px);
        }
        #categoriesPopup{
            width: 80% !important;
            left: 10% !important;
        }
        .grid-view .product-list-grid{
            grid-template-columns: 25% 25% 25% 25% !important;
        }
        #categoriesPopup .categories-container{
            grid-template-columns: 20% 20% 20% 20% 20% !important;
        }
    } 
    #stock_list .stock_product_promo{
        box-shadow: 0px 0px 6px #0c0;
    }
    .stock_product_promo .stock_product_name{
        color: #0c0;
    }
    .ui.stackable.two.column.grid > .column:not(.row){
        padding-top: 0.3em !important;
        padding-bottom: 0.3em !important;
    }
    #stock_list_header{
        color: #7a7a7a;
    }
    #stock_header_prod_name{
        font-weight: bold;
        color: #427796;
    }
    .product-action-column button.ui.button.plus-button:hover{
        transition: 0.2s ease-in;
        background-color: #51b951 !important;
        color: white !important ;
    }
    .product-action-column button.ui.button.minus-button:hover{
        transition: 0.2s ease-in;
        background-color: #f75252 !important;
        color: white !important;
    }
    .ui.basic.label.product-total{
        border-top: none;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
        width: 97%;
        margin: 0px auto;
        background-color: #ffffff9e !important;
    }
    .product-image-column:hover{
        transition: 0.3s ease-in;
        opacity: 0.5;
    }
    .product-name-column a{
        color:  black;
    }
    .product-name-column a:hover{
        color:  #1678c2;
    }
    .ui.section.divider{
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        margin: 0 !important;
    }
    #stock_pcomp_notice{
        margin-left: 10px;
        font-weight: bold;
        color: blue;
    }
    .product-clear-button{
        left: 5vw!important;
    }
    #stock_category_tree, #stock_attributes{
       width: 100%;
       overflow: hidden;
       text-overflow: ellipsis;
    }
    #stock_category_tree i, #stock_attributes i{
        background-color: #2185d0;
        border: 1px solid #2185d0;
        color: white;
    }
    #stock_category_tree label, #stock_attributes label{
        font-weight: bold;
        white-space: nowrap;
    }
    .categories-container{
        display: grid;
        grid-template-columns: 25% 25% 25% 25% ;
    }
    .grandmother-category{
        padding: 5px;
        border-left: 1px solid lightgray;
        padding-left: 15px;
    }
    .grandmother-category-label{
        font-size: 16px;
        font-weight: bold;
    }
    .mothers-container{
        padding: 5px;
        margin-left: 10px;
    }
    .mother-category{
        padding: 5px;
    }
    .daughters-container{
        padding: 5px;
        margin-left: 20px;
    }
    .daughter-category{
        padding: 5px;
    }
    #categoriesPopup .categories-container, #stock_product_info_modal .product-info-details, #attributesPopup .attributes-container{
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    #categories_container label:hover, #categories_search_container label:hover{
        color: #1d588a;
        border-bottom: 1px solid black;
        transition: 1s;
    }
    #categories_search_container{
        padding-left: 2em;
    }
    .category-has-children{
        position: relative;
        color:black;
    }
    .category-has-children .angle.down.icon{
        margin-left: 4px;
    }
    .category-has-children .angle.down.icon:hover{
        border: 1px solid gray;
        border-radius: 3px;
        margin-top: -1px;
        margin-bottom: -1px;
    }
    .category-has-no-children{
        color: #6f6f6f;
    }
    #stock_list .product-item{
        background-color: white;
        border: 1px solid lightgray;
        margin-top: -1px;
        margin-right: -1px;
    }
    #stock_list .product-name-column{
        height: 4em;
        overflow: hidden;
        padding-left: 0.4em;
    }
    #stock_list .product-clear-button:hover{
        transition: 0.3s ease-in;
        transform: scale(1.05);
        background-color: red !important;
        color:white !important;
    }
    #stock_list:not(.grid-view) .product-list-grid{
        grid-template-columns: 100%;
    }
    #stock_list:not(.grid-view) .product-item-grid{
        text-align: left;
        grid-template-columns: 10% 35% 27% 26%;
        grid-column-gap: 1em;
    }
    #stock_list.cart:not(.grid-view) .product-item-grid{
        text-align: left;
        grid-template-columns: 10% 35% 27% 26%;
        grid-column-gap: 1em;
    }
    .cart .product-total{
        display:block !important;
    }
    #stock_list:not(.grid-view) .product-image-column, #stock_list:not(.grid-view) .product-image-column img{
        height: auto;
        width: 70px;
    }
    #stock_list:not(.grid-view) .product-clear-button-container{
        position: absolute;
        right: -16vw;
    }
    .product-info-column .eight.wide.column{
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }
    .grid-view .product-list-grid{
        grid-template-columns: 25% 25% 25% 25%;
    }
    .grid-view .product-item-grid{
        text-align: center;
        grid-template-columns: 100%;
    }
    .grid-view .product-image-column {
        height: 150px;
        width: auto;
    }
    
    .grid-view  .product-action-column{
        margin-top:1em;
    }
    .product-price{
        padding-left: 0px !important;
    }
    .product-price b, .product-price s{
        white-space: nowrap;
    }
    .product-price s{
        color: #ca6666;
        position: absolute;
        top: 0;
    }
    .product-list-grid{
        display: grid !important;
    }
    .product-item-grid{
        padding: 10px;
        align-items: center;
        text-align: center;
        display: grid !important;
    }
    
    #stock_product_info_modal .content{
        display: grid;
        grid-template-columns: 30% 70%;
        text-align: left;
    }
    #stock_product_info_modal .content .product-info-name{
        font-size: 20px;
        font-weight: bold;
        color: #1678c2;
    }
    #stock_product_info_modal .content .product-common-info,
    #stock_product_info_modal .content .product-stock-details,
    #stock_product_info_modal .content .product-secondary-info,
    #stock_product_info_modal .content .product-attributes{
        border-bottom: 1px solid lightgray;
        padding: 1em;
    }
    #stock_product_info_modal .content .info-row{
        display: grid;
        grid-template-columns: 40% 60%;
    }
    #stock_product_info_modal .content .info-cell{
        color: #5e5e5e;
    }
    #stock_product_info_modal .header-label{
        font-size: 16px;
        font-weight: bold;
    }
</style>





<div id="filteeer_widget"></div> 







<div id="stock_container" style="display: grid; grid-template-columns: 100%; grid-column-gap: 1em;">


    <div id="stock_content">
        <div  class="ui blue segment">
            <form class="ui form" id="stock_head_form">
                <div class="field">
                    <label>Клиент</label>
                    <div class="ui fluid search selection remote dropdown pcomp_id">
                        <input name="pcomp_id" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="default text">Выбрать клиента</div>
                        <div class="menu"></div>
                    </div>
                </div>

                <div id="stock_pcomp_notice" style="display: none">
                    <i class="ui blue exclamation circle icon"></i>
                    Выберите клиента
                </div>

                <div class="fields">
                    <div class="five wide field">
                        <label>Категории</label><div></div>
                        <div id='stock_category_tree' class='ui labeled basic blue  icon button'>
                            <i class='bars icon'></i>
                            <label class='placeholder'>Все</label>
                        </div>
                    </div>
                    <div id="stock_search" class="eleven wide field">
                            <label>Поиск</label>
                            <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                                <i class="search icon"></i>
                                <input id="stock_search_input" placeholder="Введите название или код..." type="text"
                                       oninput="App.stock.entries.load()">
                                <div class="ui basic label" onclick="App.stock.head.clearSearchbar()"><i class="close icon"></i></div>
                            </div>
                    </div>
                </div>
            </form>
            <div class="ui clearing divider ">
             </div>
            <div class="ui stackable grid">
                <div class="six wide left floated column">
                            <label><b> </b></label>
                    <div id="stock_render_mode" class="covert" tabindex="0"  >
                        <div class="ui labeled large button"  >
                            {{if show_cart}}
                            <div class="ui blue button" data-show_cart="0" >
                              <i class="chevron left icon"></i> К товарам
                            </div>
                            {{else}}
                            <div class="ui blue button" data-show_cart="1" >
                              <i class="shopping cart icon"></i> Корзина
                            </div>
                            {{/if}}
                            <a class="ui basic blue left pointing label" >
                             {{ cart_quantity }} / {{ total }} ₽
                            </a>
                        </div>
                    </div> 
                </div> 
                <div class="ten wide right floated left aligned column">
                    <div class='ui form'> 
                        <div class='fields'> 
                            <div class='eight wide left aligned field'>
                                <label>Сортировка:</label>
                                <div class="ui selection labeled  dropdown order-by-dropdown" style="min-width:auto">
                                    <i class="dropdown icon"></i>
                                    <div class="default text" style='white-space: nowrap;text-overflow: ellipsis;max-width: 100%;overflow: hidden;'>
                                        Сначала популярные
                                    </div>
                                    <div class="menu">
                                        <div class="item" data-value="popularity,DESC">Сначала популярные</div>
                                        <div class="item" data-value="popularity,ASC">Сначала непопулярные</div>
                                        <div class="item" data-value="price,DESC">Сначала дешевые</div>
                                        <div class="item" data-value="price,ASC">Сначала дорогие</div>
                                        <div class="item" data-value="newness,ASC">Сначала новинки</div>
                                        <div class="item" data-value="newness,DESC">Сначала постоянные</div>
                                    </div>
                                </div>
                            </div>
                            <div class='five wide left aligned field'>
                                <label>Показывать:</label>
                                <div class="ui selection labeled  dropdown limit-dropdown" style="min-width:auto">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">12</div>
                                    <div class="menu">
                                        <div class="item" data-value="12">12</div>
                                        <div class="item" data-value="24">24</div>
                                        <div class="item" data-value="48">48</div>
                                        <div class="item" data-value="100">100</div>
                                    </div>
                                </div>
                            </div>
                            <div class='three wide left aligned field'>
                                <label>Вид:</label>
                                <div class="ui basic buttons">
                                    <button class="ui  icon button" onclick="App.stock.entries.gridViewToggle(0)"> <i class="list icon"></i></button>
                                    <button class="ui   icon button" onclick="App.stock.entries.gridViewToggle(1)"> <i class="table icon"></i></button>
                                </div>
                            </div> 
                        </div> 
                    </div>
                </div>
            </div>
        </div>


        <div id="stock_list" class="covert">
            <div class="product-list-grid" >
                    <!-- {{if products}} {{products}} -->
                <div class='product-item' id="product_item_{{#}}" style=" {{if is_promo}}  background-color: #cfc;{{/if}}{{ if product_quantity|more>0 }} background-color: #ffd; {{else }}{{/if}}">

                    <div class="product-item-grid" >
                        <div class='product-image-column image-{{#}}' data-row-index="{{#}}" >
                            <a href="#stock.html#productInfoModal.showProductInfo={{product_code}}">
                                <img src="../Storage/image_flush/?size=150x150&path=/dynImg/{{product_img}}" >
                            </a>
                        </div>
                        <div class="product-name-column">
                            <a href="#stock.html#productInfoModal.showProductInfo={{product_code}}">
                                 {{product_name}}
                            </a>
                        </div>
                        <div class="product-info-column">
                            <div class="ui grid" style="color:#666; padding-right:1.4em">
                                    <div class="eight wide column">{{product_code}}</div>
                                    <div class="four wide column product-price" style="text-align: right">
                                        {{if price_promo}}
                                            <s>{{price_basic|format}}</s>
                                            <b>{{price_final|format}}</b>
                                        {{else}} 
                                            <b>{{price_final|format}}</b>
                                        {{/if}}
                                    </div>
                                    <div class="four wide column" style="text-align: right">{{if stared_leftover}} {{stared_leftover}} {{else}} {{leftover}}{{product_unit}} {{/if}}</div>
                            </div>
                        </div>
                        <div class="product-action-column">
                            <div class="ui centered grid">
                                <div class="twelve wide column">
                                    <div class="ui left icon input tiny fluid"  >
                                        <input type='hidden' name='product_img' value='{{product_img}}'>
                                        <input type='hidden' name='product_name' value='{{product_name}}'>
                                        <input type='hidden' name='product_code' value='{{product_code}}'>
                                        <input type='hidden' name='product_id' value='{{product_id}}'>
                                        <input type='hidden' name='leftover' value='{{leftover}}'>
                                        <input type='hidden' name='product_price_total' value='{{product_price_total}}'>

                                        <button class="ui  {{if product_quantity|less>1}} disabled   {{/if}} left attached icon  button minus-button" data-delta="-1" data-index="{{#}}">
                                            <i class="minus icon" data-delta="-1" data-index="{{#}}"></i>
                                        </button>
                                        <input type="number" name="product_quantity" placeholder="Количество" min="1" class="product_quantity"
                                                style="border-radius: 0px;   
                                                padding-left: 1em !important; 
                                                padding-right: 0.5em !important;" 
                                                data-index="{{#}}"
                                                value="{{if product_quantity|more>0}}{{product_quantity|blank>1}}{{else}}0{{/if}}">
                                        <button class="ui right attached icon  button plus-button" data-delta="1" data-index="{{#}}">
                                            <i class="plus icon" data-delta="1" data-index="{{#}}"></i>
                                        </button>

                                    </div> 
                                    <div class="ui basic  label product-total" style="display:none">{{if product_quantity|more>0}}{{product_sum}}{{else}}0{{/if}} ₽</div>
                                </div>
                                {{if product_quantity|more>0}}
                                <div class="four wide column product-clear-button-container" >
                                {{else}} 
                                <div class="four wide column product-clear-button-container" style="display:none">
                                {{/if}}
                                    <div class="ui circular icon button product-clear-button"  data-action="clear" data-index="{{#}}">
                                        <i class="trash alternate icon"  data-action="clear"  data-index="{{#}}"></i>
                                    </div>
                                </div>
                                        
                            </div>


                        </div>

                    </div>
                </div>
                <!-- {{/products}} {{else}}-->
                {{if show_cart|falsy}}
                <div>
                    <div >
                        <div class="ui message" style="clear: both;text-align: center;">
                           Ничего не найдено
                        </div>  
                    </div>
                </div>
                {{/if}}
                <!--{{/if}}-->
            </div>

            {{if show_cart|falsy}}
                {{if loading_finished}} 
                <div class="ui olive message" style="clear: both;text-align: center;">
                    Больше нет товаров для показа
                </div>   
                {{else}} 
                <button id='stock_load_more' class='ui fluid  button'
                        onclick="App.stock.entries.load(1)"> 
                    Показать ещё...
                </button>    
                {{/if}} 
             {{else}} 
                {{if products|length|more>0}} 
                <a class="ui approve green labeled icon button" href="#document.html" style="float: right; margin-top: 1em;">
                    <i class="check icon"></i>
                    Заказ
                </a>
                {{else}}
                <div class="ui olive message" style="clear: both;text-align: center;">
                    <i class="exclamation icon"></i>
                    Вы не добавляли товары в корзину
                </div>   
                {{/if}}
            {{/if}}
        </div>
    </div>
</div>

<div class="ui long modal" id="stock_product_info_modal">
    <div class="header">Сведения о товаре 
        <a href="#stock.html" class="ui secondary close icon button" style="float:right" onclick="$('#stock_product_info_modal').modal('hide');"><i class="icon close"></i></a>
    </div>
    <div class="content">
        <div class="product-info-image" >
            <img style="max-width: 100%" src="../Storage/image_flush/?size=400x400&path=/dynImg/{{product_img}}"/>
        </div>
        <div class="product-info-details">
            <div class="product-info-name">{{ru}}</div>
            <div class="product-common-info">
                <label class="header-label">Общие сведения</label>
                <div class="info-row">
                    <label>Код: </label>
                    <div class="info-cell">{{product_code}}</div>
                </div>
                <div class="info-row">
                    <label>Артикул: </label>
                    <div class="info-cell">{{product_article}}</div>
                </div>
                <div class="info-row">
                    <label>Штрихкод: </label>
                    <div class="info-cell">{{product_barcode}}</div>
                </div>
                <div class="info-row">
                    <label>Цена: </label>
                    <div class="info-cell">
                        <b>{{product_price_total}} ₽</b>
                    </div>
                </div>
            </div>
            <div class="product-stock-details">
                <div class="info-row">
                    <label>На складе: </label>
                    <div class="info-cell">{{product_quantity}} {{product_unit}}</div>
                </div>
                {{if quantity_in_cart}}
                <div class="info-row">
                    <label>В корзине: </label>
                    <div class="info-cell" style="color:green">(<b>{{quantity_in_cart}}</b> {{product_unit}})</div>
                </div>
                {{/if}}
            </div>
            <div class="product-secondary-info">
                {{if product_bpack}}
                <div class="info-row">
                    <label>Большая упаковка: </label>
                    <div class="info-cell">{{product_bpack}} {{product_unit}}</div>
                </div>
                {{/if}}
                {{if product_spack}}
                <div class="info-row">
                    <label>Малая упаковка: </label>
                    <div class="info-cell">{{product_spack}} {{product_unit}}</div>
                </div>
                {{/if}}
                {{if product_volume}}
                <div class="info-row">
                    <label>Объем: </label>
                    <div class="info-cell">{{product_volume}}</div>
                </div>
                {{/if}}
                {{if product_weight}}
                <div class="info-row">
                    <label>Вес: </label>
                    <div class="info-cell">{{product_weight}}</div>
                </div>
                {{/if}}
            </div>
            <div class="plugins"></div>
        </div>
    </div>
</div>

<div id="categoriesPopup" class="ui long modal" >
    <div class="header" style='padding: 1em;'>Выберите категорию
        <a  class="ui secondary close icon button" style="float:right" onclick="$('#categoriesPopup').modal('hide');"><i class="icon close"></i></a>
    </div>
    <div class="ui form" style="padding:1em">
        <div class="ui fields">
            <div class="three wide field">
                <label>Выбрать</label>
                <button class=" ui floated right blue fluid button" id="category_All" data-category_id="All" >
                        Все категории
                </button>
            </div>
            <div id="categories_input" class="thirteen wide field">
                <label>Поиск</label>
                <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                    <i class="search icon"></i>
                    <input id="categories_search_input" placeholder="Введите название категории..." type="text" value=""
                           oninput="App.stock.categories.find(this.value)">
                    <div class="ui basic label" onclick="App.stock.categories.clearSearchbar()"><i class="close icon"></i></div>
                </div>
            </div> 
        </div>
    </div>
    <div id="categories_search_container" style="display: none; height:max-content; border-top:1px solid lightgray">
        <div class="daughter-category category-has-no-children" ><h3>Результаты поиска: </h3></div>
        {{if categories}}
        {{categories|limit>12}}
                <div class="daughter-category category-has-no-children" id="suggest_category_{{branch_id}}">
                    <label data-category_id="{{branch_id}}">{{label}}</label>
                </div>
        {{/categories}}
        {{else}}
        <div class="daughter-category category-has-no-children" >Ничего не найдено</div>
        {{/if}}
    </div>
    <div class="ui divider"></div>
    <div id="categories_container" class="categories-container">
    {{categories}}
    {{if parent_id|equals>0}}
        <div class="grandmother-category" id="category_{{branch_id}}">
            <label class='grandmother-category-label' data-category_id="{{branch_id}}">{{label}}</label>
            {{if children}}
                <div class="mothers-container ">
                    {{children}}
                    <div class="mother-category category-toggler 
                         {{if children}}
                         category-has-children" id="category_{{branch_id}}"><label data-category_id="{{branch_id}}">{{label}}</label><i class='angle down icon' data-action='expand_category'></i>
                         {{else}}
                         category-has-no-children" id="category_{{branch_id}}"><label data-category_id="{{branch_id}}">{{label}}</label>{{/if}}
                        
                        {{if children}}
                            <div class="daughters-container" id="toggle_for_{{branch_id}}" style="display: none">
                                {{children}}
                                <div class="daughter-category category-toggler {{if children}}category-has-children{{else}}category-has-no-children{{/if}}" id="category_{{branch_id}}" ><label data-category_id="{{branch_id}}">{{label}}</label></div>
                                {{/children}}
                            </div>
                        {{/if}}

                    </div>
                    {{/children}}
                </div>
            {{/if}}
        </div>
    {{/if}}
    {{/categories}}
     </div>
</div>

