<!DOCTYPE html>
<html>
<head>
    <title>MobiSell</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#00A3D8">
    
    <script type="text/javascript" src="sw.js"></script>
    <link rel="manifest" href="manifest.json" crossOrigin="use-credentials">
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />

    <link rel="stylesheet" href="../js/Semantic-UI/semantic.min.css">
    <link rel="stylesheet" href="../js/picker/themes/default.css">
    <link rel="stylesheet" href="../js/picker/themes/default.date.css">
    <script type="text/javascript" src="../js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../js/Semantic-UI/semantic.min.js"></script>
    <script type="text/javascript" src="../js/markup.js"></script>
    <script type="text/javascript" src="../js/picker/picker.js"></script>
    <script type="text/javascript" src="../js/picker/picker.date.js"></script>
    <script type="text/javascript" src="../js/picker/translations/ru_RU.js"></script>
    <script type="text/javascript">
	App = {
	    state: {},
	    init: function () {
		App.sidebar.init();
		App.holder.init();
		//App.user.getData();
	    },
	    holder: {
		init: function () {
		    $(window).bind('hashchange', function (e) {
			App.holder.load(location.hash.substring(1));
		    });
		    if (location.hash) {
			App.holder.load(location.hash.substring(1));
		    }
		},
		load: function (url) {
		    var url_chunks = url.split("#");
		    App.url_file = url_chunks[0];
		    App.url_query = url_chunks[1];
		    App.parseState(App.url_query);
		    $("#main_container").load(App.url_file);
		    $(".ui.sidebar").sidebar('hide');
		}
	    },
	    sidebar: {
		init: function () {
		    $("#toggle").click(function () {
			$(".ui.sidebar").sidebar('toggle');
		    });
		}
	    },
	    tplcache: {},
	    json: function (text) {
		try {
		    return text === '' ? null : JSON.parse(text);
		} catch (e) {
		    console.log('isell-app-json-err: ' + e + text);
		    return null;
		}
	    },
	    toIso: function (dmy) {
		if (!dmy) {
		    return null;
		}
		var chunks = dmy.split('.');
		return chunks[2] + '-' + chunks[1] + '-' + chunks[0];
	    },
	    renderTpl: function (id, data, mode) {
		if (!this.tplcache[id] || mode === 'nocache') {
		    this.tplcache[id] = $('#' + id).html().replace(/&gt;/g, '>').replace(/<!--/g, '').replace(/-->/g, '');
		}
		$('#' + id).html(Mark.up(App.tplcache[id], data));
		$('#' + id).removeClass('covert');
	    },
	    parseState: function (text) {
		var newstate = {};
		if (text) {
		    var pairs = text.split('&');
		    for (var i in pairs) {
			var keyval = pairs[i].split('=');
			newstate[keyval[0]] = keyval[1];
		    }
		}
		App.state = newstate;
	    },
	    flash: function (msg) {
		$("#status").html(msg).show();
		clearTimeout(App.flashClock);
		App.flashClock = setTimeout(function () {
		    $("#status").hide();
		}, 1500);
	    },
	    user: {
		props: {},
		getData: function () {
		    $.get("../User/userFetch", function (resp) {
			App.user.props = App.json(resp);
			if (App.user.props) {
			    App.renderTpl("user_info", App.user.props);
			}
		    });
		},
		signOut: function () {
		    $.get("../User/SignOut", function (resp) {
			location.reload();
		    });
		}
	    }
	};
	$(App.init);
	
	
	
	if ('serviceWorker' in navigator) {
	    navigator.serviceWorker.register('../MobiSell/sw.js', {scope: '../MobiSell/'})
	    .then(function(reg) {
		console.log('serviceWorker Registration succeeded. Scope is ' + reg.scope);
	    }).catch(function(error) {
		console.log('serviceWorker Registration failed with ' + error);
	    });
	    
	    $.post('./version',function(current_version){
		var stored_version=localStorage.getItem("stored_version");
		if( current_version !== stored_version ){
		    navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage('clear_cache');
		    localStorage.setItem("stored_version",current_version);
		}
	    });
	}
    </script>
    <style>
	.covert{
	    display: none;
	    visibility: hidden;
	}
    </style>
</head>
<body>
    <div class="ui left vertical inverted sidebar labeled icon menu">
	<a href="#" class="item">
	    <i class="home icon"></i>
	    Главная
	</a>
	<a href="#document_list.html" class="item">
	    <i class="list layout icon"></i>
	    Список Документов
	</a>
	<a href="#document.html" class="item">
	    <i class="file outline icon"></i>
	    Создать документ
	</a>
	<a href="javascript:App.user.signOut()" class="item">
	    <i class="sign out icon"></i>
	    Выход
	</a>
    </div>
    <div class="ui basic icon top fixed menu">
	<a id="toggle" class="item">
	    <i class="sidebar icon"></i>
	    Меню
	</a>
	<div id="status" style="padding: .5em;color:green"></div>
    </div>
    <div id="main_container" class="pusher" style="margin-top: 42px;">
	<div style="text-align: center">
	    <img src="logo/144logo.png">
	    <h1 class="ui header">MobiSell 1.0</h1>
	</div>
	<div id="user_info" class="ui blue segment raised " style="margin: 10px;">
	    <div class="ui header">Добро пожаловать</div>
	    <div>
		<div class="ui vertical menu fluid">
		    <a href="#document_list.html" class="item">
			<i class="list layout icon"></i>
			Список Документов
		    </a>
		    <a href="#document.html" class="item">
			<i class="file outline icon"></i>
			Создать документ
		    </a>
		    <a href="javascript:App.user.signOut()" class="inverted item">
			<i class="sign out icon"></i>
			Выход
		    </a>
		</div>
	    </div>
	</div>
    </div>
</body>
</html>
