<!DOCTYPE html>
<html>
<head>
    <title>MobiSell</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#00A3D8">
    
    <script type="text/javascript" src="sw.js"></script>
    <link rel="manifest" href="manifest.json" crossOrigin="use-credentials">
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />

    <link rel="stylesheet" href="../js/Semantic-UI/semantic.min.css">
    <link rel="stylesheet" href="../js/picker/themes/default.css">
    <link rel="stylesheet" href="../js/picker/themes/default.date.css">
    <script type="text/javascript" src="../js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../js/Semantic-UI/semantic.min.js"></script>
    <script type="text/javascript" src="../js/markup.min.js"></script>
    <script type="text/javascript" src="../js/picker/picker.js"></script>
    <script type="text/javascript" src="../js/picker/picker.date.js"></script>
    <script type="text/javascript" src="../js/picker/translations/ru_RU.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script type="text/javascript">
        
	App = {
	    state: {},
            url_file:'',
	    init: function () {
		App.sidebar.init();
		App.holder.init();
		App.user.init();
		//App.user.signInPopup();
                if( localStorage.getItem('pcomp_id') ){
                    App.pcomp={company_id:localStorage.getItem('pcomp_id')};
                }
	    },
	    holder: {
		init: function () {
		    $(window).bind('hashchange', function (e) {
			App.holder.hashchanged(location.hash.substring(1));
		    });
		    App.holder.hashchanged(location.hash.substring(1));
		},
                hashchanged:function(url){
		    url=url||'home.html';
		    if(url=='home.html'){
			$('.mobisell_backbutton').hide();
		    } else {
			$('.mobisell_backbutton').show();
		    }
		    var url_chunks = url.split("#");
                    
 		    App.url_query = url_chunks[1];
		    App.parseState(App.url_query);
                    if( url_chunks[0] && App.url_file != url_chunks[0] ){
                        this.unload();
                        App.url_file = url_chunks[0];
                        this.load(url);
                    }
                    App.Topic('hashChange').publish(App.state);
		    App.sidebar.hide();
                },
                unload: function (){
                    var holder_id=App.url_file.split('.')[0];
                    App[holder_id] && App[holder_id].blur && App[holder_id].blur();
                    
                },
		load: function (url) {
		    var holder_id=App.url_file.split('.')[0];
		    if( !$("#"+holder_id).length ){
			$("#main_container").append("<div id='"+holder_id+"'></div>");
			$("#"+holder_id).load('view/?path='+App.url_file,function(){
                            App[holder_id] && App[holder_id].init && App[holder_id].init();
                            //App[holder_id] && App[holder_id].focus && App[holder_id].focus();           
                        });
		    } 
		    $("#main_container>div").hide();
		    $("#"+holder_id).show();
		    App[holder_id] && App[holder_id].focus && App[holder_id].focus();
		}
	    },
	    sidebar: {
		init: function () {
		    $("#toggle").click(function () {
			$(".ui.sidebar").sidebar('setting', 'transition', 'overlay').sidebar('toggle');
		    });
		    $("#backbutton").click(function(){
			history.back();
		    });
		},
                hide: function (){
                        $(".ui.sidebar").sidebar('hide');
                }
	    },
	    tplcache: {},
	    json: function (text) {
		try {
		    return text === '' ? null : JSON.parse(text);
		} catch (e) {
		    console.log('isell-app-json-err: ' + e + text);
		    return null;
		}
	    },
            store: function (key, object){
                localStorage.setItem(key, JSON.stringify(object));
            },
            restore: function (key, object){
                return localStorage.getItem(key, object);
            },
	    toIso: function (dmy) {
		if (!dmy) {
		    return null;
		}
		var chunks = dmy.split('.');
		return chunks[2] + '-' + chunks[1] + '-' + chunks[0];
	    },
	    renderTpl: function (id, data, mode) {
		if (!this.tplcache[id] || mode === 'nocache') {
		    this.tplcache[id] = $('#' + id).html().replace(/&gt;/g, '>').replace(/<!--/g, '').replace(/-->/g, '');
		}
		$('#' + id).html(Mark.up(App.tplcache[id], data));
		$('#' + id).removeClass('covert');
	    },
	    parseState: function (text) {
		var newstate = {};
		if (text) {
		    var pairs = text.split('&');
		    for (var i in pairs) {
			var keyval = pairs[i].split('=');
			newstate[keyval[0]] = keyval[1];
		    }
		}
		App.state = newstate;
	    },
	    flash: function (msg) {
		if(!msg){
		    return;
		}
		$("#status").html(msg).show();
		clearTimeout(App.flashClock);
		App.flashClock = setTimeout(function () {
		    $("#status").hide();
		}, 1500);
	    },
            alert: function(msg){
                $("#index_alert_popup .content").html(msg);
                $("#index_alert_popup").modal("show");
                $("#index_confirm_popup .approve").focus();
                //$("#index_alert_popup button").c
            },
            confirm:function(msg){
                var def=$.Deferred();
                $("#index_confirm_popup .content").html(msg);
                $("#index_confirm_popup").modal({
                    onApprove:function(){
                        def.resolve();
                    },
                    onDeny:function(){
                        def.reject();
                    }
                }).modal("show");
                $("#index_confirm_popup .approve").focus();
                return def.promise();
            },
            prompt:function(msg,value){
                var def=$.Deferred();
                $("#index_prompt_popup .header").html(msg);
                $("#index_prompt_popup input").val(value||'');
                $("#index_prompt_popup").modal({
                    onApprove:function(){
                        def.resolve( $("#index_prompt_popup input").val() );
                    },
                    onDeny:function(){
                        def.reject(null);
                    }
                }).modal("show");
                $("#index_prompt_popup .approve").focus();
                return def.promise();
            },
	    title:function(msg){
		$("#title").html(msg);
	    },
	    user: {
		props: {},
                acomp:{},
                pcomp:{},
                init:function(){
                    this.restoreCompanies();
                    App.user.props=JSON.parse(localStorage.getItem('user_props'));
                },
		getData: function () {
		    $.post("./userPropsGet", function (resp) {
			App.user.props = App.json(resp);
			if (App.user.props) {
			    App.renderTpl("user_info", App.user.props);
                            localStorage.setItem('user_props',JSON.stringify(App.user.props));
			}
		    }).fail(function(jqxhr, settings, ex){
                        console.log(jqxhr, settings, ex);
                        App.user.signInPopup();
                    });
		},
		signOut: function () {
		    $.post("../User/SignOut", function (resp) {
			location.reload();
		    });
		},
		signIn:function(){
		    var login=$("input[name=user_login]").val();
		    var pass=$("input[name=user_pass]").val();
		    $('#signInModal .primary').addClass('loading');
		    $.post("../User/SignIn",{login:login,pass:pass}).done(function(ok){
			$('#signInModal').modal('hide');
			location.reload();
			$('#signInModal .loading').removeClass('loading');
		    }).fail(function(){
			$('#signInModal .loading').removeClass('loading');
		    });
		},
		signInPopup:function(){
		    $('#signInModal').modal('show');
		},
                setPassiveCompany:function(company){
                    App.user.pcomp=company;
                    localStorage.setItem('pcomp',JSON.stringify(App.user.pcomp));
                    App.Topic('passiveCompanySelected').publish(company);
                },
                setActiveCompany:function(company){
                    App.user.pcomp=company;
                    localStorage.setItem('acomp',JSON.stringify(App.user.pcomp));
                    App.Topic('activeCompanySelected').publish(company);
                },
                restoreCompanies:function(){
                    App.user.pcomp=JSON.parse(localStorage.getItem('pcomp')) || {};
                    App.user.acomp=JSON.parse(localStorage.getItem('acomp')) || {};
                },
                pcompSelect: function ( company ) {
		    var company_id=company.company_id||0;
		    if( App.pcomp && App.pcomp.company_id===company_id ){
			return;
		    }
		    return $.post('../Company/selectPassiveCompany/' + company_id, function (xhr) {
			App.user.setPassiveCompany(App.json(xhr));
		    });
		},
                acompSelect: function ( company ) {
		    var company_id=company.company_id||0;
		    if( App.acomp && App.acomp.company_id===company_id ){
			return;
		    }
		    return $.post('../Company/selectActiveCompany/' + company_id, function (xhr) {
			App.user.setActiveCompany(App.json(xhr));
		    });
		}
	    },
            topics:[],
            Topic:function (id) {
                var callbacks, topic = id && App.topics[ id ];
                if (!topic) {
                    callbacks = jQuery.Callbacks("memory");
                    topic = {
                        publish: callbacks.fire,
                        subscribe: callbacks.add,
                        unsubscribe: callbacks.remove
                    };
                    if (id) {
                        App.topics[ id ] = topic;
                    }
                }
                return topic;
            },
	    clearCache:function(){
		navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage('clear_cache');
                console.log("Cache cleared");
		location.reload();
	    },
	    retryConnection:function(){
		$('#offline_popup').modal('hide');
		if( navigator.onLine ){
                    console.log();
		    location.reload();
		} else {
		    $('#offline_popup').modal('show');
		}
	    },
            speech:{
                say:function( text ){
                    var synth = window.speechSynthesis;
                    var utterThis = new SpeechSynthesisUtterance(text);
                    utterThis.pitch = 1;
                    utterThis.rate = 2;
                    synth.speak(utterThis);
                }
            }
	};
	$(App.init);

	if ( localStorage.getItem("disableSW")!=1 && ('serviceWorker' in navigator) ) {
	    navigator.serviceWorker.register('../MobiSell/sw.js', {scope: '../MobiSell/'})
	    .then(function(reg) {
		//console.log('serviceWorker Registration succeeded. Scope is ' + reg.scope);
	    }).catch(function(error) {
		console.log('serviceWorker Registration failed with ' + error);
	    });
	    
	    navigator.serviceWorker.addEventListener('message',function(event){
		var msg=event.data;
		if(msg.status=='401'){
		    App.user.signInPopup();
		}
		if(msg.status=='408'){
		    $("#offline_popup").modal('show');
		}
		console.log(event.data);
	    });
	    
	    $.post('./version',function(current_version){
		var stored_version=localStorage.getItem("stored_version");
		if( current_version != stored_version ){
		    localStorage.setItem("stored_version",current_version);
		    App.clearCache();
		}
	    });
	}
    </script>
    <style>
	.covert{
	    display: none;
	    visibility: hidden;
	}
	#status{
	    padding: .5em;
	    color:#fff;
	    position: absolute;
	    right: 0px;
	    margin: 3px;
	    background-color: rgba(0,0,0,.8);
	    border-radius: .3em;
	}
        #main_container{
            background-color: #f7fafb;
        }
        @media only screen and (min-width: 800px) {
            #main_container{
                padding: 0 5% 0 5%;
            }
        } 
        @media only screen and (min-width: 1200px) {
            #main_container{
                padding: 0 10% 0 10%;
            }
        } 
    </style>
</head>
<body>
    <div class="ui right vertical inverted sidebar labeled icon menu">
	<a href="#home.html" class="item">
	    <i class="home icon"></i>
	    Главная
	</a>
	<a href="#stock.html" class="item">
	    <i class="cube icon"></i>
	    Каталог товаров
	</a>
        <a href="#checkout_document_list.html" class="item">
	    <i class="clipboard list icon"></i>
	    Учет
	</a>
	<a href="#document_list.html" class="item">
	    <i class="list layout icon"></i>
	    Список Документов
	</a>
	<a href="#document.html" class="item">
	    <i class="file outline icon"></i>
	    Создать документ
	</a>
        <a href="#payments.html" class="item">
	    <i class="exchange icon"></i>
	    Взаиморасчет
	</a>
    	<a href="javascript:App.clearCache()" class="item">
		<i class="refresh icon"></i>
		Сбросить настройки
	</a>
	<a href="javascript:App.user.signOut()" class="item">
	    <i class="sign out icon"></i>
	    Выход
	</a>
    </div>
    <div class="ui basic icon top fixed menu">
	<div class="left menu mobisell_backbutton">
	    <a href="javascript:history.back();" class="item ">
		<i class="left arrow icon"></i>
	    </a>
	    <span class="ui tiny header item" id="title"></span>
	</div>
	
	<div class="right menu">
	    <a id="toggle" class="item">
		<i class="sidebar icon"></i>
		Меню
	    </a>
	</div>
	<div id="status" style="display: none;"></div>
    </div>
    
    
    <div id="main_container" class="pusher" style="margin-top: 42px;"></div>
    
    <div class="ui modal" id="signInModal">
	<div class="header"><i class="sign in icon"></i>Вход в систему</div>
	<div class="content">
	    <form action="./?"  method="post" enctype="multipart/form-data">
                <div class="ui left icon fluid input">
                    <input placeholder="Логин" name="user_login">
                    <i class="user icon"></i>
                </div>
                <div class="ui left icon fluid input">
                    <input placeholder="Пароль" name="user_pass" type="password">
                    <i class="lock icon"></i>
                </div>
	    </form>
	</div>
	<div class="actions">
	    <div class="ui primary button"  onclick="App.user.signIn()"><i class="icon sign in"></i> Вход</div>
	    <div class="ui secondary close button"  onclick="$('#signInModal').modal('hide');"><i class="icon close"></i> Закрыть</div>
            <div class="ui negative button"  onclick="App.clearCache()"><i class="icon refresh"></i> Выход</div>
	</div>
    </div>
    
    <div class="ui modal" id="offline_popup">
	<div class="header"><i class="ban icon"></i>Нет связи с сервером</div>
	<div class="content">
	    Интернет соединение отсутствует или сервер в данный момент не отвечает
	</div>
	<div class="actions">
	    <div class="ui primary button" onclick="App.retryConnection()"><i class="icon repeat"></i> Попробовать снова</div>
	    <div class="ui secondary close button" onclick="$('#offline_popup').modal('hide');"><i class="icon close"></i> Закрыть</div>
	</div>
    </div>
    
    <div class="ui modal" id="index_alert_popup">
	<div class="header">Внимание</div>
	<div class="content"> --- </div>
	<div class="actions">
	    <button class="ui secondary approve button"><i class="icon check"></i> Ок</button>
	</div>
    </div>
    <div class="ui modal" id="index_confirm_popup">
	<div class="header">Вопрос</div>
	<div class="content"> --- </div>
	<div class="actions">
	    <button class="ui positive approve button"><i class="icon check"></i> Ок</button>
            <button class="ui negative deny button"><i class="icon close"></i> Отменить</button>
	</div>
    </div>
    <div class="ui modal" id="index_prompt_popup">
	<div class="header">Вопрос</div>
        <div class="content ui input">
            <input type="text">
        </div>
	<div class="actions">
	    <button class="ui positive approve button"><i class="icon check"></i> Ок</button>
            <button class="ui negative deny button"><i class="icon close"></i> Отменить</button>
	</div>
    </div>
</body>
</html>
