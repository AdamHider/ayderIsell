<form class="ui form">
    <div class="field">
	<label>Клиент</label>
	<div class="field">
	    <input name="company_filter" placeholder="Название клиента" type="text" onkeyup="App.document_list.compSearch(this.value)">
	</div>
    </div>
    <div class="field">
	<label>Дата</label>
	<div class="field">
	    <input name="company_filter" placeholder="Дата" type="date" class="datepicker">
	</div>
    </div>
</form>



<div class="ui top attached tabular menu">
    <a class="active item" data-tab="sell">Расход</a>
    <a class="item" data-tab="buy">Приход</a>
</div>
<div class="ui bottom attached  tab segment" data-tab="sell" id="documents_sell">
    <table class="ui green selectable  table unstackable">
	<thead>
	    <tr>
		<th>№</th>
		<th>Клиент</th>
		<th>Сумма</th>
		<th>!</th>
	    </tr>
	</thead>
	<tbody>
	    <!-- {{if doc_list}} {{doc_list}} -->
	    <tr data-doc-id="{{doc_id}}" onclick="App.document_list.handleClick(this)">
		<td><i class="green icon arrow left"></i>{{doc_num}}</td>
		<td>{{label}}</td>
		<td>{{amount}}</td>
		<td>{{if is_commited|more>0}}<i class="gray checkmark box icon"></i>{{else}}<i class="square outline icon"></i>{{/if}}</td>
	    </tr>
	    <!-- {{/doc_list}} {{else}}-->
	    <tr>
		<td colspan="4"><i class="green icon arrow left"></i>Ничего не найдено</td>
	    </tr>
	    <!--{{/if}}-->
	</tbody>
    </table>
</div>
<div class="ui bottom attached tab segment" data-tab="buy" id="documents_buy">
    <table class="ui purple selectable unstackable table ">
	<thead>
	    <tr>
		<th style="width:8em">№</th>
		<th>Поставщик</th>
		<th style="width:10em">Сумма</th>
		<th>!</th>
	    </tr>
	</thead>
	<tbody>
	    <!-- {{if doc_list}} {{doc_list}} -->
	    <tr data-doc-id="{{doc_id}}" onclick="App.document_list.handleClick(this)">
		<td><i class="purple icon arrow right"></i>{{doc_num}}</td>
		<td>{{label}}</td>
		<td>{{amount}}</td>
		<td>{{if is_commited|more>0}}<i class="gray checkmark box icon"></i>{{else}}<i class="square outline icon"></i>{{/if}}</td>
	    </tr>
	    <!-- {{/doc_list}} {{else}}-->
	    <tr>
		<td colspan="4"><i class="purple icon arrow right"></i>Ничего не найдено</td>
	    </tr>
	    <!--{{/if}}-->
	</tbody>
    </table>
</div>
<button class="ui primary loading fluid button" onclick="App.document_list.loadMore()">Показать еще...</button>
<script>
    App.document_list = {
	init: function () {
	    App.document_list.initPicker();
	    App.document_list.initTab();
	},
	initPicker: function () {
	    var $input = $('.datepicker').pickadate();
	    App.document_list.picker = $input.pickadate('picker');
	    App.document_list.picker.set('select', new Date('2017-08-02'));
	    App.document_list.picker.on({
		set: function () {
		    App.document_list.reload();
		}
	    });
	},
	initTab:function(){
	    $('.menu .item').tab({
		onVisible:function( type ){
		    App.document_list.currentType=type;
		    App.document_list.loadIfEmpty(type);
		}
	    });
	    $('.menu .item').tab('change tab', 'sell');
	},
	handleClick:function(node){
	    var doc_id=$(node).data('doc-id');
	    location.hash="#view/document.html#doc_id="+doc_id;
	},
	render:function( type, doc_list ){
	    App.renderTpl('documents_'+type, {doc_list:doc_list});
	},
	docTypeConfig:{
	    sell:{
		entries:[]
	    },
	    buy:{
		entries:[]
	    }
	},
	compFilter:'',
	currentType:'',
	load: function (type,offset) {
	    var date=App.document_list.picker.get('select', 'yyyy-mm-dd');
	    if( offset===undefined ){
		offset= App.document_list.docTypeConfig[type].entries.length||0;
	    }
	    $.post('doclistGet', {type:type,date: date,offset:offset,compFilter:App.document_list.compFilter}, function (resp) {
		var doc_list = App.json(resp);
		App.document_list.docTypeConfig[type].entries=App.document_list.docTypeConfig[type].entries.concat(doc_list);
		App.document_list.render(type,App.document_list.docTypeConfig[type].entries);
	    });
	},
	reload:function(){
	    var type=App.document_list.currentType;
	    App.document_list.docTypeConfig[type].entries=[];
	    App.document_list.load(type);
	},
	loadMore:function(){
	    var type=App.document_list.currentType;
	    App.document_list.load(type);
	},
	loadIfEmpty:function(type){
	    if( !App.document_list.docTypeConfig[type].entries.length ){
		App.document_list.load(type,0);
	    }
	},
	compSearch:function( q ){
	    clearTimeout(App.document_list.clock);
	    App.document_list.clock=setTimeout(function(){
		App.document_list.compFilter=q;
		App.document_list.reload();
	    },800);
	}
    };
    App.document_list.init();
</script>
<style>
    #documents_sell tr,#documents_buy tr{
	cursor: pointer;
    }
</style>