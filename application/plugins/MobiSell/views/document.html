<script>
    App.document = {
	doc: {},
	init: function () {
	    App.document.initTab();
	    App.document.head.init();
	    App.document.load(App.state.doc_id);
	    App.document.suggestion.init();
	},
	load: function (doc_id) {
	    $.post("documentGet/", {doc_id: doc_id}, function (resp) {
		App.document.set(App.json(resp));
	    });
	},
	set: function (doc) {
	    App.document.doc = doc;
	    App.document.render();
	},
	render: function () {
	    App.document.row.parseStatus();
	    App.renderTpl('document_entries', App.document.doc);
	    App.document.head.set(App.document.doc.head);
	},
	initTab: function () {
	    $('.menu .item').tab({
		onVisible: function (type) {

		}
	    });
	    $('.menu .item').tab('change tab', 'entries');
	},
	head: {
	    init: function () {
		$('.activecomp').dropdown({
		    apiSettings: {
			url: 'compListFetch/?mode=active_only'
		    },
		    fields: {
			value: 'company_id',
			name: 'label',
			text: 'label'
		    },
		    filterRemoteData: true,
		    fullTextSearch: true
		});
		$('.passivecomp').dropdown({
		    apiSettings: {
			url: 'compListFetch/'
		    },
		    fields: {
			value: 'company_id',
			name: 'label',
			text: 'label'
		    },
		    filterRemoteData: true,
		    fullTextSearch: true
		});
		var $input = $('.docdatepicker').pickadate();
		App.document.picker = $input.pickadate('picker');
		App.document.picker.on({
		    set: function (val) {
			var date = App.document.picker.get('select', 'yyyy-mm-dd');
			App.document.head.update('doc_date', date);
		    }
		});
	    },
	    set: function (head) {
		$('.activecomp').dropdown('set value', head.acomp_id);
		$('.activecomp').dropdown('set text', head.acomp_label);
		$('.passivecomp').dropdown('set value', head.passive_company_id);
		$('.passivecomp').dropdown('set text', head.label);
		$('.doc_num').val(head.doc_num);
		App.document.picker.set('select', new Date(App.toIso(head.doc_date)));


		//App.document.suggestion.search('24111');
	    },
	    update: function (field, value) {
		App.document.doc.head[field] = value;
	    }
	},
	row: {
	    add: function (suggest_entry) {
		suggest_entry.product_quantity = suggest_entry.product_spack;
		App.document.row.edit(suggest_entry, null);
	    },
	    edit: function (entry, index) {
		App.renderTpl('document_entry_dialog', entry);
		$('#document_entry_dialog').modal({
		    onDeny: function () {
			App.document.row.remove(index);
		    },
		    onApprove: function () {
			entry.product_quantity = $("#document_entry_dialog input").val();
			App.document.row.save(entry, index);
		    },
		    onVisible: function () {
			$("#document_entry_dialog input").select();
		    }
		}).modal('show');
		$("#document_entry_dialog input").val(entry.product_quantity);
	    },
	    save: function (entry, index) {
		if (index === null) {//new entry
		    var merged = App.document.row.merge_if_code_exists(entry);
		    entry = merged.entry;
		    index = merged.index;
		}
		App.document.row.save_on_server(entry);
		entry.product_sum_total = (entry.product_quantity * entry.product_price_total).toFixed(2);
		App.document.doc.entries[index] = entry;
		App.document.row.sort();
		App.document.render();
	    },
	    save_on_server: function (entry) {
		var params = {
		    doc_id: App.document.doc.head.doc_id,
		    doc_entry_id: entry.doc_entry_id,
		    product_code: entry.product_code,
		    product_quantity: entry.product_quantity
		};
		$.post('documentEntryUpdate/', params, function (resp) {
		    App.document.set(App.json(resp));
		});
	    },
	    merge_if_code_exists: function (entry_to_merge) {
		for (var index in App.document.doc.entries) {
		    var entry = App.document.doc.entries[index];
		    if (entry.product_code === entry_to_merge.product_code) {
			entry.product_quantity = entry.product_quantity * 1 + entry_to_merge.product_quantity * 1;
			return {entry: entry, index: index};
		    }
		}
		App.document.doc.entries.push(entry_to_merge);
		var index = App.document.doc.entries.length - 1;
		return {entry: entry_to_merge, index: index};
	    },
	    remove: function (index) {
		var removed = App.document.doc.entries.splice(index, 1);
		if (removed && removed[0].doc_entry_id) {
		    App.document.row.remove_on_server(removed[0].doc_entry_id);
		}
		App.document.render();
	    },
	    remove_on_server: function (doc_entry_id) {
		var params = {
		    doc_id: App.document.doc.head.doc_id,
		    doc_entry_id: doc_entry_id
		};
		$.post('documentEntryRemove/', params, function (resp) {
		    App.document.set(App.json(resp));
		});
	    },
	    sort: function () {
		function compare(a, b) {
		    if (a.product_code < b.product_code)
			return -1;
		    if (a.product_code > b.product_code)
			return 1;
		    return 0;
		}
		App.document.doc.entries.sort(compare);
	    },
	    handleClick: function (row_node) {
		var index = $(row_node).data('row-index');
		var entry = App.document.doc.entries[index];
		App.document.row.edit(entry, index);
	    },
	    parseStatus: function () {
		for (var i in App.document.doc.entries) {
		    if (App.document.doc.entries[i].row_status) {
			var status_chunks = App.document.doc.entries[i].row_status.split(" ");
			var status = status_chunks.shift();
			var message = status_chunks.join(" ");
			if (status == 'ok' || status == 'info') {
			    App.document.doc.entries[i].status_icon = "check";
			    App.document.doc.entries[i].status_color = "green";
			    App.document.doc.entries[i].status_message = "";
			}
			if (status == 'wrn') {
			    App.document.doc.entries[i].status_icon = "warning sign";
			    App.document.doc.entries[i].status_color = "orange";
			    App.document.doc.entries[i].status_message = message;
			}
			if (status == 'err') {
			    App.document.doc.entries[i].status_icon = "warning circle";
			    App.document.doc.entries[i].status_color = "red";
			    App.document.doc.entries[i].status_message = message;
			}
		    }
		}
	    }
	},
	save: function () {

	},
	suggestion: {
	    q: '',
	    entries: [],
	    init: function () {
		App.renderTpl('doc_suggestion_entries', {entries: []});
		$("#doc_suggestion").accordion({
		    onOpen: function () {
			App.document.suggestion.search("");
		    }
		});
		$("#doc_suggestion input").on('keyup', function () {
		    App.document.suggestion.search($("#doc_suggestion input").val());
		});
	    },
	    search: function (q) {
		clearTimeout(this.clock);
		this.clock = setTimeout(function () {
		    App.document.suggestion.q = q;
		    App.document.suggestion.entries = [];
		    App.document.suggestion.load();
		}, 200);
	    },
	    load: function () {
		
		
		var offset = App.document.suggestion.entries.length || 0;
		$.post('documentSuggest', {offset: offset, q: App.document.suggestion.q, doc_id: App.document.doc.head.doc_id}, function (resp) {
		    var suggestion = App.json(resp);
		    App.document.suggestion.entries = App.document.suggestion.entries.concat(suggestion);
		    App.document.suggestion.render();
		    if (suggestion && suggestion.length > 0) {
			$("#load_suggestions_button").show();
		    } else {
			$("#load_suggestions_button").hide();
		    }
		});
	    },
	    render: function () {
		App.renderTpl('doc_suggestion_entries', {entries: App.document.suggestion.entries});
	    },
	    handleClick: function (row_node) {
		var index = $(row_node).data('row-index');
		var suggest_entry = App.document.suggestion.entries[index];
		App.document.row.add(suggest_entry);
	    },
	    popImage: function (row_node) {
		var index = $(row_node).data('row-index');
		var suggest_entry = App.document.suggestion.entries[index];

		suggest_entry.size_x = $(document).width();
		suggest_entry.size_y = $(document).height();


		App.renderTpl('document_product_image', suggest_entry);
		$("#document_product_image").modal('show');
	    }
	}
    };
    $(App.document.init);
</script>

<style>
    #document_entries .four.wide.column{
	text-align: right;
    }
</style>
<div class="ui form">
    <div class="five fields">
	<div class="field">
	    <label>Наша фирма</label>
	    <div class="ui search selection remote dropdown activecomp">
		<input name="activecomp" type="hidden">
		<i class="dropdown icon"></i>
		<div class="default text"></div>
		<div class="menu"></div>
	    </div>
	</div>
	<div class="field">
	    <label>Клиент</label>
	    <div class="ui search selection remote dropdown passivecomp">
		<input name="passivecomp" type="hidden">
		<i class="dropdown icon"></i>
		<div class="default text"></div>
		<div class="menu"></div>
	    </div>
	</div>
	<div class="field">
	    <label>Номер</label>
	    <input placeholder="Номер" type="text" readonly="" class="doc_num">
	</div>
	<div class="field">
	    <label>Дата</label>
	    <input name="company_filter" placeholder="Дата" type="date" class="docdatepicker">
	</div>
	<div class="field">
	    <label>Проведен</label>
	    <div class="ui slider checkbox">
	      <input name="is_commited" type="checkbox">
	      <label></label>
	    </div>
	</div>
    </div>
    <div>
	<div class="field">
	<label>Комментарий</label>
	<textarea rows="2" name="doc_data"></textarea>
      </div>
    </div>
</div>


<div class="ui top attached tabular menu">
    <a class="active item" data-tab="entries">Накладная</a>
    <a class="item" data-tab="prefs">Настройки</a>
</div>
<div class="ui bottom attached  tab segment" data-tab="entries" id="document_entries">
    <table class="ui green selectable  table  stackable">
	<thead>
	    <tr>
		<th>
		    <div class="ui grid">
			<div class="two wide column">№</div>
			<div class="fourteen wide column">Название</div>
		    </div>
		</th>
		<th>
		    <div class="ui grid">
			<div class="four wide column">Код</div>
			<div class="four wide column">Кол-во</div>
			<div class="four wide column">Цена</div>
			<div class="four wide column">Сумма</div>
		    </div>
		</th>
	    </tr>
	</thead>
	<tbody>
	    <!-- {{if entries}} {{entries}} -->
	    <tr data-row-index="{{#}}" onclick="App.document.row.handleClick(this)">
		<td><span style="color:{{status_color}}"><i class="icon {{status_icon}} {{status_color}}"></i> {{status_message}}</span> {{##}}) {{product_name}}
		</td>
		<td>
		    <div class="ui grid">
			<div class="four wide column">{{product_code}}</div>
			<div class="four wide column">{{product_quantity}}{{product_unit}}</div>
			<div class="four wide column">{{product_price_total}}</div>
			<div class="four wide column">{{product_sum_total}}</div>
		    </div>
		</td>
	    </tr>
	    <!-- {{/entries}} {{else}}-->
	    <tr>
		<td colspan="4">Ничего не найдено</td>
	    </tr>
	    <!--{{/if}}-->
	</tbody>
	<tfoot class="full-width">
	    <tr>
		<td>
		    <div class="ui grid">
			<div class="eight wide column">{{footer.total_weight}}кг </div>
			<div class="eight wide column">{{footer.total_volume}}м<sup>3</sup></div>
		    </div>
		</td>
		<td style="text-align: right;">{{footer.total}}{{footer.curr_symbol}}</td>
	    </tr>
	</tfoot>
    </table>
</div>
<div class="ui bottom attached tab segment" data-tab="prefs" id="">
    <div class="ui buttons">
	<button class="ui primary button">Провести</button>
	<button class="ui button">Удалить</button>
	<button class="ui negative button">Удалить</button>
    </div>
</div>

<div class="ui inverted segment">
    <div class="ui inverted fluid accordion" id="doc_suggestion"> 
	<div class="title"><i class="add icon"></i>Добавить товар</div>
	<div class="content ">
	    <div class="ui icon input fluid">
		<input placeholder="Поиск по коду или названию" type="text">
		<i class="circular search link icon"></i>
	    </div>
	    <div id="doc_suggestion_entries">
		<table class="ui very compact table unstackable">
		    <tbody>
			<!-- {{if entries|size}} {{entries}} -->
			<tr>
			    <td data-row-index="{{#}}" onclick="App.document.suggestion.popImage(this)">
				<img style="width:50px" src="../Storage/image_flush/?size=50x50&path=/dynImg/{{product_img}}">
			    </td>
			    <td data-row-index="{{#}}" onclick="App.document.suggestion.handleClick(this)">
				<div class="ui grid stackable" style="{{if leftover|less>1}} color:red !important {{/if}}">
				    <div class="eight wide column" style="padding: .5rem !important">{{product_name}}</div>
				    <div class="eight wide column" style="padding: .5rem !important">
					<div class="ui grid" style="opacity:0.7">
					    <div class="six wide column">{{product_code}}</div>
					    <div class="five wide column right aligned">{{product_price_total}}р</div>
					    <div class="five wide column right aligned">{{leftover}}{{product_unit}}</div>
					</div>
				    </div>
				</div>
			    </td>
			</tr>
			<!-- {{/entries}} {{else}}-->
			<tr>
			    <td colspan="2">Ничего не найдено</td>
			</tr>
			<!--{{/if}}-->
		    </tbody>
		</table>
		<button class="ui button fluid" id="load_suggestions_button" onclick="App.document.suggestion.load();">Показать еще</button>
	    </div>
	</div>
    </div>
</div>
<div class="ui modal" id="document_entry_dialog">
    <div class="header">Редактирование строки</div>
    <div class="content">
	<div class="ui stackable grid">
	    <div class="eight wide column"><span style="opacity:.7">{{product_code}}</span> {{product_name}}</div>
	    <div class="eight wide column">
		<div class="ui right labeled fluid input">
		    <input placeholder="Колличество" type="number">
		    <div class="ui basic label">{{product_unit}}</div>
		</div>
	    </div>
	</div>
    </div>
    <div class="actions">
	<div class="ui stackable grid">
	    <div class="six wide column"><div class="ui positive approve fluid button"><i class="icon save"></i> Ок</div></div>
	    <div class="six wide column"><div class="ui secondary close fluid button" onclick="$('#document_entry_dialog').modal('hide');"><i class="icon close"></i> Закрыть</div></div>
	    <div class="four wide column"><div class="ui negative deny fluid button"><i class="icon remove circle"></i> Удалить</div></div>
	</div>
    </div>
</div>

<div class="ui fullscreen modal" id="document_product_image">
    <div class="header">{{product_code}}</div>
    <div class="image content" style="height: {{size_x}}px;">
	<img class="image"  src="../Storage/image_flush/?size={{size_x}}x{{size_y}}&path=/dynImg/{{product_img}}" style="height:auto;width:100%">
    </div>
    <div class="description">
	{{product_name}}
    </div>
    <div class="actions">
	<div class="ui secondary close button"  onclick="$('#document_product_image').modal('hide');"><i class="icon close"></i> Закрыть</div>
    </div>

</div>