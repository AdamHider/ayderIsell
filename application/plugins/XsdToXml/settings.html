
<form>
    <div class="plugin_settings">
        <table>
            <tr>
                <td style="vertical-align: top;width:350px">
                    <div class="easyui-panel" title="Основные настройки">
                        <input name="publicUrl" title="Публичный адрес" value="" required="required" style="width:180px" onchange="App.xsd_to_xml.updateSettings();"/>
                        <input type="hidden" name="pcomp_id">
                        <div class="inp_group">
                            <input title="Использовать цены клиента" name="pcomp_name" value="" readonly="readonly" required="required" style="width:100px"/>
                            <button type="button" class="tiny_button" onclick="App.xsd_to_xml.select_pcomp()"><img src="img/settings.png"> Выбрать</button>
                        </div>
                    </div>
                </td>
                <td style="vertical-align: top">
                    <div id="csv_Exporter_categories_panel" style="min-width:200px;" class=" easyui-panel" title="Категории для экспорта">
                        {{if categories}}
                        {{categories}}
                        <div style="clear: both;padding-top: 2px;display: flex;padding: 7px;">
                            <div>
                                <img src="img/delete.png" 
                                     style="width:16px;height: auto" 
                                     title="Удалить атрибут" 
                                     onclick="App.xsd_to_xml.categories.remove(this)"
                                     data-name="{{category_path}}"
                                     data-id="{{branch_id}}">
                                {{category_path}} 
                            </div>
                        </div>
                        {{/categories}}
                        {{else}}
                        <div style="padding: 5px;">Добавьте категорию</div>
                        {{/if}}
                        <div style="text-align: center">
                            <button class="tiny_button" type="button" title="Добавить категорию" onclick="App.xsd_to_xml.categories.add()"><img src="img/add.png"> Добавить</button>
                        </div>
                    </div>
                </td>
                <td style="vertical-align: top">
                    <div id="filter_panel" class=" easyui-panel" style="height:200px;min-width:200px" title="Фильтры"> 
                        {{product_filters}}
                        <div style="clear: both;padding-top: 2px;display: flex;padding: 7px;">
                            <div style="width:110px;">
                                <img src="img/delete.png" 
                                     style="width:16px;height: auto" 
                                     title="Удалить атрибут" 
                                     onclick="App.xsd_to_xml.filters.remove(this)"
                                     data-name="{{attribute_name}}"
                                     data-id="{{attribute_id}}"> {{attribute_name}} 
                            </div>
                        </div>
                        {{/product_filters}}
                    </div>
                    <div style="clear: both;padding-top: 2px;display: flex;padding: 7px;">        
                        <select id="filter_select" name="filter_select"  style="width:110px">
                            <option value="unset">-Не выбрано-</option>
                            {{filter_list}}
                            <option value="{{attribute_id}}">{{attribute_name}}</option>
                            {{/filter_list}}
                        </select>
                        <div id="filter_unit" style="width:30px;margin-left: 10px"></div>
                   </div>
                   <button class="tiny_button" type="button" title="Добавить фильтр" onclick="App.xsd_to_xml.filters.add()"><img src="img/add.png"> Добавить</button>
                </td>
            </tr>
        </table>
    </div>
    <div class="plugin_notinstalled">
        <h1>Плагин не установлен</h1>
    </div>
    <div style="text-align: center">
        <label>Формат файла:</label>
        <select style="width:80px; height:28px" onchange="App.xsd_to_xml.changeMode(this.value)">
            <option>csv</option>
            <option>yml</option>
        </select>
        <button type="button" onclick="App.xsd_to_xml.addAutoBackupTask()"><img src="img/event.png" style="width:24px;"> Добавить автовыполнение</button>
        <button type="button" onclick="App.xsd_to_xml.export()"><img src="img/export.png" style="width:24px;"> Экспорт</button>
    </div>
</form>

<style>
    #csv_Exporter_filters label b{
        width: 100px !important;
    }
</style>
<script>
    App.xsd_to_xml = {
        mode:'',
        init: function () {
            if( Plugins.currentData.is_activated==1 ){
                if( Plugins.currentData.plugin_settings.active_mode ){
                    App.xsd_to_xml.data = Plugins.currentData.plugin_settings;
                } else {
                    App.xsd_to_xml.data={
                        csv:{
                            filters: [],
                            categories: [],
                            publicUrl: '',
                            pcomp_id:0,
                            pcomp_name:''
                        },
                        yml:{
                            filters: [],
                            categories: [],
                            publicUrl: '',
                            pcomp_id:0,
                            pcomp_name:''
                        },
                        active_mode: 'csv'
                    };
                }
                App.xsd_to_xml.mode = App.xsd_to_xml.data.active_mode;
                    $("input[name=pcomp_id]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_id);
                    $("input[name=pcomp_name]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_name);
                    $("input[name=publicUrl]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].publicUrl);
                $(".plugin_settings").show();
                $(".plugin_notinstalled").hide();
                App.xsd_to_xml.categories.init();
                App.xsd_to_xml.filters.load();
            } else {
                $(".plugin_settings").hide();
                $(".plugin_notinstalled").show();
            }
        },
        render:function(){
        },
        updateSettings: function () {
            App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_id=$("input[name=pcomp_id]").val();
            App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_name=$("input[name=pcomp_name]").val();
            App.xsd_to_xml.data[App.xsd_to_xml.mode].publicUrl=$("input[name=publicUrl]").val();
            App.xsd_to_xml.data.active_mode = App.xsd_to_xml.mode;
            $.post('CSVExporter/updateSettings', {settings: JSON.stringify(App.xsd_to_xml.data)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.xsd_to_xml.data = response;
                    $("input[name=pcomp_id]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_id);
                    $("input[name=pcomp_name]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_name);
                    $("input[name=publicUrl]").val(App.xsd_to_xml.data[App.xsd_to_xml.mode].publicUrl);
                    App.xsd_to_xml.categories.init();
                    App.xsd_to_xml.filters.load();
                }
            });
        },
        changeMode: function(mode){
            App.xsd_to_xml.updateSettings();
            App.xsd_to_xml.mode = mode;
        },
        export: function () {
            if (!App.xsd_to_xml.data[App.xsd_to_xml.mode].pcomp_id && App.xsd_to_xml.mode !== 'yml') {
                App.flash("Выберите клиента, цены которого будут использованы!");
                return;
            }
            $.post('CSVExporter/export_'+App.xsd_to_xml.mode, function (ok) {
                if (ok) {
                    App.flash(ok+" Товаров было экспортировано в файл в публичной папке!<br>"+App.xsd_to_xml.data[App.xsd_to_xml.mode].publicUrl+'/public');
                } else {
                    App.flash("Возникла ошибка при экспорте!");
                }
            });
        },
        
        select_pcomp: function () {
            App.user.pcompSelectionDialog().progress(function(status,pcomp){
                if (status === 'select' || status === 'reset') {
                    $("input[name=pcomp_name]").val(pcomp.label);
                    $("input[name=pcomp_id]").val(pcomp.company_id);
                    App.xsd_to_xml.updateSettings();
                }
            });
        },
	addAutoBackupTask:function(){
	    var comment="Создание экспортного файла синхронизации";
	    var program={
		commands:[
		    {model:'CSVExporter',method:'export_'+App.xsd_to_xml.mode,arguments:''}
		]
	    };
	    var task={
		event_program:JSON.stringify(program),
		event_name:"Синхронизация с сайтом",
		event_descr:comment,
		event_label:"-TASK-",
		event_repeat:"0 3:0"
	    };
	    App.loadWindow('page/events/event', task);
	}
    };
    $(App.xsd_to_xml.init);
</script>
