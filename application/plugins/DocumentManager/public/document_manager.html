<script>
    App.document_manager=(function($){
        function init(){
	    doclist.open();
            table.init();
	    result_table.init();
        }
        
	var result_table={
	    init:function(){
		var settings={
                    columns:[
                        {id:"product_code", field: "product_code", name: "Код", width: 95 },
                        {id:"product_name", field: "product_name", name: "Название", width: 95 },
                        {id:"product_quantity", field: "product_quantity", name: "Кол-во", width: 95 },
                        {id:"product_price", field: "product_price", name: "Ср Цена", width: 95 }
                    ],
                    options:{
			editable: true,
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter:true,
                        multiSelect :false,
                        url:'DocumentManager/result/'
                    }
                };
                result_table.grid = new SlickInfinite("#document_manager_result_sg", settings);
		result_table.grid.updateOptions({params:{config:JSON.stringify(doclist.data)}});
	    }
	    
	};
        
        var doclist={
	    data:{},
	    open:function(){
		var json=localStorage.getItem('docmanager_doclist');
		this.data=App.json(json)||{};
	    },
	    save:function(){
		localStorage.setItem('docmanager_doclist',JSON.stringify(this.data));
	    }
	};
        var table={
            frm:{
		actionEditor:function (args) {
		    var $input;
		    var defaultValue;
		    this.keyCaptureList = [Slick.keyCode.UP, Slick.keyCode.DOWN, Slick.keyCode.ENTER];
		    this.init = function () {
			var html = "<select style='width:100%' data-docid='"+args.item.doc_id+"'>";
			for(var action in table.actionDictionary){
			    var actionName=table.actionDictionary[action];
			    html += "<option value='"+action+"'>"+actionName+"</option>";
			}
			html += "</select>";
			$input = $(html);
			$input.appendTo(args.container);
			$input.val(args.item.action);
			$input.focus();
		    };
		    this.destroy = function () {
			$input.remove();
		    };
		    this.focus = function () {
			$input.focus();
		    };
		    this.loadValue = function (item) {
			var initialAction=doclist.data[args.item.doc_id];
			$input.val(initialAction);
		    };
		    this.serializeValue = function () {
			return $input.val();
		    };
		    this.applyValue = function (item, state) {
			item[args.column.field] = state;
		    };
		    this.isValueChanged = function () {
			return (!($input.val() == "" && defaultValue == null)) && ($input.val() != defaultValue);
		    };
		    this.validate = function () {
			return {
			    valid: true,
			    msg: null
			};
		    };
		    this.init();
		},
                queue:function(row, cell, value, columnDef, dataContext){
                    return row+1;
                },
                dateFormatter:function(row, cell, value, columnDef, dataContext){
                    var date_parts=value.split(' ')[0].split('-');
                    var date=date_parts[2]+'.'+date_parts[1]+'.'+date_parts[0];
                    return '<span title="'+value.split(' ')[1]+'">'+date+'</span>';
                },
                tooltip:function(row, cell, value, columnDef, dataContext){
                    if( !value ){
                        return '';
                    }
                    var parts = value.split(' ');
                    var cmd = parts.shift();
                    if (cmd){
                        var style='max-width:16px;height:auto';
                        return '<img src="img/' + cmd + '.png" style="'+style+'" title="' + parts.join(' ') + '">';
                    }
                    else{
                        return '';
                    }	    
                },
		action:function(row,cell,value, columnDef, dataContext){
		    var action='skip';
		    if(dataContext.doc_id&&doclist.data[dataContext.doc_id]){
			action=doclist.data[dataContext.doc_id];
		    }
		    return table.actionDictionary[action];
		}
            },
	    actionDictionary:{
		skip:'✖ Игнор',
		add:'➕ Прибавить',
		extract:'➖ Вычесть'
	    },
	    tools:{
		reload: function () {
		    table.grid.reload();
		},
		entryDelete: function () {
		    var selected_rows = table.grid.getSelectedRows();
		    if (!selected_rows.length) {
			App.flash("Ни одна строка не выбрана!");
			return;
		    }
		    if (!confirm("Удалить выделенные накладные?")) {
			return;
		    }
		    for (var i in selected_rows) {
			var doc_id=table.grid.getDataItem(selected_rows[i]).doc_id;
			delete doclist.data[doc_id];
			doclist.save();
			table.reload();
		    }
		},
		entryCreate: function () {
		    App.loadWindow("page/dialog/document_selector").progress(function(status,doc_id){
			if(status==='selected'){
			    doclist.data[doc_id]='skip';
			    doclist.save();
			    table.reload();
			}
		    });
		}
	    },
            init:function(){
                var settings={
                    columns:[
                        {id:"action", name: "Действия", width: 95, editor: table.frm.actionEditor,formatter:table.frm.action },
                        {id:"cstamp", field: "cstamp",name: "Дата",  width: 75, sortable: true,formatter:table.frm.dateFormatter },
                        {id:"doc_num", field: "doc_num",name: "Номер", width: 50, sortable: true,cssClass:'slick-align-right' },
                        {id:"pcomp_label", field: "pcomp_label",name: "Контрагент", width: 120 },
                        {id:"doc_type_icon", field: "doc_type_icon",name: "", width: 25,formatter:table.frm.tooltip},
                        {id:"acomp_label", field: "acomp_label",name: "Наша фирма", width: 120 },
                        {id:"doc_total", field: "doc_total",name: "Сумма", width: 70, sortable: true }
                    ],
                    options:{
			editable: true,
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter:true,
                        multiSelect :true,
                        url:'DocumentList/listFetch/'
                    }
                };
		
                table.grid = new SlickInfinite("#document_manager_sg", settings);
		table.setupActionEvent();
		table.grid.setFilter({doc_id:Object.keys(doclist.data).join("|")});
		$(".x-document-manager").click(function (e) {
		    var action = $(e.target).data('action');
		    if (action) {
			table.tools[action] && table.tools[action]();
		    }
		});
            },
	    reload:function(){
		table.grid.setFilter({doc_id:Object.keys(doclist.data).join("|")});
	    },
	    setupActionEvent:function(){
		$("#document_manager_sg").change(function(e){
		    var doc_id=$(e.target).data('docid');
		    var value=$(e.target).val();
		    if( doc_id && value ){
			doclist.data[doc_id]=value;
		    }
		    console.log(value,doc_id);
		});
	    }
        };
        App.require(["js/slick/lib/jquery.event.drag-2.3.0.js"],function(){
            App.require([
                "js/slick/slick.core.js",
                "js/slick/plugins/slick.rowselectionmodel.js",
                "js/slick/slick.editors.js",
                "js/slick/slickinfinite.js",
                "js/slick/slick.grid.js"
            ], init);
        });
	return {
	    
	};
    })(jQuery);
</script>
<table>
    <tr>
        <td class="transp60" style="">
            <div>
            	<div style="margin-right: 20px">
                    <div style="float: left;font-weight: bold;padding-top: 8px;">
                        <img src="img/table16.png" style="width:16px;height: 16px;"> Накладные
                    </div>
                    <div style="float: right;margin-right: 20px" class="x-document-manager">
                        <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
                        <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
                        <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
                    </div>
                </div>
                <div id="document_manager_sg" style="clear: both;height: 400px;width:365px"></div>
            </div>
        </td>
        <td style="vertical-align: top">
            <div id="document_manager_result_sg"></div>
	    <button>calculate</button>
        </td>
    </tr>
</table>