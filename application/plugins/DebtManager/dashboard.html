<div class="widget-panel">
    <div class="widget-header">
        <div class='widget-icon'>
            <img src="img/debtmanager.png" width="32" height="32">
        </div>
        <div class="widget-title" style="font-size:16px">Календарь платежей</div>
        <div class="widget-reload" onclick="App.debt_manager_settings.reload()">
            <img src="img/widget-reload.png" width="25" height="25">
        </div>
        <div class="widget-settings" onclick="$('.plugin_settings').slideToggle('fast')">
            <img src="img/widget-settings.png" width="25" height="25">
        </div>
    </div>
    <div class="plugin_settings panel-body" style='display: none'>
        <div class="debt-settings-input">
            <label>
                <div class="explain" style="display:none; position:absolute">Выберите здесь способ группировки задолженностей.</div>
                Группировать дату по:
            </label>
            <select name="group_by_date" onchange="App.debt_manager_settings.updateSettings()">
                <option value="DAY">дням</option>
                <option value="WEEK">неделям</option>
                <option value="MONTH">месяцам</option>
                <option value="QUARTER">кварталам</option>
                <option value="YEAR">годам</option>
            </select>
        </div>
        <div class="debt-settings-input">
            <label>
                <div class="explain" style="display:none; position:absolute">Если хотите сократить длину списка и сгруппировать долги по клиентам, выберите "Да".</div>
                Группировать по клиентам:
            </label>
            <select name="group_by_pcomp"  onchange="App.debt_manager_settings.updateSettings()">
                <option value="1">Да</option>
                <option value="0">Нет</option>
            </select>
        </div>
        <div class="debt-settings-input">
            <label>
                <div class="explain" style="display:none; position:absolute">Вы можете выбрать нужного контрагента и увидеть в списке только его задолженности.</div>
                Показывать долги клиента: 
            </label>
            <div class="inp_group">
                <input title="" name="pcomp_name" value="" readonly="readonly" required="required" style="width:100px" placeholder="Все"/>
                <input name="pcomp_id" value="" type="hidden" required="required" style="width:100px"/>
                <button type="button" class="tiny_button" onclick="App.debt_manager_settings.select_pcomp()"><img src="img/settings.png"> Выбрать</button>
            </div>
        </div>
        <div>
            <div class="debt-settings-checkbox">
                <label for="buy_trans">
                    <div class="explain" style="display:none; position:absolute">Показывать наши долги перед поставщиками.</div>
                    Наши долги
                </label>
                <input type="checkbox" class="checkbox" name="buy_trans" onchange="App.debt_manager_settings.updateSettings()"
                       checked>
            </div>
            <div class="debt-settings-checkbox">
                <label for="sell_trans">
                    <div class="explain" style="display:none; position:absolute">Показывать долги клиентов нашей фирме.</div>
                    Долги клиентов
                </label>
                <input type="checkbox" class="checkbox"  name="sell_trans" onchange="App.debt_manager_settings.updateSettings()"
                       checked>
            </div>
            <div class="debt-settings-checkbox">
                <label for="notificate">
                    <div class="explain" style="display:none; position:absolute">Отправлять уведомления о ближайших задолженностях в чат.</div>
                    Включить уведомления
                </label>
                <input type="checkbox" class="checkbox"  name="notificate" onchange="App.debt_manager_settings.updateSettings()"
                        checked>
            </div>
        </div>
    </div>
     <div class='expired-title'>Просроченные платежи</div>
</div>     

<div class="debt-container">
    <div id="debtList"></div> 
    <div class="load-more">Загрузка...</div>   
</div>        
<div style="display:none">
    <div id="block_template">
        <div class="debt-block{{if date}}{{else}} expired{{/if}} {{if block|notempty}} normal{{else}} empty{{/if}} ester-scroll-viewed">
            {{if date}}
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{if date.month|more>0 }}
                        {{date.month|month|blank>}}
                    {{else}}
                    {{/if}}
                    
                    {{if date.quarter|falsy }}
                    {{else}}
                    {{date.quarter}} Квартал
                    {{/if}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            {{else}}
            <div></div>
            {{/if}}
            <div class="debt-all-rows">
                
                {{if block|notempty}}
                    {{block}}
                    <div class="debt-row {{ trans_type }}">
                        <div class="debt-date" >{{pay_date|pay_date|blank>}}</div>
                        <div class="debt-company-name" >
                            <div>{{company_label}}</div>
                            <div class="debt-company-info" style="display:none ">
                                <div>{{company_name}}</div>
                                <div>{{company_person}}</div>
                                <div>{{company_mobile}}</div>
                                <div>{{company_email}}</div>
                                <div>{{company_address}}</div>
                                <div class="debt-description" >
                                    <div><b>Документы: </b></div>
                                    <div>{{description}}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="debt-amount sell">{{amount_sell}} </div>
                        <div class="debt-amount buy">{{amount_buy}} </div>
                    </div>
                    {{/block}}
                    
                    <div class="total-row">
                        {{if total}}
                        <div class="total-label">Итого:</div>
                                <div class="sell-total" >
                                    {{total.sell}}
                                </div>
                                <div class="buy-total">
                                    {{total.buy}}
                                </div>
                        {{/if}} 
                    </div>
                {{/if}}    
            </div>
        </div>
    </div>
    <div id="empty_block_template">
        <div class="debt-block">
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{date.month}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            <div class="debt-all-rows" >
                <div>empty</div>
            </div> 
        </div>    
    </div>
</div> 
<div id="empty_container" style="display:none">
    <div></div>
</div>
<style>
    div{
        
    }
    #DebtManager_dashboard_holder .plugin_settings{
        background-color: rgba(255,255,255,1);
        padding:10px;
        position: relative;
        overflow: initial;
    }
    #DebtManager_dashboard_holder{
        box-shadow: 2px 2px 13px gray;
    }
    #DebtManager_dashboard_holder .widget-panel{
        position: relative;
        box-shadow: rgb(147, 0, 0) 0px 2px 12px;
        z-index: 1;
    }
    #DebtManager_dashboard_holder .widget-header{
        background-color: #1a36b8;
        display: grid;
        grid-template-columns: 14% 72% 6% 6%;
        height: 60px;
        align-items: center;
        text-align: center;
        color: white;
    }
    #DebtManager_dashboard_holder .widget-title{
        font-size: 16px;
        border-bottom: 1px solid #76b9f0;
        font-weight: bold;
        display: inline-block;
        width: max-content;
    }
    #DebtManager_dashboard_holder .widget-settings, 
    #DebtManager_dashboard_holder .widget-icon,
    #DebtManager_dashboard_holder .widget-reload{
        filter: brightness(0) invert(1);
    }
    #DebtManager_dashboard_holder .widget-settings:hover{
        transition: all 0.5s ease;
        transform: rotateZ(-180deg);  
        filter: brightness(0%) invert(100%) drop-shadow(2px 2px 5px #1ba2ff);
    }
    #DebtManager_dashboard_holder .widget-settings:active{
        transition: all 0.5s ease;
        transform: scale(0.85);  
        filter: brightness(0%) invert(100%) drop-shadow(2px 2px 5px black);
    }
    #DebtManager_dashboard_holder .widget-reload:hover {
        transition: all 0.5s ease;
        transform: rotateZ(-360deg);  
        filter: brightness(0%) invert(100%) drop-shadow(2px 2px 5px #1ba2ff);
    }
    #DebtManager_dashboard_holder .widget-reload:active{
        transition: all 0.5s ease;
        transform: rotateZ(-720deg) scale(0.85);  
        filter: brightness(0%) invert(100%) drop-shadow(2px 2px 5px black);
    }
    #DebtManager_dashboard_holder .debt-settings-input label, 
    #DebtManager_dashboard_holder .debt-settings-checbox label{
        cursor: help;
    }
    #DebtManager_dashboard_holder .debt-settings-input label:hover .explain, 
    #DebtManager_dashboard_holder .debt-settings-checkbox label:hover .explain{
        display: block !important;
    }
    #DebtManager_dashboard_holder .debt-container{
        overflow-y: scroll;
        max-height: 78vh;
        scrollbar-color: #1a36b8 #ffffff63;
        scrollbar-width: thin;
        background-color: white;
        position: relative;
    }
    #DebtManager_dashboard_holder .explain:hover{
        display: none !important;
    }
    #DebtManager_dashboard_holder .explain{
        position: absolute;
        width: 40%;
        border: 1px solid lightgray;
        background-color: #fffcdf;
        margin-top: 17px;
        padding: 5px;
        padding-left: 5px;
        margin-left: 35px;
        white-space: initial;
        z-index: 100;
    }
    #DebtManager_dashboard_holder .debt-settings-input, .debt-settings-checkbox {
        padding: 3px;
    }
    #DebtManager_dashboard_holder .debt-settings-input select{
        height:24px;
    }
    #DebtManager_dashboard_holder .debt-settings-checkbox input{
        height:20px;
        width:20px;
    }
    #DebtManager_dashboard_holder .debt-settings-input{
        display: grid;
        grid-template-columns: 33% 50%;
    }
    #DebtManager_dashboard_holder .debt-settings-checkbox{
        display: grid;
        grid-template-columns: 33% 50%;
    }
    #DebtManager_dashboard_holder .debt-block{
        display: grid;
        grid-template-columns: 18% 82%;
        grid-column-gap: inherit;
        border: 1px solid #bdbdbdb3;
    }
    #DebtManager_dashboard_holder .debt-block.expired{
        grid-template-columns: 100%;
    }
    #DebtManager_dashboard_holder .expired-title{
        display: block;
        position: absolute;
        background: white;
        padding: 8px;
        border: 1px solid #aeaeae;
        z-index: 6;
        margin-top: 10px;
        border-radius: 10px;
        box-shadow: 2px 2px 6px gray;
        margin-left: 40%;
        width: 20%;
        text-align: center;
    }
    #DebtManager_dashboard_holder .expired-title:hover{
        display: none;
    }
    #DebtManager_dashboard_holder .debt-block.expired .debt-all-rows{
        border-left: 7px solid #e61313;
    }
    #DebtManager_dashboard_holder .debt-block.empty{
        background: #e6e6e68c;
    }
    #DebtManager_dashboard_holder .debt-block.empty .date{
        background: #ccc;
        font-size: 20px;
        border-right: 4px solid #b4b4b4;
    }
    #DebtManager_dashboard_holder .debt-block.empty .day,
    #DebtManager_dashboard_holder .debt-block.empty .month, 
    #DebtManager_dashboard_holder .debt-block.empty .year{
        font-size: 15px;
    }
    #DebtManager_dashboard_holder .date{
        border-right: 4px solid white;
        background-color: #3b7dce;
        padding: 5px;
    }
    #DebtManager_dashboard_holder .date .day, .date .month{
        font-size: 16px;
        color: white;
        font-weight: bold;
        font-family: Arial Black, Arial Bold, Gadget, sans-serif;
    }
    #DebtManager_dashboard_holder .date .day{
        font-size: 18px;
    }
    #DebtManager_dashboard_holder .date .year{
        font-size: 16px;
        color: white;
    }
    #DebtManager_dashboard_holder .debt-block.normal .debt-all-rows {
        background-color: white;
        padding-left: 10px;
        padding-right: 10px
    }
    #DebtManager_dashboard_holder .debt-row{
       display: grid;
       grid-template-columns: 18% 44% 17% 18%;
       padding: 6px;
       min-height: 2.6em;
       padding-top: 7px;
       background-color: white;
       margin: 4px 0px;
       align-items: center;
       border-bottom: 1px solid #d0d0d0;
    }
    
    #DebtManager_dashboard_holder .debt-row .debt-date, .debt-row .debt-amount, 
    #DebtManager_dashboard_holder .debt-row .debt-company-name, 
    #DebtManager_dashboard_holder .debt-row .debt-description, 
    #DebtManager_dashboard_holder .debt-row .debt-amount{
        padding-left: 6px;
        padding-right: 5px;
    }
    #DebtManager_dashboard_holder .debt-description{
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 57%;
    }
    #DebtManager_dashboard_holder .debt-row.buy .debt-amount.buy, #DebtManager_dashboard_holder .debt-row.sell .debt-amount.buy{
        color: red;
    }  
    #DebtManager_dashboard_holder .debt-row.sell .debt-amount.sell, #DebtManager_dashboard_holder .debt-row.buy .debt-amount.sell{
        color: green;
    }  
    #DebtManager_dashboard_holder .debt-amount{
        text-align: right;
        font-weight: bold;
    }
    #DebtManager_dashboard_holder .debt-row .debt-amount.buy{
        border-right: none !important;
    }
    #DebtManager_dashboard_holder .total-row{
        padding: 8px 8px;
        float: right;
        background-color: white;
        border: 1px solid lightgray;
        display: grid;
        grid-template-columns: 26% 40% 28%;
        width: 48%;
        text-align: right;
        margin: 7px 0px;
    }
    #DebtManager_dashboard_holder .total-row .total-label{
       margin: auto;
    }
    #DebtManager_dashboard_holder .total-row .sell-total{
       margin: auto;
       font-weight: bold;
       color: #026002;
    }
    #DebtManager_dashboard_holder .total-row .buy-total{
       margin: auto;
       font-weight: bold;
       color: red;
    }
    #DebtManager_dashboard_holder .debt-company-name{
        cursor: help;
    }
    #DebtManager_dashboard_holder .debt-company-info{
        display: inline-block;
        position: absolute;
        width: 46%;
        border: 1px solid lightgray;
        background-color: white;
        padding: 5px;
        padding-left: 5px;
        margin-left: 35px;
        box-shadow: 3px 3px 10px #9b9b9b;
    }
    #DebtManager_dashboard_holder .debt-company-info div{
        padding: 2px;
    }
    #DebtManager_dashboard_holder .debt-company-name:hover .debt-company-info{
        display: inline-block !important;
        cursor: pointer;
    }
    #DebtManager_dashboard_holder .load-more{
        transition: opacity 1s ease-in-out 0s;
        margin: 0px auto;
        display: table;
        padding: 7px;
        background-color: #f3f3f378;
        width: 20%;
        text-align: center;
        border: 1px solid lightgray;
        border-radius: 5px;
    }
</style>
<script>
    App.debt_manager_settings = {
        data:{},
        filter: {},
        block:'',
        block_template: '',
        empty_block_template: '',
        block_list:[],
        current_id: 0,
        is_loading: false,
        init: function () {
            App.debt_manager_settings.ajax_cancelling();
            Mark.pipes.month=function(index){
                return ['','Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'][index];
            };
            Mark.pipes.pay_date=function(date){
                var new_date_arr = date.split('-');
                var months = ['','января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря']
                return parseInt(new_date_arr[2]) +' '+ months[parseInt(new_date_arr[1])] +' '+ new_date_arr[0];
            };
            Mark.pipes.quarter=function(index){
                return ['','Iкв','IIкв','IIIкв','IVкв'][index];
            };
            App.debt_manager_settings.getSettings();
            App.debt_manager_settings.block_template = $('#block_template').html();
            App.debt_manager_settings.empty_block_template = $('#empty_block_template').html();
            App.debt_manager_settings.load(-1);
            $('.debt-container').scroll(function(){
                $('.load-more').each(function(){
                    $(this).css('transition', 'opacity 1s ease-in-out');
                    if(App.debt_manager_settings.is_loading == false){
                        if(App.debt_manager_settings.isScrolledIntoView($(this)) && App.debt_manager_settings.isScrolledIntoView($(this)) != 'expired'){
                            App.debt_manager_settings.load(App.debt_manager_settings.block_list.length-1);
                        }
                    } 
                    if (App.debt_manager_settings.isScrolledIntoView($(this)) == 'expired'){
                        $('.widget-panel').css('box-shadow', '0px 2px 12px #930000 ');
                        $('.expired-title').css('opacity', '1');
                    } else {
                        $('.widget-panel').css('box-shadow', '0px 2px 12px #070707');
                        $('.expired-title').css('opacity', '0');
                    }
                }) 
            });
        },
        load: function(offset){
            App.debt_manager_settings.filter.group_by_date = App.debt_manager_settings.data.group_by_date;
            App.debt_manager_settings.filter.block_number = offset;
            var html = '';
            while (App.debt_manager_settings.filter.block_number <= offset+7) {
                App.debt_manager_settings.current_id = App.debt_manager_settings.filter.block_number;
                $('#empty_container div').attr("id","block_"+App.debt_manager_settings.filter.block_number);
                html += $('#empty_container').html();
                App.debt_manager_settings.block_list.push(''); 
                App.debt_manager_settings.load_block(App.debt_manager_settings.filter.block_number);
                App.debt_manager_settings.filter.block_number++;
            }
            $( "#debtList" ).append( html);
            return;
        },
        reload: function(){
            $( "#debtList" ).html('');
            App.debt_manager_settings.block_list = [];
            App.debt_manager_settings.filter.block_number = -1;
            App.debt_manager_settings.load(-1);
        },
        load_block: function(block_number){
            App.debt_manager_settings.is_loading = true;
            $.post('DebtManager/getBlock', {filter:JSON.stringify(App.debt_manager_settings.filter)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.block = response;
                    if(response.list){
                        App.debt_manager_settings.render(App.debt_manager_settings.block, block_number);
                    } else {
                        App.debt_manager_settings.render('empty', block_number);
                    }
                }
            });
        },
        render:function(block, block_number){
            App.debt_manager_settings.block_template = $('#block_template').html();
            if(block === 'empty'){
                App.debt_manager_settings.empty_block_template = $('#empty_block_template').html();
                App.debt_manager_settings.empty_block_template = Mark.up(App.debt_manager_settings.empty_block_template,{date:block.date});
                $('#block_'+block_number).html(App.debt_manager_settings.empty_block_template);
                return;
            }
            App.debt_manager_settings.block_template = Mark.up(App.debt_manager_settings.block_template,{block:block.list, date:block.date, total:block.total});
            $('#block_'+block_number).html(App.debt_manager_settings.block_template);
            App.debt_manager_settings.is_loading = false;
        },
        
        getSettings: function(){
            
            $.post('DebtManager/getUserSettings', function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.data = response;
                    $("select[name='group_by_date']").val(App.debt_manager_settings.data.group_by_date);
                    $("select[name='group_by_pcomp']").val(App.debt_manager_settings.data.group_by_pcomp);
                    $("input[name='pcomp_name']").val(App.debt_manager_settings.data.pcomp_name);
                    $("input[name='pcomp_id']").val(App.debt_manager_settings.data.pcomp_id);
                    $("input[name='buy_trans']").prop('checked', App.debt_manager_settings.data.buy_trans);
                    $("input[name='sell_trans']").prop('checked', App.debt_manager_settings.data.sell_trans);
                    $("input[name='notificate']").prop('checked', App.debt_manager_settings.data.notificate);
                    return;
                } 
            });
        },
        updateSettings: function () {
            $.xhrPool.abortAll();
            var checked = $("input[type=checkbox]:checked.checkbox").length;
            if(!checked) { 
                alert("Как минимум один параметр должен быть выбран.");
                $("input[name='buy_trans']").prop('checked', true);
                $("input[name='sell_trans']").prop('checked', true); 
            }
            App.debt_manager_settings.data.group_by_date = $("select[name='group_by_date']").val();
            App.debt_manager_settings.data.group_by_pcomp = $("select[name='group_by_pcomp']").val();
            App.debt_manager_settings.data.pcomp_name = $("input[name='pcomp_name']").val();
            App.debt_manager_settings.data.pcomp_id = $("input[name='pcomp_id']").val();
            App.debt_manager_settings.data.buy_trans = $("input[name='buy_trans']").is(":checked");
            App.debt_manager_settings.data.sell_trans = $("input[name='sell_trans']").is(":checked");
            App.debt_manager_settings.data.notificate = $("input[name='notificate']").is(":checked");
            $.post('DebtManager/updateSettings', {user_settings: JSON.stringify(App.debt_manager_settings.data)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.data = response;
                    $("input[name=pcomp_id]").val(App.debt_manager_settings.data.pcomp_id);
                    $("input[name=pcomp_name]").val(App.debt_manager_settings.data.pcomp_name);
                    $("select[name=group_by_date]").val(App.debt_manager_settings.data.group_by_date);
                    $("select[name=group_by_pcomp]").val(App.debt_manager_settings.data.group_by_pcomp);
                    $("input[name='buy_trans']").prop('checked', App.debt_manager_settings.data.buy_trans);
                    $("input[name='sell_trans']").prop('checked', App.debt_manager_settings.data.sell_trans);
                    $("input[name='notificate']").prop('checked', App.debt_manager_settings.data.notificate);
                    App.debt_manager_settings.reload();
                }
            });
        },
        select_pcomp: function () {
            App.user.pcompSelectionDialog().progress(function(status,pcomp){
                if (status === 'select' ) {
                    $("input[name=pcomp_name]").val(pcomp.label);
                    $("input[name=pcomp_id]").val(pcomp.company_id);
                    App.debt_manager_settings.updateSettings();
                } else if(status === 'reset') {
                    $("input[name=pcomp_name]").val("");
                    $("input[name=pcomp_id]").val("");
                    App.debt_manager_settings.updateSettings();
                }
            });
        },
        isScrolledIntoView: function(elem){
            var $elem = $(elem);
            var $viewport = $('.debt-container');
            var $expired_block = $('.debt-block.expired');
            var elemTop = $elem.offset().top;
            if($expired_block){
                 var expiredBlockBottom = $expired_block.offset().top + $expired_block.height();
            }
            var viewScroll = $viewport.scrollTop();
            var viewHeight = $('#DebtManager_dashboard_holder').height();
            if((expiredBlockBottom) > 80){
                return 'expired';
            } 
            return (((elemTop) - (viewHeight)) < 260 );
        },
        ajax_cancelling: function(){
            $.xhrPool = []; // array of uncompleted requests
            $.xhrPool.abortAll = function() { // our abort function
                $(this).each(function(idx, jqXHR) { 
                    jqXHR.abort();
                });
                $.xhrPool.length = 0
            };

            $.ajaxSetup({
                beforeSend: function(jqXHR) { // before jQuery send the request we will push it to our array
                    $.xhrPool.push(jqXHR);
                },
                complete: function(jqXHR) { // when some of the requests completed it will splice from the array
                    var index = $.xhrPool.indexOf(jqXHR);
                    if (index > -1) {
                        $.xhrPool.splice(index, 1);
                    }
                }
            });
        }
    };
    $(App.debt_manager_settings.init);
</script>
