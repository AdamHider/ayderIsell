<div class="panel panel-htop">
    <div class="panel-header">
        <div class="panel-title" style="font-size:16px">Менеджер задолженностей</div>
        <div class="panel-tool">
            <a class="icon-24 icon-utils" title="Дополнительные свойства" onclick="$('.plugin_settings').toggle('slow')"> 
            </a>
        </div>
    </div>
</div>     
<div class="plugin_settings panel-body">
            <div class="debt-settings-input">
                <label>
                    <div class="explain" style="display:none; position:absolute">Выберите здесь способ группировки задолженностей.</div>
                    Группировать дату по:
                </label>
                <select name="group_by_date" onchange="App.debt_manager_settings.updateSettings()">
                    <option value="DAY">дням</option>
                    <option value="WEEK">неделям</option>
                    <option value="MONTH">месяцам</option>
                    <option value="QUARTER">кварталам</option>
                    <option value="YEAR">годам</option>
                </select>
            </div>
            <div class="debt-settings-input">
                <label>
                    <div class="explain" style="display:none; position:absolute">Если хотите сократить длину списка и сгруппировать долги по клиентам, выберите "Да".</div>
                    Группировать по клиентам:
                </label>
                <select name="group_by_pcomp"  onchange="App.debt_manager_settings.updateSettings()">
                    <option value="1">Да</option>
                    <option value="0">Нет</option>
                </select>
            </div>
            <div class="debt-settings-input">
                <label>
                    <div class="explain" style="display:none; position:absolute">Вы можете выбрать нужного контрагента и увидеть в списке только его задолженности.</div>
                    Показывать долги клиента: 
                </label>
                
                <div class="inp_group">
                    <input title="" name="pcomp_name" value="" readonly="readonly" required="required" style="width:100px" placeholder="Все"/>
                    <input name="pcomp_id" value="" type="hidden" required="required" style="width:100px"/>
                    <button type="button" class="tiny_button" onclick="App.debt_manager_settings.select_pcomp()"><img src="img/settings.png"> Выбрать</button>
                </div>
            </div>
            <div >
                <div class="debt-settings-checkbox">
                    <label for="buy_trans">
                        <div class="explain" style="display:none; position:absolute">Показывать наши долги перед поставщиками.</div>
                        Наши долги
                    </label>
                    <input type="checkbox" class="checkbox" name="buy_trans" onchange="App.debt_manager_settings.updateSettings()"
                           checked>
                </div>
                <div class="debt-settings-checkbox">
                    <label for="sell_trans">
                        <div class="explain" style="display:none; position:absolute">Показывать долги клиентов нашей фирме.</div>
                        Долги клиентов
                    </label>
                    <input type="checkbox" class="checkbox"  name="sell_trans" onchange="App.debt_manager_settings.updateSettings()"
                           checked>
                </div>
                <div class="debt-settings-checkbox">
                    <label for="notificate">
                        <div class="explain" style="display:none; position:absolute">Отправлять уведомления о ближайших задолженностях в чат.</div>
                        Включить уведомления
                    </label>
                    <input type="checkbox" class="checkbox"  name="notificate" onchange="App.debt_manager_settings.updateSettings()"
                            checked>
                </div>  
            </div>
        </div>
    <div>
</div> 
<div class="debt-container">
    <div id="debtList"></div> 
    <div class="load-more">Загрузка...</div>   
</div>        
<div style="display:none">
    <div id="block_template" >
        <div class="debt-block{{if date}}{{else}} expired{{/if}} {{if block|notempty}} normal{{else}} empty{{/if}} ester-scroll-viewed">
            {{if date}}
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{if date.month|more>0 }}
                        {{date.month|month|blank>}}
                    {{else}}
                    {{/if}}
                    
                    {{if date.quarter|falsy }}
                    {{else}}
                    {{date.quarter}} Квартал
                    {{/if}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            {{else}}
            <div></div>
            {{/if}}
            <div class="debt-all-rows">
                {{if block|notempty}}
                    {{block}}
                    <div class="debt-row {{ trans_type }}">
                            <div class="debt-date" >{{pay_date}}</div>
                            <div class="debt-company-name" >
                                <div>{{company_label}}</div>
                                <div class="debt-company-info" style="display:none ">
                                    <div>{{company_name}}</div>
                                    <div>{{company_person}}</div>
                                    <div>{{company_mobile}}</div>
                                    <div>{{company_email}}</div>
                                    <div>{{company_address}}</div>
                                </div>
                            </div>
                            <div class="debt-description" >
                                <div>{{description}}</div>
                                <div class="debt-description-info" style="display:none ">{{description}}</div> 
                            </div>
                            <div class="debt-amount sell">{{amount_sell}} </div>
                            <div class="debt-amount buy">{{amount_buy}} </div>
                    </div>
                    {{/block}}
                    
                    <div class="total-row">
                        {{if total}}
                        <div class="total-label">Итого:</div>
                                <div class="sell-total" >
                                    {{total.sell}}
                                </div>
                                <div class="buy-total">
                                    {{total.buy}}
                                </div>
                        {{/if}} 
                    </div>
                {{/if}}    
            </div>
        </div>
    </div>
    <div id="empty_block_template">
        <div class="debt-block">
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{date.month}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            <div class="debt-all-rows" >
                <div>empty</div>
            </div> 
        </div>    
    </div>
</div> 
<div id="empty_container" style="display:none">
    <div></div>
</div>
<style>
    .plugin_settings{
        background-color: rgba(255,255,255,0.7);
        padding:10px;
        position: relative;
        box-shadow: 2px 3px 9px #878787;
        overflow: initial;
    }
    .icon-utils{
    }
    .debt-settings-input label, .debt-settings-checbox label{
        cursor: help;
    }
    .debt-settings-input label:hover .explain, .debt-settings-checkbox label:hover .explain{
        display: block !important;
    }
    .explain:hover{
        display: none !important;
    }
    .explain{
        position: absolute;
        width: 40%;
        border: 1px solid lightgray;
        background-color: white;
        padding: 5px;
        padding-left: 5px;
        margin-left: 35px;
        white-space: initial;
        z-index: 100;
    }
    .debt-settings-input, .debt-settings-checkbox {
        padding: 3px;
    }
    .debt-settings-input select{
        height:24px;
    }
    .debt-settings-checkbox input{
        height:20px;
        width:20px;
    }
    .debt-settings-input{
        display: grid;
        grid-template-columns: 33% 33% 33%;
    }
    .debt-settings-checkbox{
        display: grid;
        grid-template-columns: 33% 33% 33%;
    }
    .debt-block{
        display: grid;
        grid-template-columns: 20% 80%;
        grid-column-gap: inherit;
        border: 1px solid #bdbdbdb3;
        margin: 5px 0px;
    }
    .debt-block.expired{
        grid-template-columns: 100%;
    }

    .debt-block.expired{
        grid-template-columns: 100%;
    }
    
    .debt-block.expired .debt-row{
        border: 1px solid #ff00005c;
    }
    .debt-block.empty{
        background: #e6e6e68c;
        margin-left: 10px;
    }
    .debt-block.empty .date{
        background: #ccc;
        font-size: 20px;
        border-right: 4px solid #b4b4b4;
    }
    .debt-block.empty .day{
        font-size: 15px;
    }
    .debt-block.empty .month{
        font-size: 15px;
    }
    .debt-block.empty .year{
        font-size: 15px;
    }
    .date{
        border-right: 4px solid orange;
        background-color: #53535391;
        padding: 5px;
    }
    .date .day{
        font-size: 20px;
        color: white;
        font-weight: bold;
        font-family: Arial Black, Arial Bold, Gadget, sans-serif;
    }
    .date .month{
        font-size: 20px;
        color: white;
        font-weight: bold;
        font-family: Arial Black, Arial Bold, Gadget, sans-serif;
    }
    .date .year{
        font-size: 20px;
        color: white;
    }
    .debt-block.normal .debt-all-rows {
        background-color: #e4e4e4e6;
        padding-left: 10px;
    }
    .debt-row{
       display: grid;
       grid-template-columns: 16% 27% 23% 17% 18%;
       padding: 6px;
       min-height: 2.6em;
       padding-top: 7px;
       background-color: white;
       margin: 4px 0px;
       border-radius: 5px;
       border: 1px solid lightgrey;
    }
    
    .debt-row .debt-date, .debt-row .debt-amount, .debt-row .debt-company-name, .debt-row .debt-description, .debt-row .debt-amount{
        border-right: 1px solid gray;
        padding-left: 6px;
        padding-right: 5px;
    }
    .debt-description{
        max-height: 3.5em;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
    .debt-row.buy .debt-amount{
        color: red;
    }  
    .debt-row.sell .debt-amount{
        color: green;
    }  
    .debt-amount{
        text-align: right;
        font-weight: bold;
    }
    .debt-row .debt-amount.buy{
        border-right: none !important;
    }
    .total-row{
        padding: 8px 8px;
        float: right;
        background-color: white;
        border: 1px solid lightgray;
        display: grid;
        grid-template-columns: 26% 40% 28%;
        width: 48%;
        text-align: right;
        margin: 7px 0px;
    }
    .total-row .total-label{
       margin: auto;
    }
    .total-row .sell-total{
       margin: auto;
       font-weight: bold;
       color: #026002;
    }
    .total-row .buy-total{
       margin: auto;
       font-weight: bold;
       color: red;
    }
    .debt-company-name, .debt-description{
        cursor: help;
    }
    .debt-company-info{
        display: inline-block;
        position: absolute;
        width: 12%;
        border: 1px solid lightgray;
        background-color: white;
        padding: 5px;
        padding-left: 5px;
        margin-left: 35px;
        box-shadow: 3px 3px 10px #9b9b9b;
    }
    .debt-company-info div{
        padding: 2px;
    }
    .debt-company-name:hover .debt-company-info{
        display: inline-block !important;
        cursor: pointer;
    }
    .debt-description:hover .debt-description-info{
        display: inline-block !important;
        position: absolute;
        width: 10%;
        border: 1px solid lightgray;
        background-color: white;
        padding: 5px;
        padding-left: 5px;
        margin-left: 35px;
        box-shadow: 3px 3px 10px #9b9b9b;
        white-space: initial;
    }
    .load-more{
        transition: opacity 1s ease-in-out 0s;
        margin: 0px auto;
        display: table;
        padding: 7px;
        background-color: #f3f3f378;
        width: 20%;
        text-align: center;
        border: 1px solid lightgray;
        border-radius: 5px;
    }
    .debt-container{
        overflow-y: scroll;
        max-height: 85vh;
    }
</style>
<script>
    App.debt_manager_settings = {
        data:{},
        filter: {},
        block:'',
        block_template: '',
        empty_block_template: '',
        block_list:[],
        current_id: 0,
        is_loading: false,
        init: function () {
            App.debt_manager_settings.ajax_cancelling();
            Mark.pipes.month=function(index){
                return ['','Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'][index];
            };
            Mark.pipes.quarter=function(index){
                return ['','Iкв','IIкв','IIIкв','IVкв'][index];
            };
            App.debt_manager_settings.getSettings();
            App.debt_manager_settings.block_template = $('#block_template').html();
            App.debt_manager_settings.empty_block_template = $('#empty_block_template').html();
            App.debt_manager_settings.load(-1);
            $('.debt-container').scroll(function(){
                $('.load-more').each(function(){
                    $(this).css('transition', 'opacity 1s ease-in-out');
                    if(App.debt_manager_settings.is_loading == false){
                        if(App.debt_manager_settings.isScrolledIntoView($(this))){
                            App.debt_manager_settings.load(App.debt_manager_settings.block_list.length-1);
                        }
                    }
                }) 
            });
        },
        load: function(offset){
            App.debt_manager_settings.filter.group_by_date = App.debt_manager_settings.data.group_by_date;
            App.debt_manager_settings.filter.block_number = offset;
            if(offset == 0){
                //App.debt_manager_settings.load_block('expired');
            }
            var html = '';
            while (App.debt_manager_settings.filter.block_number <= offset+9) {
                App.debt_manager_settings.current_id = App.debt_manager_settings.filter.block_number;
                $('#empty_container div').attr("id","block_"+App.debt_manager_settings.filter.block_number);
                html += $('#empty_container').html();
                App.debt_manager_settings.block_list.push(''); 
                App.debt_manager_settings.load_block(App.debt_manager_settings.filter.block_number);
                App.debt_manager_settings.filter.block_number++;
            }
            $( "#debtList" ).append( html);
            return;
        },
        reload: function(){
            $( "#debtList" ).html('');
            App.debt_manager_settings.block_list = [];
            App.debt_manager_settings.filter.block_number = -1;
            App.debt_manager_settings.load(-1);
        },
        load_block: function(block_number){
            App.debt_manager_settings.is_loading = true;
            $.post('DebtManager/getBlock', {filter:JSON.stringify(App.debt_manager_settings.filter)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.block = response;
                    if(response.list){
                        App.debt_manager_settings.render(App.debt_manager_settings.block, block_number);
                    } else {
                        App.debt_manager_settings.render('empty', block_number);
                    }
                }
            });
        },
        render:function(block, block_number){
            App.debt_manager_settings.block_template = $('#block_template').html();
            if(block === 'empty'){
                App.debt_manager_settings.empty_block_template = $('#empty_block_template').html();
                App.debt_manager_settings.empty_block_template = Mark.up(App.debt_manager_settings.empty_block_template,{date:block.date});
                $('#block_'+block_number).html(App.debt_manager_settings.empty_block_template);
                return;
            }
            App.debt_manager_settings.block_template = Mark.up(App.debt_manager_settings.block_template,{block:block.list, date:block.date, total:block.total});
            $('#block_'+block_number).html(App.debt_manager_settings.block_template);
            App.debt_manager_settings.is_loading = false;
        },
        
        getSettings: function(){
            
            $.post('DebtManager/getUserSettings', function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.data = response;
                    $("select[name='group_by_date']").val(App.debt_manager_settings.data.group_by_date);
                    $("select[name='group_by_pcomp']").val(App.debt_manager_settings.data.group_by_pcomp);
                    $("input[name='pcomp_name']").val(App.debt_manager_settings.data.pcomp_name);
                    $("input[name='pcomp_id']").val(App.debt_manager_settings.data.pcomp_id);
                    $("input[name='buy_trans']").prop('checked', App.debt_manager_settings.data.buy_trans);
                    $("input[name='sell_trans']").prop('checked', App.debt_manager_settings.data.sell_trans);
                    $("input[name='notificate']").prop('checked', App.debt_manager_settings.data.notificate);
                    return;
                } 
            });
        },
        updateSettings: function () {
            $.xhrPool.abortAll();
            var checked = $("input[type=checkbox]:checked.checkbox").length;
            if(!checked) { 
                alert("Как минимум один параметр должен быть выбран.");
                $("input[name='buy_trans']").prop('checked', true);
                $("input[name='sell_trans']").prop('checked', true); 
            }
            App.debt_manager_settings.data.group_by_date = $("select[name='group_by_date']").val();
            App.debt_manager_settings.data.group_by_pcomp = $("select[name='group_by_pcomp']").val();
            App.debt_manager_settings.data.pcomp_name = $("input[name='pcomp_name']").val();
            App.debt_manager_settings.data.pcomp_id = $("input[name='pcomp_id']").val();
            App.debt_manager_settings.data.buy_trans = $("input[name='buy_trans']").is(":checked");
            App.debt_manager_settings.data.sell_trans = $("input[name='sell_trans']").is(":checked");
            App.debt_manager_settings.data.notificate = $("input[name='notificate']").is(":checked");
            $.post('DebtManager/updateSettings', {user_settings: JSON.stringify(App.debt_manager_settings.data)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.data = response;
                    $("input[name=pcomp_id]").val(App.debt_manager_settings.data.pcomp_id);
                    $("input[name=pcomp_name]").val(App.debt_manager_settings.data.pcomp_name);
                    $("select[name=group_by_date]").val(App.debt_manager_settings.data.group_by_date);
                    $("select[name=group_by_pcomp]").val(App.debt_manager_settings.data.group_by_pcomp);
                    $("input[name='buy_trans']").prop('checked', App.debt_manager_settings.data.buy_trans);
                    $("input[name='sell_trans']").prop('checked', App.debt_manager_settings.data.sell_trans);
                    $("input[name='notificate']").prop('checked', App.debt_manager_settings.data.notificate);
                    App.debt_manager_settings.reload();
                }
            });
        },
        select_pcomp: function () {
            App.user.pcompSelectionDialog().progress(function(status,pcomp){
                if (status === 'select' ) {
                    $("input[name=pcomp_name]").val(pcomp.label);
                    $("input[name=pcomp_id]").val(pcomp.company_id);
                    App.debt_manager_settings.updateSettings();
                } else if(status === 'reset') {
                    $("input[name=pcomp_name]").val("");
                    $("input[name=pcomp_id]").val("");
                    App.debt_manager_settings.updateSettings();
                }
            });
        },
        isScrolledIntoView: function(elem){
            var $elem = $(elem);
            var $viewport = $('.debt-container');
            var elemTop = $elem.offset().top;
            var viewScroll = $viewport.scrollTop();
            var viewHeight = $('#DebtManager_dashboard_holder').height();
            return (((elemTop) - (viewHeight)) < 60 );
        },
        ajax_cancelling: function(){
            $.xhrPool = []; // array of uncompleted requests
            $.xhrPool.abortAll = function() { // our abort function
                $(this).each(function(idx, jqXHR) { 
                    jqXHR.abort();
                });
                $.xhrPool.length = 0
            };

            $.ajaxSetup({
                beforeSend: function(jqXHR) { // before jQuery send the request we will push it to our array
                    $.xhrPool.push(jqXHR);
                },
                complete: function(jqXHR) { // when some of the requests completed it will splice from the array
                    var index = $.xhrPool.indexOf(jqXHR);
                    if (index > -1) {
                        $.xhrPool.splice(index, 1);
                    }
                }
            });
        }
    };
    $(App.debt_manager_settings.init);
</script>
