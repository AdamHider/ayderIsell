<div class="widget-panel">
    <div class="widget-header">
        <div class='widget-icon'>
            <img src="img/debtmanager.png" width="32" height="32">
        </div>
        <div class="widget-title" style="font-size:16px">Календарь платежей</div>
        <div class="widget-reload">
            <img src="img/widget-reload.png" width="25" height="25">
        </div>
        <div class="widget-settings" onclick="$('.plugin_settings').slideToggle('fast')">
            <img src="img/widget-settings.png" width="25" height="25">
        </div>
    </div>
    <div class="plugin_settings panel-body" style='display: none'>
        <div class="debt-settings-input" title="Выберите здесь способ группировки задолженностей.">
            <label>
                Группировать дату по:
            </label>
            <select name="group_by_date">
                <option value="DAY">дням</option>
                <option value="WEEK">неделям</option>
                <option value="MONTH">месяцам</option>
                <option value="QUARTER">кварталам</option>
                <option value="YEAR">годам</option>
            </select>
        </div>
        <div class="debt-settings-input" title="Если хотите сократить длину списка и сгруппировать долги по клиентам, выберите Да.">
            <label>
                Группировать по клиентам:
            </label>
            <select name="group_by_pcomp" >
                <option value="1">Да</option>
                <option value="0">Нет</option>
            </select>
        </div>
        <div class="debt-settings-input" title="Вы можете выбрать нужного контрагента и увидеть в списке только его задолженности.">
            <label>
                Показывать долги клиента: 
            </label>
            <div class="inp_group">
                <input title="" name="pcomp_name" value="" readonly="readonly" required="required" style="width:100px" placeholder="Все"/>
                <input name="pcomp_id" value="" type="hidden" style="width:100px"/>
                <button type="button" class="tiny_button" onclick="debt_manager_settings.select_pcomp()"><img src="img/settings.png"> Выбрать</button>
            </div>
        </div>
        <div>
            <div class="debt-settings-checkbox" title="Показывать наши долги перед поставщиками.">
                <label for="buy_trans">
                    Наши долги
                </label>
                <input type="checkbox" class="checkbox" name="buy_trans" checked>
            </div>
            <div class="debt-settings-checkbox" title="Показывать долги клиентов нашей фирме.">
                <label for="sell_trans">
                    Долги клиентов
                </label>
                <input type="checkbox" class="checkbox"  name="sell_trans" checked>
            </div>
            <div class="debt-settings-checkbox" title="Учитывать/не учитывать выбранную Вами активную компанию.">
                <label for="acomp">
                    Учитывать активную компанию
                </label>
                <input type="checkbox" class="checkbox"  name="acomp" checked>
            </div>
            <div class="debt-settings-checkbox" title="Отправлять уведомления о ближайших задолженностях в чат.">
                <label for="notificate">
                    Включить уведомления
                </label>
                <input type="checkbox" class="checkbox"  name="notificate" checked>
            </div>
        </div>
    </div>
</div>     

<div class="debt-container">
    <div class="debtList"></div> 
    <div class="load-more">Загрузка...</div>   
</div>        
<div style="display:none">
    <div class="block_template">
        <div class="debt-block{{if date}}{{else}} expired{{/if}} {{if block|notempty}} normal{{else}} empty{{/if}} ester-scroll-viewed">
            {{if date}}
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{if date.month|more>0 }}
                        {{date.month|month|blank>}}
                    {{else}}
                    {{/if}}
                    
                    {{if date.quarter|falsy }}
                    {{else}}
                    {{date.quarter}} Квартал
                    {{/if}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            {{else}}
            <div></div>
            {{/if}}
            <div class="debt-all-rows">
                
                {{if block|notempty}}
                    {{block}}
                    <div class="debt-row {{ trans_type }}" data-pcomp_id="{{passive_company_id}}">
                        <div class="debt-date" >{{pay_date|pay_date|blank>}}</div>
                        <div class="debt-company-name" >
                            <div>{{company_label}}</div>
                            <div class="debt-company-info" style="display:none ">
                                <div>{{company_name}}</div>
                                <div>{{company_person}}</div>
                                <div>{{company_mobile}}</div>
                                <div>{{company_email}}</div>
                                <div>{{company_address}}</div>
                                <div class="debt-description" >
                                    <div><b>Документы: </b></div>
                                    <div>{{description}}</div>
                                </div>
                            </div>
                        </div>
                        
                            <div class="debt-amount sell">{{if amount_sell|falsy}}
                                    {{else}}{{amount_sell}}{{/if}}</div>
                        
                            <div class="debt-amount buy">{{if amount_buy|falsy}}
                                    {{else}}{{amount_buy}}{{/if}} </div>
                    </div>
                    {{/block}}
                    
                    <div class="total-row">
                        {{if total}}
                        <div class="total-label">Итого:</div>
                        
                                {{if total.sell|falsy}}
                                {{else}}
                                    <div class="sell-total" >
                                        {{total.sell}}
                                    </div>
                                {{/if}}
                                {{if total.buy|falsy}}
                                {{else}}
                                    <div class="buy-total">
                                        {{total.buy}}
                                    </div>
                                {{/if}}
                        {{/if}} 
                    </div>
                {{/if}}    
            </div>
        </div>
    </div>
    <div class="empty_block_template">
        <div class="debt-block">
            <div class="date">
                <div class="day">
                    {{date.day}}
                </div>
                <div class="month">
                    {{date.month}}
                </div>
                <div class="year">
                    {{date.year}}
                </div>
            </div>
            <div class="debt-all-rows" >
                <div>empty</div>
            </div> 
        </div>    
    </div>
</div> 
<div class="empty_container" style="display:none">
    <div></div>
</div>
<link href="DebtManager/debtmanager.css"  rel="stylesheet" type="text/css">
<script>
(function(){
    var $holder=$(document.scripts[document.scripts.length - 1].parentNode.firstElementChild);
    var debt_manager_settings = {
        data:{},
        filter: {},
        block:'',
        block_template: '',
        empty_block_template: '',
        block_list:[],
        current_id: 0,
        is_loading: false,
        init: function () {
            debt_manager_settings.ajax_cancelling();
            Mark.pipes.month=function(index){
                return ['','Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'][index];
            };
            Mark.pipes.pay_date=function(date){
                var new_date_arr = date.split('-');
                var months = ['','января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря']
                return parseInt(new_date_arr[2]) +' '+ months[parseInt(new_date_arr[1])] +' '+ new_date_arr[0];
            };
            Mark.pipes.quarter=function(index){
                return ['','Iкв','IIкв','IIIкв','IVкв'][index];
            };
            debt_manager_settings.getSettings();
            debt_manager_settings.block_template = $holder.find('.block_template').html();
            debt_manager_settings.empty_block_template = $holder.find('.empty_block_template').html();
            debt_manager_settings.load(-1);
            $holder.find('.debt-container').scroll(function(){
                $holder.find('.load-more').each(function(){
                    $(this).css('transition', 'opacity 1s ease-in-out');
                    if(debt_manager_settings.is_loading == false){
                        if(debt_manager_settings.isScrolledIntoView($(this)) && debt_manager_settings.isScrolledIntoView($(this)) != 'expired'){
                            debt_manager_settings.load(debt_manager_settings.block_list.length-1);
                        }
                    } 
                });
            });
            App.Topic('activeCompanySelected').subscribe(function(){
                debt_manager_settings.reload();
            });
            
            
            if($holder.find('.debt-container').scrollTop() == 0){
               debt_manager_settings.load(debt_manager_settings.block_list.length-1);
            }
            $holder.find('.plugin_settings input').change(function(){
                debt_manager_settings.updateSettings();
            });
            $holder.find('.widget-reload').click(function(){
                debt_manager_settings.reload();
            });
        },
        load: function(offset){
            debt_manager_settings.filter.group_by_date = debt_manager_settings.data.group_by_date;
            debt_manager_settings.filter.block_number = offset;
            var html = '';
            while (debt_manager_settings.filter.block_number <= offset + 0) {
                debt_manager_settings.current_id = debt_manager_settings.filter.block_number;
                $holder.find('.empty_container div').attr("class","block_"+debt_manager_settings.filter.block_number);
                html += $holder.find('.empty_container').html();
                debt_manager_settings.block_list.push(''); 
                debt_manager_settings.load_block(debt_manager_settings.filter.block_number);
                debt_manager_settings.filter.block_number++;
            }
            $holder.find( ".debtList" ).append( html);
            return;
        },
        reload: function(){
            $holder.find( ".debtList" ).html('');
            debt_manager_settings.block_list = [];
            debt_manager_settings.filter.block_number = -1;
            debt_manager_settings.load(-1);
        },
        load_block: function(block_number){
            debt_manager_settings.is_loading = true;
            $.post('DebtManager/getBlock', {filter:JSON.stringify(debt_manager_settings.filter)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    debt_manager_settings.block = response;
                    if(response.list){
                        debt_manager_settings.render(debt_manager_settings.block, block_number);
                    } else {
                        debt_manager_settings.render('empty', block_number);
                    }
                }
            });
        },
        render:function(block, block_number){
            debt_manager_settings.block_template = $holder.find('.block_template').html();
            if(block === 'empty'){
                debt_manager_settings.empty_block_template = $holder.find('.empty_block_template').html();
                debt_manager_settings.empty_block_template = Mark.up(debt_manager_settings.empty_block_template,{date:block.date});
                $holder.find('.block_'+block_number).html(debt_manager_settings.empty_block_template);
                return;
            }
            debt_manager_settings.block_template = Mark.up(debt_manager_settings.block_template,{block:block.list, date:block.date, total:block.total});
            $holder.find('.block_'+block_number).html(debt_manager_settings.block_template);
            debt_manager_settings.is_loading = false;
        },
        
        getSettings: function(){
            
            $.post('DebtManager/getUserSettings', function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    debt_manager_settings.data = response;
                    $holder.find("select[name='group_by_date']").val(debt_manager_settings.data.group_by_date);
                    $holder.find("select[name='group_by_pcomp']").val(debt_manager_settings.data.group_by_pcomp);
                    $holder.find("input[name='pcomp_name']").val(debt_manager_settings.data.pcomp_name);
                    $holder.find("input[name='pcomp_id']").val(debt_manager_settings.data.pcomp_id);
                    $holder.find("input[name='buy_trans']").prop('checked', debt_manager_settings.data.buy_trans);
                    $holder.find("input[name='sell_trans']").prop('checked', debt_manager_settings.data.sell_trans);
                    $holder.find("input[name='acomp']").prop('checked', debt_manager_settings.data.acomp);
                    $holder.find("input[name='notificate']").prop('checked', debt_manager_settings.data.notificate);
                    return;
                } 
            });
        },
        updateSettings: function () {
            $.xhrPool.abortAll();
            var checked = $holder.find("input[type=checkbox]:checked.checkbox").length;
            if(!checked) { 
                alert("Как минимум один параметр должен быть выбран.");
                $holder.find("input[name='buy_trans']").prop('checked', true);
                $holder.find("input[name='sell_trans']").prop('checked', true); 
            }
            debt_manager_settings.data.group_by_date = $holder.find("select[name='group_by_date']").val();
            debt_manager_settings.data.group_by_pcomp = $holder.find("select[name='group_by_pcomp']").val();
            debt_manager_settings.data.pcomp_name = $holder.find("input[name='pcomp_name']").val();
            debt_manager_settings.data.pcomp_id = $holder.find("input[name='pcomp_id']").val();
            debt_manager_settings.data.buy_trans = $holder.find("input[name='buy_trans']").is(":checked");
            debt_manager_settings.data.sell_trans = $holder.find("input[name='sell_trans']").is(":checked");
            debt_manager_settings.data.acomp = $holder.find("input[name='acomp']").is(":checked");
            debt_manager_settings.data.notificate = $holder.find("input[name='notificate']").is(":checked");
            $.post('DebtManager/updateSettings', {user_settings: JSON.stringify(debt_manager_settings.data)}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    debt_manager_settings.data = response;
                    $holder.find("input[name=pcomp_id]").val(debt_manager_settings.data.pcomp_id);
                    $holder.find("input[name=pcomp_name]").val(debt_manager_settings.data.pcomp_name);
                    $holder.find("select[name=group_by_date]").val(debt_manager_settings.data.group_by_date);
                    $holder.find("select[name=group_by_pcomp]").val(debt_manager_settings.data.group_by_pcomp);
                    $holder.find("input[name='buy_trans']").prop('checked', debt_manager_settings.data.buy_trans);
                    $holder.find("input[name='sell_trans']").prop('checked', debt_manager_settings.data.sell_trans);
                    $holder.find("input[name='acomp']").prop('checked', debt_manager_settings.data.acomp);
                    $holder.find("input[name='notificate']").prop('checked', debt_manager_settings.data.notificate);
                    debt_manager_settings.reload();
                }
            });
        },
        select_pcomp: function () {
            App.user.pcompSelectionDialog().progress(function(status,pcomp){
                if (status === 'select' ) {
                    $holder.find("input[name=pcomp_name]").val(pcomp.label);
                    $holder.find("input[name=pcomp_id]").val(pcomp.company_id);
                    debt_manager_settings.updateSettings();
                } else if(status === 'reset') {
                    $holder.find("input[name=pcomp_name]").val("");
                    $holder.find("input[name=pcomp_id]").val("");
                    debt_manager_settings.updateSettings();
                }
            });
        },
        isScrolledIntoView: function(elem){
            var $elem = $holder.find(elem);
            var elemTop = $elem.offset().top;
            var viewHeight = $holder.height();
            return (((elemTop) - (viewHeight)) < 60 );
        },
        ajax_cancelling: function(){
            $.xhrPool = []; // array of uncompleted requests
            $.xhrPool.abortAll = function() { // our abort function
                $(this).each(function(idx, jqXHR) { 
                    jqXHR.abort();
                });
                $.xhrPool.length = 0
            };

            $.ajaxSetup({
                beforeSend: function(jqXHR) { // before jQuery send the request we will push it to our array
                    $.xhrPool.push(jqXHR);
                },
                complete: function(jqXHR) { // when some of the requests completed it will splice from the array
                    var index = $.xhrPool.indexOf(jqXHR);
                    if (index > -1) {
                        $.xhrPool.splice(index, 1);
                    }
                }
            });
        }
    };
    $(debt_manager_settings.init);
})();
    
</script>
