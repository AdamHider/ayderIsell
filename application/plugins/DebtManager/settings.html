<div id='userList'>
    <div class="user-name"><b>Пользователь:</b></div>
    <select  name="manager_id" title="Закреплен за" onchange="App.debt_manager_settings.getSettings(this.value)">
        {{staff_list}}
        <option value="{{user_id}}">{{full_name}}</option>
        {{/staff_list}}
    </select>
</div>
    


<form>
    <div class="plugin_settings" style="display:none;">
        <div class="debt-settings-input">
            <label>Группировать дату по:</label>
            <select name="group_by_date" onchange="App.debt_manager_settings.updateSettings()">
                <option value="DAY">дням</option>
                <option value="WEEK">неделям</option>
                <option value="MONTH">месяцам</option>
                <option value="QUARTER">кварталам</option>
                <option value="YEAR">годам</option>
            </select>
        </div>
        <div class="debt-settings-input">
            <label>Группировать по клиентам:</label>
            <select name="group_by_pcomp"  onchange="App.debt_manager_settings.updateSettings()">
                <option value="1">Да</option>
                <option value="0">Нет</option>
            </select>
        </div>
        <div class="debt-settings-input">
            <label>Показывать долги клиента: </label>
            <div class="inp_group">
                <input title="" name="pcomp_name" value="" readonly="readonly" required="required" style="width:100px" placeholder="Все"/>
                <input name="pcomp_id" value="" type="hidden" required="required" style="width:100px"/>
                <button type="button" class="tiny_button" onclick="App.debt_manager_settings.select_pcomp()"><img src="img/settings.png"> Выбрать</button>
            </div>
        </div>
        <div>
            <div class="debt-settings-checkbox">
                <label for="buy_trans">Наши долги</label>
                <input type="checkbox" class="checkbox" name="buy_trans" onchange="App.debt_manager_settings.updateSettings()"
                       >
            </div>
            <div class="debt-settings-checkbox">
                <label for="sell_trans">Долги клиентов</label>
                <input type="checkbox" class="checkbox"  name="sell_trans" onchange="App.debt_manager_settings.updateSettings()"
                       >
            </div>
            <div  class="debt-settings-checkbox">
                <label for="notificate">Включить уведомления</label>
                <input type="checkbox" class="checkbox"  name="notificate" onchange="App.debt_manager_settings.updateSettings()"
                       >
            </div>
        </div>
        <div class="debt-settings-input">
            <div>
                <label for="notificate">Разрешенные клиенты:</label>
            </div>
            <div class="assigned-input">
                <div>Добавить клиента</div>
                <a class="icon-24 icon-create" onclick="App.debt_manager_settings.addPath()"></a>
                <div>
                    <textarea name="user_assigned_path" onchange="App.debt_manager_settings.updateSettings()"></textarea>
                </div>
            </div>
            
        </div>
    </div>
    <div class="plugin_notinstalled">
        <h1>Плагин не установлен</h1>
    </div>
</form>
<style>
  
    .debt-settings-input, .debt-settings-checkbox {
        padding: 3px;
    }
    .debt-settings-input select{
        height:24px;
    }
    .debt-settings-checkbox input{
        height:20px;
        width:20px;
    }
    .debt-settings-input{
        display: grid;
        grid-template-columns: 33% 33% 33%;
    }
    .debt-settings-checkbox{
        display: grid;
        grid-template-columns: 33% 33% 33%;
    }
    #userList{
        border-bottom: 1px solid #fff;
        display: grid;
        grid-template-columns: 14% 33%;
    }
    #userList select{
        padding: 5px;
        margin: 5px;
    }
    #userList .user-name{
        margin: 5px;
        padding: 5px;
        font-size: 13px;
    }
    .assigned-input{
        display: grid;
        grid-template-columns: 44% 50%;
        align-items: center;
    }
</style>
<script>
    App.debt_manager_settings = {
        data:{},
        filter: {},
        block:'',
        block_template: '',
        empty_block_template: '',
        block_list:[],
        current_id: 0,
        init: function () {
            if( Plugins.currentData.is_activated==1 ){
                if(Plugins.currentData.plugin_settings.length>1){
                    App.debt_manager_settings.data = Plugins.currentData.plugin_settings;
                } else {
                    App.debt_manager_settings.data = {
                        group_by_date:'MONTH',
                        group_by_pcomp:0,
                        pcomp_id:0,
                        buy_trans:true,
                        sell_trans:true,
                        notificate:0,
                        event_id:0,
                        user_assigned_path:''
                    }
                }
                App.debt_manager_settings.loadUserList();
                App.debt_manager_settings.getSettings();
                $(".plugin_settings").show();
                $(".plugin_notinstalled").hide();
            } else {
                $(".plugin_settings").hide();
                $(".plugin_notinstalled").show();
            }
        },
        render: function(){
            $("select[name='group_by_date']").val(App.debt_manager_settings.data.group_by_date);
            $("select[name='group_by_pcomp']").val(App.debt_manager_settings.data.group_by_pcomp);
            $("input[name='pcomp_name']").val(App.debt_manager_settings.data.pcomp_name);
            $("input[name='pcomp_id']").val(App.debt_manager_settings.data.pcomp_id);
            $("input[name='buy_trans']").prop('checked', App.debt_manager_settings.data.buy_trans);
            $("input[name='sell_trans']").prop('checked', App.debt_manager_settings.data.sell_trans);
            $("textarea[name='user_assigned_path']").val(App.debt_manager_settings.data.user_assigned_path);
            $("input[name='notificate']").prop('checked', Boolean(Number(App.debt_manager_settings.data.notificate)));
            $('.plugin_settings').show();
        },
	loadUserList:function(){
	    App.get('Company/companyPrefsGet',function(resp){
		if( resp ){
                   var response = App.json(resp);
                   App.renderTpl('userList',response);
		}
	    });
	},
        getSettings: function(user_id){
            $.post('DebtManager/getUserSettings', {user_id: user_id}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.debt_manager_settings.data = response;
                    App.debt_manager_settings.render();
                   
                    return;
                } 
            });
        },
        updateSettings: function () {
            var checked = $("input[type=checkbox]:checked.checkbox").length;
            if(!checked) { 
                alert("Как минимум один параметр должен быть выбран.");
                $("input[name='buy_trans']").prop('checked', true);
                $("input[name='sell_trans']").prop('checked', true); 
            }
            var user_id = $('select[name=manager_id]').val();
            App.debt_manager_settings.data.group_by_date = $("select[name='group_by_date']").val();
            App.debt_manager_settings.data.group_by_pcomp = $("select[name='group_by_pcomp']").val();
            App.debt_manager_settings.data.pcomp_name = $("input[name='pcomp_name']").val();
            App.debt_manager_settings.data.pcomp_id = $("input[name='pcomp_id']").val();
            App.debt_manager_settings.data.buy_trans = $("input[name='buy_trans']").is(":checked");
            App.debt_manager_settings.data.sell_trans = $("input[name='sell_trans']").is(":checked");
            App.debt_manager_settings.data.notificate = $("input[name='notificate']").is(":checked");
            App.debt_manager_settings.data.user_assigned_path = $("textarea[name='user_assigned_path']").val();
            $.post('DebtManager/updateSettings', {user_settings: JSON.stringify(App.debt_manager_settings.data), user_id:user_id}, function (resp) {
                if (resp) {
                    var response = App.json(resp);
                    App.flash('Настройки сохранены');
                    App.debt_manager_settings.data = response;
                    App.debt_manager_settings.render();
                }
            });
        },
        select_pcomp: function () {
            App.user.pcompSelectionDialog().progress(function(status,pcomp){
                if (status === 'select' ) {
                    $("input[name=pcomp_name]").val(pcomp.label);
                    $("input[name=pcomp_id]").val(pcomp.company_id);
                    App.debt_manager_settings.updateSettings();
                } else if(status === 'reset') {
                    $("input[name=pcomp_name]").val("");
                    $("input[name=pcomp_id]").val("");
                    App.debt_manager_settings.updateSettings();
                }
            });
        },
        addPath: function(){
            return App.loadWindow('page/company/tree',{}).progress(function(status,comp){
                if( status==='select' ){
                    if(App.debt_manager_settings.data.user_assigned_path == ''){
                        App.debt_manager_settings.data.user_assigned_path += comp.path
                    } else {
                        App.debt_manager_settings.data.user_assigned_path += ','+comp.path
                    }
                    $("textarea[name='user_assigned_path']").val(App.debt_manager_settings.data.user_assigned_path) ;
                    App.debt_manager_settings.updateSettings()
                    App.debt_manager_settings.render();
                    return;
                }
                if( status==='reset' ){
                    return false;
                }
            });
        }
    };
    $(App.debt_manager_settings.init);
</script>
