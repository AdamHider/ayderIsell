<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script>
    App.CampaignManager_index = (function ($) {
        var campaign_id = 1;
        function init() {
            Campaign.init();

        }

        var Utils = {
        };


        var Campaign = {
            init: function () {
                this.get();
            },
            data: {},
            render: function (data) {
                Campaign.data = data;
                for (let i in Campaign.data.bonus_ranges) {
                    for (let k in Campaign.data.bonus_ranges[i]) {
                        if( k==='campaign_start_at' || k==='campaign_finish_at' ){
                            Campaign.data.bonus_ranges[i][k]=Campaign.data.bonus_ranges[i][k].substr(0,10);
                        }
                        Campaign.data.settings[`${k}-${Campaign.data.bonus_ranges[i].campaign_bonus_id}`] = Campaign.data.bonus_ranges[i][k];
                    }
                }
                Mark.pipes.month=function(index){
                    return ['','Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Ноябрь','Декабрь'][index];
                };
                Mark.pipes.quarter=function(index){
                    return ['','I','II','III','IV'][index];
                };
                Mark.globals.stock_categories = data.stock_category_list;
                App.renderTpl('CampaignManager', data);
                App.setupForm('#camp_manager_form', data.settings).change(function (node) {
                    if (this.name.indexOf('-') > -1) {
                        var campaign_bonus_id = this.name.split('-')[1];
                        var field = this.name.split('-')[0];
                        Bonuses.update(field, App.val(this), this.title, campaign_bonus_id);
                    } else {
                        Campaign.update(this.name, App.val(this), this.title);
                    }

                });
                Clients.init();
                Bonuses.init();
            },
            get: function () {
                $.post("CampaignManager/campaignGet", {campaign_id: campaign_id}, function (resp) {
                    var campaign = App.json(resp);
                    Campaign.render(campaign);
                });
            },
            update: function (field, value, title) {
                $.post("CampaignManager/campaignUpdate", {campaign_id: campaign_id, field: field, value: value}, function (ok) {
                    if (ok * 1) {
                        App.flash("updated " + title);
                    } else {
                        App.flash("not updated " + title);
                    }

                });
            },
            remove: function () {
                if (confirm("Delete this campaign?")) {
                    $.post("Campaign/campaignRemove", {campaign_id: campaign_id}, function (ok) {
                        if (ok * 1) {
                            App.flash("removed");
                        } else {
                            App.flash("not removed");
                        }
                    });
                }
            },
            add: function () {
                $.post("Campaign/campaignAdd", function (ok) {
                    if (ok * 1) {
                        App.flash("added");
                    } else {
                        App.flash("not added");
                    }
                });
            }
        };

        var Clients = {
            init: function () {
                var settings = {
                    columns: [
                        {id: 'label1', field: 'label', name: 'Название', width: 180},
                        {id: 'path1', field: 'path', name: 'Путь', width: 300}
                    ],
                    options: {
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter: true,
                        url: 'CampaignManager/clientListFetch',
                        params: {
                            campaign_id: campaign_id
                        }
                    }
                };
                $(".x-campaign-clients-tools").click(function (e) {
                    var action = $(e.target).data('action');
                    if (action) {
                        Clients.tools[action] && Clients.tools[action]();
                    }
                });
                Clients.grid = new SlickInfinite("#CampaignManager_clients_sg", settings);
            },
            load: function () {
                Clients.grid;
            },
            tools: {
                reload: function () {
                    Clients.grid.reload();

                }
            }
        };
        var Bonuses = {
            init: function () {
                $("#CampaignManager_bonuses_add").click(function () {
                    Bonuses.add();
                });
                $(".CampaignManager_bonuses_delete").click(function () {
                    var campaign_bonus_id=$(this).data('campaign_bonus_id');
                    Bonuses.remove(campaign_bonus_id);
                });
                Bonuses.renderViews();
            },
            add: function () {
                $.post("CampaignManager/bonusAdd", {campaign_id: campaign_id}, function () {
                    Campaign.get();
                });
            },
            remove: function (campaign_bonus_id) {
                $.post("CampaignManager/bonusRemove", {campaign_bonus_id: campaign_bonus_id}, function () {
                    Campaign.get();
                });
            },
            update: function (field, value, title, campaign_bonus_id) {
                $.post("CampaignManager/bonusUpdate", {campaign_bonus_id: campaign_bonus_id, field: field, value: value}, function (ok) {
                    if (ok * 1) {
                        App.flash("updated " + title);
                        if( field==='bonus_type' || field==='campaign_grouping_interval' ){
                            Campaign.get();
                        }
                    } else {
                        App.flash("not updated " + title);
                    }
                    //Campaign.get();
                });
            },
            renderViews:function(){
                //var tpl=$("#CampaignManager_bonus_tpl").html();
                //console.log(tpl);
                for (let range of Campaign.data.bonus_ranges){
                    for (let view of range.views){
                        Bonuses.renderChart(view);
                    }
                }
            },
            renderChart:function(view){
                var color = Chart.helpers.color;
                var ctx = document.getElementById(`bonus_chart-${view.campaign_bonus_period_id}`).getContext('2d');
                new Chart(ctx, {
                    type: 'horizontalBar',
                    data: {
                        labels: ['Red', 'Blue', 'Yellow'],
                        datasets: [{
                            data: [view.sold_total, view.period_plan1, view.period_plan2, view.period_plan3],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        elements: {
                            rectangle: {
                                borderWidth: 2,
                            }
                        },
                        responsive: true,
                        title: {
                            display: true,
                            text: 'Chart.js Horizontal Bar Chart'
                        }
                    }
                });
                
            }
        };





        var require = [
            "js/slick/lib/jquery.event.drag-2.3.0.js",
            ["js/slick/slick.core.js",
                "js/slick/slick.grid.js",
                "js/slick/plugins/slick.rowselectionmodel.js",
                "js/slick/slick.editors.js",
                "js/slick/slickinfinite.js"]
        ];
        return {
            require: require,
            init: init
        };
    })(jQuery);
</script>
<script id="CampaignManager_bonus_tpl" type = "text/html">
    {{volume_left}}
    {{bonus_result}}
    <canvas id="doughnut-chart" width="800" height="450"></canvas>
</script>



<div id="CampaignManager" style="padding: 10px;">
    <div id="camp_manager_form">
        <div class="easyui-tabs">
            <div title="Campaign 1">

            </div>
        </div>

        <div class="easyui-panel" title="Campaign Settings">
            <input type="text" title="Название" name="campaign_name">
            <select name="liable_user_id" title="Закреплен за">
                <!--{{staff_list}}-->
                <option value="{{user_id}}">{{full_name}}</option>
                <!--{{/staff_list}}-->
            </select>
        </div>
        
        
        
        
        
        <div class="easyui-panel" title="Campaign Bonuses">
            <!--{{bonus_ranges}}-->
            <div class=" leftcol-grid">
                <div style="padding: 5px">
                    <select name="bonus_type-{{campaign_bonus_id}}" title="Вид бонуса">
                        <option value="volume">Бонус с объема</option>
                        <option value="profit">Бонус с наценки</option>
                        <option value="payment">Бонус с оплаты</option>
                    </select>
                        
                    <input type="date" name="campaign_start_at-{{campaign_bonus_id}}" title="Начало">
                    <input type="date" name="campaign_finish_at-{{campaign_bonus_id}}" title="Конец">
                    <select name="campaign_grouping_interval-{{campaign_bonus_id}}" title="Интервал">
                        <option value="" selected="selected">Не группировать</option>
                        <option value="MONTH">Месяц</option>
                        <option value="QUARTER">Квартал</option>
                        <option value="YEAR">Год</option>
                    </select>
                    <!--{{if bonus_type|equals>payment|falsy}}-->
                    <select name="product_category_id-{{campaign_bonus_id}}" title="Категор. товара">
                        <option selected="selected">-</option>
                        <!--{{stock_categories}}-->
                        <option value="{{branch_id}}">{{label}}</option>
                        <!--{{/stock_categories}}-->
                    </select>
                    <input name="product_brand_filter-{{campaign_bonus_id}}" title="Бренд товара">
                    <input name="product_type_filter-{{campaign_bonus_id}}" title="Тип товара">
                    <!--{{/if}}-->
                    <input pattern="\d+" name="campaign_bonus_ratio1-{{campaign_bonus_id}}" title="План1 бонус %">
                    <input pattern="\d+" name="campaign_bonus_ratio2-{{campaign_bonus_id}}" title="План2 бонус %">
                    <input pattern="\d+" name="campaign_bonus_ratio3-{{campaign_bonus_id}}" title="План3 бонус %">
                    <div>
                        <button class="CampaignManager_bonuses_delete" data-campaign_bonus_id="{{campaign_bonus_id}}"><img src="img/delete.png" style="width:16px"> Delete</button>
                    </div>
                </div>
                <div class="CampaignManager_bonuses_views">
                    {{views}}
                        <div>
                            <div style="width:200px;">
                                <div class="bonus-period-grid">
                                    <div>Период:</div><div>{{period_month|month}} {{period_year}}г <b>{{period_quarter|quarter}} кв</b></div>
                                    <div>Объем продаж:</div><div>{{sold_total}}</div>
                                    <div>Результат:</div><div>{{bonus_result}}</div>
                                </div>
                                <input pattern="\d+" name="period_plan1--{{campaign_bonus_period_id}}" title="План 1">
                                <input pattern="\d+" name="period_plan2--{{campaign_bonus_period_id}}" title="План 2">
                                <input pattern="\d+" name="period_plan3--{{campaign_bonus_period_id}}" title="План 3">
                                <canvas id="bonus_chart-{{campaign_bonus_period_id}}" width="200" height="200"></canvas>
                            </div>
                        </div>
                    {{/views}}
                </div>
            </div>
            <hr>
            <!--{{/bonus_ranges}}-->
            <button id="CampaignManager_bonuses_add"><img src="img/add.png" > Add</button>
            
            
            
            
        </div>
        
        
        
        <div class="easyui-panel leftcol-grid" title="Campaign Clients">
            <div>
                <input type="text" title="Включить группу" name="subject_path_include">
                <input type="text" title="Исключить группу" name="subject_path_exclude">
                <select name="subject_manager_include" title="Включить закрепленных">
                    <!--{{staff_list}}-->
                    <option value="{{user_id}}">{{full_name}}</option>
                    <!--{{/staff_list}}-->
                </select>
                <select name="subject_manager_exclude" title="Исключить закрепленных">
                    <!--{{staff_list}}-->
                    <option value="{{user_id}}">{{full_name}}</option>
                    <!--{{/staff_list}}-->
                </select>
            </div>
            <div  style="width:500px;">
                <div class="x-campaign-clients-tools" style="display:grid;grid-template-columns: auto auto;">
                    <div style="font-weight: bold;padding-top: 8px;">
                        <img src="img/table16.png" style="width:16px;height: 16px;"> Список клиентов
                    </div>
                    <div style="text-align: right">
                        <span class="icon-24 icon-refresh" data-action="reload" title="Обновить"> </span> 
                    </div>                    
                </div>
                <div id="CampaignManager_clients_sg" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .leftcol-grid{
        display: grid;
        grid-template-columns: 320px auto;
    }
    .bonus-range-grid{
        display: grid;
        grid-gap:5px;
        grid-template-columns: auto auto auto auto auto auto auto auto;
    }
    .bonus-period-grid{
        display: grid;
        grid-gap:5px;
        grid-template-columns: auto auto;
    }
    .leftcol-grid input, .leftcol-grid select{
        width: 200px;
        padding: 3px;
    }
    .leftcol-grid input{
        padding: 4px;
    }
    .CampaignManager_bonuses_views {
        display: flex;
        -flex-wrap: wrap;
        height: 350px;
        overflow-x: auto;
    }
    .CampaignManager_bonuses_views>div{
        flex: 1;
        max-width: 100%;
        object-fit: cover;
        margin: 5px;
        padding: 5px;
        background-color: rgba(255,255,255,.5);
    }
    .CampaignManager_bonuses_views>div>div{
        width: 230px;
    }
    .CampaignManager_bonuses_views input{
        width:100px;
    }
</style>

