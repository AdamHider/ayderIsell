<div class="ui header">Статистика продаж за месяц</div>

<div id="CampaignStat">
    <div class="ui blue image label">
        <i class="icon user alternate"></i> Клиентов за месяц <div class="detail">{{client_count}}</div>
    </div>
    <div class="ui teal image label">
        <i class="icon file alternate"></i> Накладных за месяц <div class="detail">{{invoice_count}}</div> 
    </div>
</div>

<div id="CampaignCharts">
    {{campaigns}}
    <div class="ui segment grid stackable">
        <div class="six wide column">
            <canvas id="campaign-chart{{current_result.0.campaign_bonus_id}}" style="width: 100%"></canvas>
        </div>
        <div class="ten wide column">
            <table class="ui celled compact table unstackable" style="">
                <!--{{current_result}}-->
                <tbody>
                    <tr>
                        <td style="width:150px;">Период:</td>
                        <td>
                            {{if period_year|more>0}}
                            {{if period_month|more>0 }}
                            {{period_month|month|blank>}}
                            {{else}}
                            <b>{{period_quarter|quarter}}</b>
                            {{/if}}
                            {{period_year}}г
                            {{else}}
                            {{campaign_start_at|chop>10}} &Gt; {{campaign_finish_at|chop>10}}
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,240,100)"></i> План I:</td>
                        <td>{{period_plan1}} ({{campaign_bonus_ratio1}}%)</td>
                    </tr>
                    <!--{{if period_plan2|more>0}}-->
                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,230,255)"></i>План II:</td>
                        <td>{{period_plan2}} ({{campaign_bonus_ratio2}}%)</td>
                    </tr>
                    <!--{{if period_plan3|more>0}}-->
                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,100,255)"></i>План III:</td>
                        <td>{{period_plan3}} ({{campaign_bonus_ratio3}}%)</td>
                    </tr>
                    <!--{{/if}}-->
                    <!--{{/if}}-->
                    <tr>
                        <td>База начисления:</td>
                        <td>
                            {{if bonus_type|equals>VOLUME}}Оборот{{/if}}
                            {{if bonus_type|equals>PROFIT}}Наценка{{/if}}
                            {{if bonus_type|equals>PAYMENT}}Оплата{{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td>Группа товара:</td>
                        <td>
                            {{product_category_label|blank>*}} 
                            {{product_brand_filter|blank>*}} 
                            {{product_type_filter|blank>*}}
                        </td>
                    </tr>
                    <tr>
                        <td>Сумма:</td>
                        <td>{{bonus_base}}</td>
                    </tr>
                    <tr>
                        <td>Результат:</td>
                        <td>{{bonus_result}}</td>
                    </tr>
                </tbody>
                <!--{{/current_result}}-->
            </table>








        </div>
    </div>
    {{/campaigns}}
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script>
App.dashboardCampaigns = {
    init: function () {
        App.dashboardCampaigns.campaigns.load();
        App.dashboardCampaigns.statistics.load();
    },
    campaigns: {
        load: function () {
            $.post("../CampaignManager/bonusCalculatePersonal/", function (resp) {
                var personal_bonuses = App.json(resp);
                if (!personal_bonuses || !personal_bonuses.length) {
                    $("#CampaignCharts").html("<h2>Нет кампаний</h2>");
                    return;
                }
                App.dashboardCampaigns.campaigns.render(personal_bonuses);
            });
        },
        render: function (personal_bonuses) {
            Mark.pipes.month = function (index) {
                return ['', 'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'][index];
            };
            Mark.pipes.quarter = function (index) {
                return ['', 'Iкв', 'IIкв', 'IIIкв', 'IVкв'][index];
            };
            App.renderTpl('CampaignCharts', {campaigns: personal_bonuses});
            for (let i in personal_bonuses) {
                App.dashboardCampaigns.campaigns.chartAdd(personal_bonuses[i]);
            }
        },
        chartAdd: function (bonus_data) {
            var config = {
                type: 'doughnut',
                data: {
                    labels: ["%", ""],
                    datasets: []
                },
                options: {
                    responsive: true,
                    legend: {
                        display: false
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            };
            config.data.datasets = App.dashboardCampaigns.campaigns.chartDatasetCalc(bonus_data);
            let chart_id = "#campaign-chart" + bonus_data.current_result[0].campaign_bonus_id;
            setTimeout(function () {
                new Chart($(chart_id)[0].getContext('2d'), config);
            }, 100);
        },
        chartDatasetCalc: function (bonus_data) {
            var doughnut1 = this.chartDatasetCalcArc(bonus_data.current_result[0], 1);
            var doughnut2 = this.chartDatasetCalcArc(bonus_data.current_result[0], 2);
            var doughnut3 = this.chartDatasetCalcArc(bonus_data.current_result[0], 3);
            return [
                {data: [doughnut3, 100 - doughnut3], backgroundColor: ['rgba(100,100,255)', 'white'], label: 'План I'},
                {data: [doughnut2, 100 - doughnut2], backgroundColor: ['rgba(100,230,255)', 'white'], label: 'План II'},
                {data: [doughnut1, 100 - doughnut1], backgroundColor: ['rgba(100,240,100)', 'white'], label: 'План III'}
            ];
        },
        chartDatasetCalcArc: function (arc_data, i) {
            if (arc_data['period_plan' + i] > 0) {
                return Math.round(Math.min(arc_data.bonus_base / arc_data['period_plan' + i], 1) * 100);
            }
            return 0;
        }
    },
    statistics:{
        load:function(){
            $.post("../CampaignManager/dashboardManagerStatistics/", function (resp) {
                var stat = App.json(resp);
                if (!stat) {
                    $("#CampaignCharts").html("<h2>Нет кампаний</h2>");
                    return;
                }
                App.dashboardCampaigns.statistics.render(stat);
            });
        },
        render:function(data){
            App.renderTpl('CampaignStat',data);
        }
    }
};
$(App.dashboardCampaigns.init);
</script>