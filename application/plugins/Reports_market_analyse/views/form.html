<script>
    App.plugin_report_market={
	init:function(){
	    this.listInit();
	},
	listInit:function(){
	    var settings = {
		columns: [
                    {id:'idate',field:'idate',name:'Начало',width:100},
                    {id:'fdate',field:'fdate',name:'Конец',width:100},
                    {id:'pcomp_label',field:'pcomp_label',name:'Клиент',width:150},
                    {id:'sold_sum',field:'sold_sum',name:'Продано',width:100},
                    {id:'leftover_sum',field:'leftover_sum',name:'Остаток',width:100},
                    {id:'comment',field:'comment',name:'Коментарий',width:200}
                ],
		options: {
		    autoedit: false,
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    enableFilter: false,
		    multiSelect: false,
		    url: 'Reports_market_analyse/listFetch/'
		}
	    };
	    var grid_sg=App.plugin_report_market.grid_sg= new SlickInfinite("#report_market_rpt_sg", settings);
            grid_sg.onSelectedRowsChanged.subscribe(function(e,selection){
                var selectedRow=selection.grid.getDataItem(selection.rows[0]);
                $("#plugin_report_market_repid").val(selectedRow.report_id);
            });
            var tableTools={
		entryCreate: function () {
		    App.plugin_report_market.import();
		},
		entryDelete:function(){
		    var selected_rows = grid_sg.getSelectedRows();
		    if (!selected_rows.length) {
			App.flash("Ни одна строка не выбрана!");
			return;
		    }
		    if (!confirm("Удалить выделенные строчки?")) {
			return;
		    }
                    var report_id=grid_sg.getDataItem(selected_rows[0]).report_id;
		    $.post('Reports_market_analyse/reportDelete', {report_id:report_id}, function (ok) {
			if (ok * 1) {
			    grid_sg.reload();
			}
		    });
		},
		reload:function(){
		    grid_sg.reload();
		}
	    };
	    $(".x-plugin-market-tools").click(function (e) {
		var action = $(e.target).data('action');
		if (action) {
		    tableTools[action] && tableTools[action]();
		}
	    });
	},
        import:function (){
            var report_market_frm_tpl='<input required="required" class="easyui-datebox" name="idate" title="Начальная дата">';
            report_market_frm_tpl   +='<input required="required" class="easyui-datebox" name="fdate" title="Конечная дата">';
            report_market_frm_tpl   +='<textarea title="Коментарий" name="comment" style="width:513px;"></textarea>';
            var config=[
                {name:'Артикул',field:'article', assigned: 'B'},
                {name:'Филиал',field:'affiliate', assigned: 'C'},
                {name:'Продано шт',field:'sold', assigned: 'D'},
                {name:'Остаток шт',field:'left', assigned: 'E'}	    
            ];
            App.loadWindow('page/dialog/importer',{label:'маркет',fields_to_import:config,extra_html:report_market_frm_tpl}).progress(function(status,fvalue,Importer){
                if( status==='submit' ){
                    if( !App.pcomp ){
                        alert("Выберите клиента!");
                        App.user.pcompSelectionDialog();
                        return;
                    }
                    fvalue.pcomp_id=App.pcomp.company_id;
                    var msg="Загрузить отчет для '"+App.pcomp.label+"'?\n\n";
                    msg+="Начальная дата: "+fvalue.idate+"\n";
                    msg+="Конечная дата: "+fvalue.fdate+"\n";
                    if( confirm(msg) ){
                        $.post('Reports_market_analyse/reportImport',fvalue,function(ok){
                            if(ok*1){
                                App.plugin_report_market.grid_sg.reload();
                                Importer.close();
                            }
                        });
                    }
                }
            });
        }
    };
    
    App.require(["js/slick/lib/jquery.event.drag-2.3.0.js"],function(){
	App.require([
	    "js/slick/slick.core.js",
	    "js/slick/plugins/slick.rowselectionmodel.js",
	    "js/slick/slick.editors.js",
	    "js/slick/slickinfinite.js",
	    "js/slick/slick.grid.js"
	], function(){
	    setTimeout(function(){
		App.plugin_report_market.listInit();
	    },0);
	    //App.plugin_report_market.listInit();
	});
    })
</script>
<div style="width:800px;display: inline-block">
    <div style="text-align: right;padding: 3px;clear: left;" class="x-plugin-market-tools">
        <span class="icon-24 icon-create" title="Добавить" data-action="entryCreate"> </span>
        <span class="icon-24 icon-delete" title="Удалить выбранные строчки" data-action="entryDelete"> </span>
        <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span>
    </div>
    <div id="report_market_rpt_sg" style="height:100px;width: 780px;"></div>
    <div style="text-align: center">
        <button type="button" onclick="App.plugin_report_market.import()"><img src="img/import.png" style="width:24px;height: auto">  Загрузить файл</button>
    </div>
</div>
<form>
    <div class="inp_rule"></div>
    <input type="hidden" name="report_id" id="plugin_report_market_repid">
	<select name="group_by" title="Группировать по">
	    <option value="store_code">Филиал</option>
	    <option value="analyse_type">Тип</option>
	    <option value="analyse_brand">Бренд</option>
	    <option value="analyse_class">Класс</option>
	    <option value="product_code">Код товара</option>
	    <option value="product_article">Артикул</option>
	</select>
	<input name="group_by_filter" title="Фильтр группы">
        <div style="text-align: center">
            <button><img src="img/report24.png" style="width:24px;height: auto"> Сформировать</button>
        </div>
</form>