<script>
    function report_market_import(){
        var report_market_frm_tpl='<input required="required" class="easyui-datebox" name="idate" title="Начальная дата">';
        report_market_frm_tpl   +='<input required="required" class="easyui-datebox" name="fdate" title="Конечная дата">';
        report_market_frm_tpl   +='<textarea title="Коментарий" name="comment" style="width:513px;"></textarea>';
        var config=[
            {name:'Артикул',field:'article', assigned: 'B'},
            {name:'Филиал',field:'affiliate', assigned: 'C'},
            {name:'Продано шт',field:'sold', assigned: 'D'},
            {name:'Остаток шт',field:'left', assigned: 'E'}	    
        ];
        App.loadWindow('page/dialog/importer',{label:'маркет',fields_to_import:config,extra_html:report_market_frm_tpl}).progress(function(status,fvalue,Importer){
            if( status==='submit' ){
                if( !App.pcomp ){
                    alert("Выберите клиента!");
                    App.user.pcompSelectionDialog();
                    return;
                }
                fvalue.pcomp_id=App.pcomp.company_id;
                var msg="Загрузить отчет для '"+App.pcomp.label+"'?\n\n";
                msg+="Начальная дата: "+fvalue.idate+"\n";
                msg+="Конечная дата: "+fvalue.fdate+"\n";
                if( confirm(msg) ){
                    $.post('Reports_market_analyse/reportImport',fvalue,function(ok){
                        if(ok*1){
                            Importer.close();
                        }
                    });
                }
            }
        });
    }
    App.require([
        "js/slick/lib/jquery.event.drag-2.3.0.js",
        "js/slick/slick.core.js",
        "js/slick/slick.grid.js",
        "js/slick/plugins/slick.rowselectionmodel.js",
        "js/slick/slick.editors.js",
        "js/slick/slickinfinite.js"
    ], function(){
        var settings = {
            columns: [],
            options: {
                editable: true,
                autoedit: false,
                enableCellNavigation: false,
                enableColumnReorder: false,
                enableFilter: false,
                multiSelect: false,
                url: 'Reports_market_analyse/listFetch/'
            }
        };
        var grid_sg=App.page_dialog_importer.grid_sg = new SlickInfinite("#report_market_rpt_sg", settings);

        var importTableTools={
            entryCreate: function () {
                $.post('Importer/entryCreate',{label:App.page_dialog_importer.label},function(insert_id){
                    if( insert_id*1 ){
                        grid_sg.setFilter({A:insert_id});
                    }
                });
            },
            entryDelete:function(){
                var selected_rows = grid_sg.getSelectedRows();
                if (!selected_rows.length) {
                    App.flash("Ни одна строка не выбрана!");
                    return;
                }
                if (!confirm("Удалить выделенные строчки?")) {
                    return;
                }

                var import_ids=[];
                for(var i in selected_rows){
                    import_ids.push(grid_sg.getDataItem(selected_rows[i]).row_id);
                }
                $.post('Importer/entryDelete', {import_ids: import_ids}, function (ok) {
                    if (ok * 1) {
                        grid_sg.reload();
                    }
                });
            },
            entryDeleteAll:function(){
                if( confirm("Удалить строчки с меткой '"+App.page_dialog_importer.label+"'?") ){
                    App.post("Importer/deleteAll/",{label:App.page_dialog_importer.label},function(ok){
                        if( ok*1 ){
                            App.flash("Удалено строчки с меткой '"+App.page_dialog_importer.label+"'");
                            grid_sg.reload();
                        } else {
                            App.flash("Не удалось удалить строки");
                        }
                    });
                }
            },
            entryUpdate:function(row_id,field,value){
                $.post('Importer/entryUpdate', {row_id: row_id, field: field, value: value}, function (ok) {
                    if (ok<1) {
                        grid_sg.reload();
                    }
                });
            },
            reload:function(){
                grid_sg.reload();
            },
            upload:function(){
                $('#page_dialog_importer_file').click();
            },
            out:function( out_type ){
                var params={
                    label:App.page_dialog_importer.label,
                    out_type:(out_type||'.xlsx')
                };
                var url='Importer/viewGet/?'+$.param( params );
                if( out_type==='.print' ){
                    window.open(url,'print_tab');
                } else {
                    location.href=url;
                }
            },
            print:function(){
                this.out('.print');
            }
        };
        $(".x-importer-tools").click(function (e) {
            var action = $(e.target).data('action');
            if (action) {
                importTableTools[action] && importTableTools[action]();
            }
        });        
    });
</script>
<div id="report_market_rpt_sg"></div>
<form>
    <div style="text-align: center">
        <button type="button" onclick="report_market_import()"><img src="img/import.png" style="width:24px;height: auto">  Загрузить файл</button>
    </div>
    <div class="inp_rule"></div>
    <div class="inp_group" style="width: 350px;">
	<select name="group_by" title="Группировать по">
	    <option value="store_code">Филиал</option>
	    <option value="analyse_type">Тип</option>
	    <option value="analyse_group">Бренд</option>
	    <option value="analyse_class">Класс</option>
	    <option value="product_code">Код товара</option>
	    <option value="analyse_section">Артикул</option>
	</select>
	<input name="group_by_filter" title="Фильтр группы">
    </div>
</form>