<script src="js/jquery.sortable.js"></script>
<script src="js/yellow-text/yellow-text.js"></script>
<link rel="stylesheet" type="text/css" href="js/yellow-text/stylesheets/yellow-text-default.css" />
<script>
    App.price_list = App.page_plugins_stock_price_list_stock_price_list = {
	current_dpl_id: (new Date().getTime()),
	init: function () {
	    //this.restoreLeftHeaders();
	    $(function () {
		//App.price_list.initDrag();
		App.price_list.getDeployment(1463911365330);
	    });
	    //this.list.load();
	},
	getDeployment:function( deployment_id ){
	    $.post("plugin/stock_price_list/getDeployment/", {deployment_id: deployment_id}, function (resp) {
		var deployment=App.json(resp);
		App.price_list.current_dpl_id=deployment_id;
		App.renderTpl('price_list_availables',deployment);
		App.renderTpl('price_list_deployment',deployment.deployment);
		App.price_list.restoreLeftHeaders();
		App.price_list.initDrag();
	    });
	},
	initDrag: function () {
	    $('.connected').sortable('destroy');
	    $('.connected').sortable({
		connectWith: '.connected'
	    }).one('sortupdate', function (e, ui) {
		App.price_list.sortUpdate();
	    });
	},
	sortUpdate: function () {
	    this.restoreLeftHeaders();
	    this.initDrag();
	    this.saveUsedItems();
	},
	restoreLeftHeaders: function () {
	    $(".available_items .h1,.available_items .h2,.available_items .page").remove();
	    $(".available_items").prepend($("#price_list_templates li").clone().attr('draggable', true));
	},
	itemEdit: function (img_node) {
	    var li_node = $(img_node).parent();
	    var li_label = li_node.find('span').text();
	    if (li_node.hasClass('page')) {
		this.text.edit(li_label,li_node);
		return;
	    }
	    var new_label = prompt("Введите текст заголовка", li_label);
	    if (new_label !== null) {
		li_node.find('span').text(new_label);
		App.price_list.saveUsedItems();
	    }
	},
	saveUsedItems: function () {
	    var deployment_id = this.current_dpl_id;
	    var deployment_data = {items: [], name: $("#spl_price_name").attr('value')||"Новый прайс", id: deployment_id};
	    $(".used_items li").each(function () {
		deployment_data.items.push({
		    type: $(this).data('type'),
		    id: $(this).data('id'),
		    text: $(this).find('span').text()
		});
	    });
	    $.post("plugin/stock_price_list/save/", {deployment_id: deployment_id, deployment_data: JSON.stringify(deployment_data)}, function (ok) {
		console.log(ok);
	    });
	},
	list: {
	    create: function () {
		
	    },
	    delete: function(){
		var row=$("#price_list_dg").datagrid('getSelected');
		if( row && row.deployment_id && confirm("Удалить прайс-лист?") ){
		    $.post("plugin/stock_price_list/delete/", {deployment_id: row.deployment_id}, function (ok) {
			$('#price_list_dg').datagrid('reload');
		    });
		}
	    },
	    select:function(){
		var row=$("#price_list_dg").datagrid('getSelected');
		if( row && row.id ){
		    App.price_list.getDeployment(row.id);
		}
	    }
	},
	text:{
	    edit:function( li_label, li_node ){
		this.current_node=li_node;
		$("#price_list_wnd").show().window();
		$("#price_list_txt").val(li_label);
		$("#price_list_txt").YellowText();
	    },
	    save:function(){
		this.current_node.find('span').html($("#price_list_txt").val());
		App.price_list.saveUsedItems();
		$("#price_list_wnd").window('close');
	    }
	}
    };

</script>
<div id="price_list_templates" style="display: none">
    <li data-type="h1" class="h1"><span>Большой заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)" title="Изменить текст"></li>
    <li data-type="h2" class="h2"><span>Средний заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)" title="Изменить текст"></li>
    <li data-type="page" class="page">Произвольный текст <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)" title="Изменить текст"></li>
</div>
<table style="width:1000px;margin-right: 30px;">
    <tr>
	<td style="vertical-align: top;width:180px">
	    <div style="text-align: right;padding-right: 5px;">
		<span class="icon-24 icon-create" title="Добавить" onclick="App.price_list.list.create();"> </span>
		<span class="icon-24 icon-delete" title="Удалить" onclick="App.price_list.list.delete();"> </span>
		<span class="icon-24 icon-refresh" title="Обновить" onclick="$('#price_list_dg').datagrid('reload')"> </span>
	    </div>
	    <table class="easyui-datagrid" style="width:180px" id="price_list_dg" title="Сохраненные прайсы" data-options="
		   url:'plugin/stock_price_list/listFetch',
		   onSelect:App.price_list.list.select">
		<thead>
		    <tr>
			<th data-options="width:70,field:'date'">Дата</th>
			<th data-options="width:108,field:'name'">Название</th>
		    </tr>
		</thead>
	    </table>
	</td>
	<td style="vertical-align: top">
	    <div style="font-size:26px;border-bottom: 1px solid #999">
		Новый прайс <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)">
		
		<div style="float: right">
		    <button onclick="App.price_list.print()"><img src="img/print.png"> Напечатать</button>
		</div>
	    </div>
	    <b>Блоки которые можно добавить</b>
	    <ul id="price_list_availables" class="connected available_items" style="width:100%">
		{{availables}}
		<li data-id="{{id}}" data-type="category" title="{{path}}">
		    <span>{{text}}</span> ({{product_count}}) 
		    <i>{{path}}</i>
		</li>
		{{/availables}}
	    </ul>
	    
	    <div>
		<b>Добавленные блоки</b>
	    </div>
	    <div>
		<ul id="price_list_deployment" class="connected used_items" style="width:100%">
		    {{items}}
			{{if type|equals>category}}
			    <li data-id="{{id}}" data-type="category" title="{{path}}">
				<span>{{text}}</span> ({{product_count}}) 
				<i>{{path}}</i>
			    </li>
			{{else}}
			    <li data-type="{{type}}" class="{{type}}"><img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"> <span>{{text}}</span></li>
			{{/if}}
		    {{/items}}
		</ul>
	    </div>
	</td>
    </tr>
</table>
<div id="price_list_wnd" title="Редактор текста" data-options="width:650" style="text-align: center;display: none;padding: 10px">
    <textarea id="price_list_txt" style=""></textarea>
    <button onclick="App.price_list.text.save()"><img src="img/save-24.png"> Сохранить</button>
</div>
<style>
    .connected li{
	list-style: none;
	border: 1px solid #CCC;
	background: #fff;
	margin: 2px;
	padding: 5px;
	height: 22px;
	cursor: move;
	overflow: hidden;
    }
    .connected {
	float: left;
	padding: 10px;
	min-height: 42px;
	background-color: rgba(0,0,0,0.2);
	margin-bottom: 10px;
    }
    li.h1{
	background-color: #fc0;
	font-size: 18px;
    }
    li.h2{
	background-color: #FF9;
	font-size: 14px;
    }
    li.page{
	background-color: #Fcf;	
    }
    li.sortable-placeholder {
	border: 1px dashed #000;
	background: none;
    }
    li.sortable-dragging{}
    .available_items img{
	display: none;
    }
    .available_items li{
	width:186px;
	float: left;
    }
    .available_items li i{
	display: none;
    }
    .used_items img{
	float:right;
	padding: 2px;
	cursor: pointer;
    }
    .used_items img:hover{
	border: 1px solid #000;
	border-radius: 3px;
	margin: -1px;
	background-color: #ddd;
    }
    .used_items li i{
	display: inline;
	color:#999;
    }
</style>