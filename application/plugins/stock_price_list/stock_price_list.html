<script src="js/jquery.sortable.js"></script>
<script>
    App.price_list = App.page_plugins_stock_price_list_stock_price_list = {
	current_dpl_id: (new Date().getTime()),
	init: function () {
	    this.restoreLeftHeaders();
	    $(function () {
		App.price_list.initDrag();
	    });
	    this.list.load();
	},
	initDrag: function () {
	    $('.connected').sortable('destroy');
	    $('.connected').sortable({
		connectWith: '.connected'
	    }).one('sortupdate', function (e, ui) {
		App.price_list.sortUpdate();
	    });
	},
	sortUpdate: function () {
	    this.restoreLeftHeaders();
	    this.initDrag();
	    this.saveUsedItems();
	},
	restoreLeftHeaders: function () {
	    $(".available_items .h1,.available_items .h2,.available_items .page").remove();
	    $(".available_items").prepend($("#price_list_templates li").clone().attr('draggable', true));
	},
	itemEdit: function (img_node) {
	    var li_node = $(img_node).parent();
	    if (li_node.hasClass('page')) {
		alert(555);
		return;
	    }
	    var li_label = li_node.find('span').text();
	    var new_label = prompt("Введите текст заголовка", li_label);
	    if (new_label !== null) {
		li_node.find('span').text(new_label);
	    }
	},
	saveUsedItems: function () {
	    var deployment_id = this.current_dpl_id;
	    var deployment_data = {items: [], name: $("#spl_price_name").attr('value')||"Новый прайс", id: deployment_id};
	    $(".used_items li").each(function () {
		deployment_data.items.push({
		    type: $(this).data('type'),
		    id: $(this).data('id'),
		    text: $(this).find('span').text()
		});
	    });
	    $.post("plugin/stock_price_list/save/", {deployment_id: deployment_id, deployment_data: JSON.stringify(deployment_data)}, function (ok) {
		console.log(ok);
	    });
	},
	getDeployment:function( deployment_id ){
	    $.post("plugin/stock_price_list/getDeployment/", {deployment_id: deployment_id}, function (deployment) {

	    });
	},
	getAvailables:function(){
	    $.post("plugin/stock_price_list/getAvailables/", function (deployment) {

	    });	    
	},
	list: {
	    create: function () {
		
	    },
	    delete: function(){
		var row=$("#price_list_dg").datagrid('getSelected');
		if( row && row.deployment_id && confirm("Удалить прайс-лист?") ){
		    $.post("plugin/stock_price_list/delete/", {deployment_id: row.deployment_id}, function (ok) {
			$('#price_list_dg').datagrid('reload');
		    });
		}
	    },
	    select:function(){
		var row=$("#price_list_dg").datagrid('getSelected');
		if( row && row.deployment_id ){
		    App.price_list.getDeployment(row.deployment_id);
		}
	    }
	}
    };

</script>
<div id="price_list_templates" style="display: none">
    <li data-type="h1" class="h1"><span>Большой заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
    <li data-type="h2" class="h2"><span>Средний заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
    <li data-type="page" class="page">Произвольный текст <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
</div>
<table style="width:1000px;margin-right: 30px;">
    <tr>
	<td style="vertical-align: top;width:180px">
	    <div style="text-align: right;padding-right: 5px;">
		<span class="icon-24 icon-create" title="Добавить" onclick="App.price_list.list.create();"> </span>
		<span class="icon-24 icon-delete" title="Удалить" onclick="App.price_list.list.delete();"> </span>
		<span class="icon-24 icon-refresh" title="Обновить" onclick="$('#price_list_dg').datagrid('reload')"> </span>
	    </div>
	    <table class="easyui-datagrid" style="width:180px" id="price_list_dg" title="Сохраненные прайсы" data-options="
		   url:'plugin/stock_price_list/listFetch',
		   onSelect:App.price_list.list.select">
		<thead>
		    <tr>
			<th data-options="width:70,field:'date'">Дата</th>
			<th data-options="width:108,field:'name'">Название</th>
		    </tr>
		</thead>
	    </table>
	</td>
	<td style="vertical-align: top">
	    <div style="font-size:26px;border-bottom: 1px solid #999">
		Новый прайс <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)">
		<span style="float:right" class="icon-24 icon-print" title="Печать" onclick="Leftovers.list.out('.print')"> </span>
	    </div>
	    <b>Блоки которые можно добавить</b>
	    <ul class="connected available_items" style="width:100%">
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
	    </ul>
	    
	    <div>
		<b>Добавленные блоки</b>
	    </div>
	    
	    <div>
		<ul class="connected used_items" style="width:100%"></ul>
	    </div>
	</td>
    </tr>
</table>
<style>
    .connected li{
	list-style: none;
	border: 1px solid #CCC;
	background: #fff;
	margin: 2px;
	padding: 5px;
	height: 22px;
	cursor: move;
    }
    .connected {
	float: left;
	padding: 10px;
	min-height: 42px;
	background-color: rgba(0,0,0,0.2);
	margin-bottom: 10px;
    }
    li.h1{
	background-color: #fc0;
	font-size: 18px;
    }
    li.h2{
	background-color: #FF9;
	font-size: 14px;
    }
    li.page{
	background-color: #Fcf;	
    }
    li.sortable-placeholder {
	border: 1px dashed #000;
	background: none;
    }
    li.sortable-dragging{}
    .available_items img{
	display: none;
    }
    .available_items li{
	width:185px;
	float: left;
    }
    .used_items img{
	float:right;
	padding: 2px;
    }
    .used_items img:hover{
	border: 1px solid #000;
	border-radius: 3px;
	margin: -1px;
	background-color: #ddd;
    }
</style>