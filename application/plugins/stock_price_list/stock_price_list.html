<script src="js/jquery.sortable.js"></script>
<script>
    App.price_list=App.page_plugins_stock_price_list_stock_price_list={
	current_dpl_id:(new Date().getTime()),
	init:function(){
	    this.restoreLeftHeaders();
	    $(function () {
		App.price_list.initDrag();
	    });
	    this.list.load();
	},
	initDrag:function(){
	    $('.connected').sortable('destroy');
	    $('.connected').sortable({
		connectWith: '.connected'
	    }).one('sortupdate', function(e, ui) {
		App.price_list.sortUpdate();
	    });
	},
	sortUpdate:function(){
	    this.restoreLeftHeaders();
	    this.initDrag();
	    this.saveUsedItems();
	},
	restoreLeftHeaders:function(){
	    $(".available_items .h1,.available_items .h2,.available_items .page").remove();
	    $(".available_items").prepend( $("#price_list_templates li").clone().attr('draggable',true) );
	},
	itemEdit:function( img_node ){
	    var li_node=$(img_node).parent();
	    if( li_node.hasClass('page') ){
		alert(555);
		return ;
	    }
	    var li_label=li_node.find('span').text();
	    var new_label=prompt("Введите текст заголовка",li_label);
	    if( new_label!==null ){
		li_node.find('span').text(new_label);
	    }
	},
	saveUsedItems:function(){
	    var deployment_id=this.current_dpl_id;
	    var deployment_data={items:[],name:$("#spl_price_name").attr('value'),id:deployment_id};
	    $(".used_items li").each(function(){
		deployment_data.items.push({
		    type:$(this).data('type'),
		    id:$(this).data('id'),
		    text:$(this).find('span').text()
		});
	    });
	    $.post("plugin/stock_price_list/save/",{deployment_id:deployment_id,deployment_data:JSON.stringify(deployment_data)},function(ok){
		console.log(ok);
	    });
	},
	list:{
	    load:function(){
		$.get('plugin/stock_price_list/listFetch',function(resp){
		    var list=App.json(resp);
		    App.renderTpl('spl_bar',{list:list});
		});
	    }
	}
    };
    
</script>
<div id="price_list_templates" style="display: none">
    <li data-type="h1" class="h1"><span>Большой заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
    <li data-type="h2" class="h2"><span>Средний заголовок</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
    <li data-type="page" class="page">Произвольный текст <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
</div>
<table cellpadding="0">
    <tr>
	<td colspan="2" style="background-color: rgba(255,255,255,0.7);">
	    <div id="spl_bar">
		{{list}}
		<div>{{name}}</div>
		{{/list}}
	    </div>
	    <input type="text" id="spl_price_name" value="Новый прайс">
	</td>
    </tr>
    <tr>
	<td style="vertical-align: top;">
	    <ul class="connected available_items" style="width:200px">
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
		<li data-id="121" data-type="category"><span>Item 1</span> <img src="img/edit-16.png" onclick="App.price_list.itemEdit(this)"></li>
	    </ul>
	</td>
	<td style="vertical-align: top;">
	    <ul class="connected used_items" style="width:400px">
	    </ul>
	</td>
    </tr>
</table>
<style>
    #spl_bar{
	padding: 5px;
    }
    #spl_bar div{
	display: inline-block;
	border-radius: 3px;
	padding: 5px;
	background-color: rgba(0,0,0,0.2);
    }
    .connected li{
	list-style: none;
	border: 1px solid #CCC;
	background: #fff;
	margin: 5px;
	padding: 5px;
	height: 22px;
	cursor: move;
    }
    .connected {
	float: left;
	padding: 15px;
	min-height: 52px;
	background-color: rgba(0,0,0,0.2);
	margin: 0px;
    }
    li.h1{
	background-color: #fc0;
	padding: 4px;
	font-size: 18px;
    }
    li.h2{
	background-color: #FF9;
	font-size: 14px;
    }
    li.page{
	background-color: #Fcf;	
    }
    li.sortable-placeholder {
	border: 1px dashed #000;
	background: none;
    }
    li.sortable-dragging{}
    .available_items img{
	display: none;
    }
    .used_items img{
	float:right;
	padding: 2px;
    }
    .used_items img:hover{
	border: 1px solid #000;
	border-radius: 3px;
	margin: -1px;
	background-color: #ddd;
    }
</style>