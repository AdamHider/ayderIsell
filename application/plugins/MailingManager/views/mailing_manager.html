<script>
App.mailing_manager=
(function(){
    Mark.pipes.date_simplify=function(date){
        let now=new Date();
        let then=new Date(date);
        let simplified=`${then.getHours().toString().padStart(2, '0')}:${then.getMinutes().toString().padStart(2, '0')}`;
        if( now.getTime()-then.getTime()>24*60*60*1000 || then.getDate()!==now.getDate() ){
            simplified=`${then.getDate().toString().padStart(2, '0')}.${(then.getMonth()+1).toString().padStart(2, '0')} ${simplified}`;
        }
        return simplified;
    };
    var holder_id="PluginMailing";
    var $holder=$("#"+holder_id);
    function init() {
        Layout.init();
        MessageList.init();
        MessageEditor.init();
    }

    var Layout={
        init:function(){
            Layout.adjustHolders();
            setTimeout(function(){
                Layout.adjustHolders();
            },1000);
        },
        adjustHolders:function(){
            Layout.calcDimensions("#PluginMailingManager_maillist",0,-30);
        },
        calcDimensions:function(query, dw, dh){
            var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
            var height = (wheight  + (dh || 0)) + 'px';// - $(query).position().top - 0
            var width = $(query).parent().width() + (dw || 0);
            $(query).css('height', height);
            $(query).css('width', width);
        },
        Accordion:function(query){
            var container = $(query);
            var observer = {
                onselect: function () {}
            };
            function collapse(mode) {
                container.find(".iss_accordion").each(function (i) {
                    if( mode==='first_is_open' && i===0 ){
                        $(this).addClass("active");
                        observer.onselect(this);
                        return;
                    }
                    $(this).removeClass("active");
                    if ($(this).data('for')) {
                        $("#" + $(this).data('for')).addClass("hidden");
                    } else {
                        $(this).next().addClass("hidden");
                    }
                });
            }
            container.find(".iss_accordion").on("click", function () {
                collapse();
                $(this).addClass("active");
                if ($(this).data('for')) {
                    $("#" + $(this).data('for')).removeClass("hidden");
                } else {
                    $(this).next().removeClass("hidden");
                }
                observer.onselect(this);
            });
            setTimeout(function(){
                collapse('first_is_open');
            },0);
            return observer;
        }
    };
    var MessageList={
        current_filter:'',
        search_clock:0,
        init:function(){
            MessageList.group.load();
            MessageList.list.tpl=$("#PluginMailingManager_list_tpl").html();
            $("#PluginMailingManager_list_filter").on('input',function(){
                MessageList.current_filter=$(this).val();
                clearTimeout(MessageList.search_clock);
                MessageList.search_clock=setTimeout(function(){
                    MessageList.group.load();
                },800);
            });
        },
        initControls: function(){
            Layout.Accordion('#PluginMailingManager_maillist .clickable-list').onselect=function( node ){
                MessageList.group.selected_index=$(node).data('index');
                if(MessageList.group.selected_index === '--'){
                    return;
                }
                MessageList.list.load(MessageList.group.group_list[MessageList.group.selected_index]);
            };
            $("#PluginMailingManager_maillist .new-list").on('click',function(){
                MessageEditor.action = 'new';
                MessageEditor.message = MessageEditor.empty_message;
                MessageList.list.select(MessageEditor.action);
            });
            $("#PluginMailingManager_maillist .delete-mailgroup").on('click',function(){
                var group_id = $(this).attr('data-mailgroup_id');
                
                console.log(group_id);
                return;
            });
            $("#PluginMailingManager_maillist .run-mailgroup").on('click',function(){
                var group_id = $(this).attr('data-mailgroup_id');
                console.log(group_id);
                return;
            });
        },
        group:{
            group_list:[],
            selected_index:0,
            load:function(){
                $.get("MailingManager/messageBatchListGet",{filter:MessageList.current_filter},function(resp){
                    MessageList.group.group_list=App.json(resp);
                    MessageList.group.render();
                });
            },
            render:function(){
                App.renderTpl('PluginMailingManager_maillist',MessageList.group.group_list);
                MessageList.initControls();
            }
        },
        createNewList: function (){
            
        },
        list:{
            selected_id:0,
            load:function( group_entry ){
                var filter={
                    filter:MessageList.current_filter,
                    filter_handler:group_entry.message_handler,
                    filter_reason:group_entry.message_reason,
                    filter_date:group_entry.group_created_at
                };
                $.get("MailingManager/messageListGet",filter,function(resp){
                    var maillist=App.json(resp);
                    MessageList.list.render(maillist);
                });
            },
            render:function(maillist){
                var $list=$(`#PluginMailingManager_maillist div[data-index=${MessageList.group.selected_index}]`);
                var html=Mark.up(MessageList.list.tpl,maillist);
                $list.html(html).click(function(e){
                    var id=$(e.target.parentNode).data('id');
                    MessageList.list.select(id);
                });
            },
            select:function(id){
                if( !id || id == MessageList.list.selected_id ){
                    return;
                }
                MessageList.list.selected_id=id;
                $(`#PluginMailingManager_maillist .PluginMailingManager_list_row_selected`).removeClass('PluginMailingManager_list_row_selected');
                var $selected_row=$(`#PluginMailingManager_maillist div[data-id=${MessageList.list.selected_id}]`);
                $selected_row.addClass("PluginMailingManager_list_row_selected");
                MessageEditor.load(MessageList.list.selected_id);
            }
        }
    };
    var MessageEditor={
        empty_message: {
            message_handler: 'email',
            message_subject: '',
            reciever_field: '',
            message_body: ''
        },
        data: {},
        action: 'view',
        current_template_index: '-1',
        mail_error: '',
        init:function(){
            MessageEditor.getSettings();
            window.frames['editor_iframe'].html= '<div></div>';
        },
        initControls: function(){
            $('.recievers-list-edit').click(function(){
                var html = $(this).html();
                App.loadWindow("MailingManager/reciever_list", {html:html}).progress(function(status,data){});
            });
            App.setupForm('#PluginMailingManager_mailnew', MessageEditor.message, 'use_inp_values').change(function (node) {
                MessageEditor.message[this.name] = App.val(this);
            });
            $('.template_mark_down').click(function(){
                var field_name = $(this).attr('data-field_name');
                window.frames['editor_iframe'].tinymce.activeEditor.insertContent('{{' + field_name + '}}')
            });
            $('.save_template').click(function(){
                MessageEditor.addTemplate();
            });
            $('select[name="template_list"]').change(function(){
                MessageEditor.current_template_index = $(this).val();
                var current_template = MessageEditor.data.template_list[MessageEditor.current_template_index];
                if(current_template){
                    window.frames['editor_iframe'].tinymce.activeEditor.setContent(current_template.html);
                } else {
                    window.frames['editor_iframe'].tinymce.activeEditor.setContent('<p></p>');
                }
            });
            $('.add_new_mailing').click(function(e){
                MessageEditor.messageBatchCreate();
            });
        },
        load:function(message_id){
            if(MessageEditor.action == 'view'){
                $.post('MailingManager/messageGet', {message_id: message_id}, function (resp) {
                    if (resp) {
                        MessageEditor.message = JSON.parse(resp);
                        MessageEditor.render();
                        return;
                    }
                });
            }
            MessageEditor.render();
        },
        render: function(){
            $('#PluginMailingManager_mailnew, #PluginMailingManager_mailview').hide();
            $('#PluginMailingManager_mail' + MessageEditor.action).show();
            
            
            
            function object2array( obj ){
                var reciever_list_array=[];
                for(let reciever_list_id in obj){
                    let filter=obj[reciever_list_id];
                    filter.reciever_list_id=reciever_list_id;
                    reciever_list_array.push(filter);
                }
                return reciever_list_array;
            }
            var reciever_list_array=object2array(MessageEditor.data.reciever_list);
            
            
            var params = {
                message: MessageEditor.message, 
                reciever_list: reciever_list_array,
                template_list: MessageEditor.data.template_list
            };
            App.renderTpl('PluginMailingManager_mail' + MessageEditor.action, params);
            MessageEditor.renderMessageBody();
            MessageEditor.initControls();
            MessageEditor.action = 'view';
        },
        renderMessageBody: function(){
            if(MessageEditor.current_template_index !== '-1'){
                window.frames['editor_iframe'].html = MessageEditor.data.template_list[MessageEditor.current_template_index].html;
            } else {
                window.frames['editor_iframe'].html = '<p></p>';
            }
        },
        getSettings:function(){
            $.post('MailingManager/settingsGet', function (resp) {
                if (resp) {
                    var response = JSON.parse(resp);
                    MessageEditor.data.reciever_list = response.settings.reciever_list;
                    MessageEditor.data.template_list = response.settings.template_list;
                }
            });
        },
        updateSettings: function () {
            $.post("MailingManager/settingsUpdate", {settings: JSON.stringify(MessageEditor.data)}, function (ok) {
                if ( ok * 1 ) {
                    MessageEditor.render();
                }
            });
        },
        messageBatchCreate: function() {
            var messageBatch={
                handler:$('select[name=message_handler]').val(),
                reciever_field:$('input[name=reciever_field]').val(),
                reciever_list_id:$('select[name=reciever_list_id]').val(),
                body:window.frames['editor_iframe'].tinymce.activeEditor.getContent(),
                subject:$('input[name=message_subject]').val()
            };
            var validation_error=MessageEditor.messageBatchValidate(messageBatch);
            if( validation_error ){
                alert('Ошибка: '+validation_error);
                return;
            }
            console.log(messageBatch);
            
            $.post("MailingManager/messageBatchCreate", {message_batch: JSON.stringify(messageBatch)}, function (ok) {
                if ( ok * 1 ) {
                    App.flash("Batch created");
                }
                MessageList.group.load();
            });
        },
        messageBatchValidate: function(){
            return null;
            MessageEditor.mail_error = '';
            if(!MessageEditor.message.recievers && (!MessageEditor.message.message_reciever_list || MessageEditor.message.message_reciever_list === 'empty')){
                MessageEditor.mail_error += '\nАдресаты не указаны!';
            }
            if(MessageEditor.message.message_subject === ''){
                MessageEditor.mail_error += '\nУкажите тему!';
            }
            if(MessageEditor.message.body === ''){
                MessageEditor.mail_error += '\nПустое сообщение!';
            }
            return;
        },
        addTemplate: function(){
            var content = window.frames['editor_iframe'].tinymce.activeEditor.getContent();
            if(content == ""){
                alert('Ошибка: Пустое сообщение');
                return;
            }
            var default_template_name = 'Новый шаблон';
            if(MessageEditor.data.template_list[MessageEditor.current_template_index]){
                default_template_name = MessageEditor.data.template_list[MessageEditor.current_template_index].name;
            }
            var template_object = {
                name: prompt('Название шаблона', default_template_name),
                html: content
            }
            if(!template_object.name){
                alert('Ошибка: Пустое название шаблона!');
                return;
            }
            if(MessageEditor.current_template_index == '-1'){
                MessageEditor.data.template_list.push(template_object);
            } else {
                MessageEditor.data.template_list[MessageEditor.current_template_index] = template_object;
            }
            MessageEditor.action = 'new';
            MessageEditor.updateSettings();
        }
    };
    init();
    
    return {
        reload_recievers: function(reciever_list){
            MessageEditor.message.reciever_list = reciever_list;
            MessageEditor.action = 'new';
            MessageEditor.render();
        }
    };
})();


</script>
<script type="text/tpl" id="PluginMailingManager_list_tpl">
    <div class="PluginMailingManager_list">
        {{.}}
            <div data-id="{{message_id}}" style="display: contents;" class="PluginMailingManager_list_row">
                <div>{{reciever_field}}</div>
                <div>{{message_note}}</div>
                {{if message_status|equals>2}}
                <div>
                    <img src="img/ok.png" title="Доставлено" style="margin:2px;">
                </div>
                {{else if message_status|equals>1}}
                <div>
                    <img src="img/time.png" title="Ожидает доставки" style="margin:2px;">
                </div>
                {{else}}
                <div>
                    <img src="img/red.png" title="Не доставлено" style="margin:2px;">
                </div>
                {{/if}}
            </div>
        {{/.}}
    </div>
</script>
<div id="PluginMailingManager"  style="display: grid;grid-template-columns:600px auto">
    <div>
        <input type="search" id="PluginMailingManager_list_filter" style="width:100%;height: 35px;background-color: #fffd" placeholder="Фильтр">
        <div id="PluginMailingManager_maillist" class="iss_accordion">
            <div class="clickable-list">
            <button class="iss_accordion new-list" data-index="--">Новая рассылка</button> 
            <div class="iss_accordion_panel" data-index="--"></div>
                {{.}}
                    <button class="iss_accordion" data-index="{{#}}">
                        {{message_handler}} ({{message_count}}) / {{message_reason}} / {{created_at|date_simplify}}
                        <b class="delete-mailgroup" data-mailgroup_id="{{#}}" style="cursor: pointer;">❌</b>
                        <b class="run-mailgroup" data-mailgroup_id="{{#}}" style="cursor: pointer;">▶</b>
                    </button>
                    <div class="iss_accordion_panel" data-index="{{#}}"></div>
                {{/.}}
            </div>
        </div>
    </div>
    
    
    
    
    
    
    <div id="PluginMailingManager_mailview" class="right-block" style="display: none">
        <div class="mail-panel-header">
            <div class="inp_group info-row">
                    <b>Тип сообщения:</b>
                    <div class="info-column">{{ message.message_handler }}</div>
            </div>
            <div class="inp_group info-row">
                    <b>Кому:</b>
                    <div class="info-column">{{ message.reciever_field }}</div>
            </div>
            <div class="inp_group info-row">
                    <b>Тема:</b>
                    <div class="info-column">{{ message.message_subject }}</div>
            </div>
        </div>
        <div class="mail-panel-body">    
            <div class="inp_group message-body-row">
                    <div class="message-body-column">{{ message.body }}</div>
            </div>
        </div>
    </div>
    <div id="PluginMailingManager_mailnew" class="right-block" style="display: none">
        <div class="mail-panel-header">
            <div class="type-row row">
                <select  name="message_handler">
                      <option value="email">Email</option>
                      <option value="sms">Sms</option>
                </select>
            </div>
            <div class="reciever-row row">
                <input type="text" placeholder="Кому" name="reciever_field" value="">
                <select class="recievers-list"  name="reciever_list_id">
                   <option value="empty">--Выберите список--</option>
                    <!--{{reciever_list}}-->
                   <option value="{{ reciever_list_id }}">{{ reciever_list_name }}</option>
                     <!--{{/reciever_list}}-->
                </select>
                <button class="recievers-list-edit">Редактировать списки</button>
            </div>
            <div class="subject-row row">
                <input type="text" placeholder="Тема" name="message_subject" value="">
            </div>
        </div>
        <div class="mail-panel-body">  
            <div class="iframe-block">
                <iframe id="editor_iframe" name="editor_iframe" style="height:474px;width: 100%;border: none;" src="page/dialog/text_editor_iframe.html"></iframe>
                <div class="iframe-buttons">
                    <button class="template_mark_down" data-field_name="company_name">Название компании</button>
                    <button class="template_mark_down" data-field_name="company_person">Контактное лицо</button>
                    <button class="template_mark_down" data-field_name="company_director">Директор</button>
                    <button class="template_mark_down" data-field_name="company_email">Эл. Почта</button>
                    <button class="template_mark_down" data-field_name="company_web">Веб-сайт</button>
                    <button class="template_mark_down" data-field_name="company_mobile">Номер телефона</button>
                    <button class="template_mark_down" data-field_name="company_address">Физический адрес</button>
                    <button class="template_mark_down" data-field_name="company_bank_name">Название банка</button>
                </div>
            </div>
            <div class="templates-row">
                <button class="save_template">Сохранить шаблон</button>
                <select name="template_list" >
                    <option value="-1">--Новый шаблон--</option>
                    <!--{{template_list}}
                    {{if name}}-->
                    <option value="{{#}}">{{name}}</option>
                    <!--{{/if}}
                    {{/template_list}}-->
                </select>
            </div>
            <div class="submit-row">
                <button class="add_new_mailing">➕ Создать рассылку</button>
            </div>
        </div>
    </div>
</div>
<style>
    button.iss_accordion {
        color: #444;
        cursor: pointer;
        padding: 5px;
        margin-bottom: 1px;
        width: 100%;
        border: none;
        border-radius: 0px;
        text-align: left;
        outline: none;
        font-size: 12px;
        transition: 0.8s;
        background: #Fff;
        height: 35px;
    }
    button.iss_accordion.active, button.iss_accordion:hover {
        background-color: #Fe9;
    }
    .iss_accordion_panel {
        display: block;
        background-color: rgba(255,255,255,.3);
        max-height: 300px;
        overflow: auto;
    }
    .PluginMailingManager_list{
        display: grid;
        grid-template-columns: minmax(auto, 270px) minmax(auto, 250px) 50px;
        grid-row-gap:2px;
        margin-left:10px;
        padding-top: 2px;
        padding-bottom: 2px;
    }
    .PluginMailingManager_list div{
        background-color: #fff6;
        height: 25px;
        padding: 2px;
        padding-top: 3px;
        text-overflow:elipsis;
    }
    .PluginMailingManager_list_row:hover div{
        background-color: #fffd;
        cursor: pointer;
    }
    .PluginMailingManager_list_row_selected div{
        background-color: #fffd;
    }

    .iss_accordion  button b{
        float: right;
        padding: 5px 0.5em;
        font-size: 13px;
        border-radius: 5px;
        margin: -8px 0.1em;
    }
    
    .iss_accordion  button b:hover{
        color: #1b71bd;
        background-color: aliceblue;
    }
    /*======================================*/
    .right-block{
        background-color: #ffffffc2;
        border-left: 2px solid lightgray;
    }
    .right-block .mail-panel-header{
        background-color: #ffffff8c;
        padding: 0.5em;
    }
    
    .right-block .mail-panel-body{
        border-top: 1px solid lightgray;
    }


    
    #PluginMailingManager_mailnew .inp_group{
        
    }
    #PluginMailingManager_mailnew .reciever-row{
        display: grid;
        grid-template-columns: 60% 20% 20%;
    }
    
    #PluginMailingManager_mailnew .row{
        padding: 0.3em;
        border-bottom: 1px solid lightgray;
    }
    #PluginMailingManager_mailnew .templates-row button,
    #PluginMailingManager_mailnew .templates-row select,
    #PluginMailingManager_mailnew .row button,
    #PluginMailingManager_mailnew .row select{
        height: 30px;
    }    
    #PluginMailingManager_mailnew .row input{
        width: 100%;
        border: none;
        background-color: transparent;
        height: 30px;
    }
    
    #PluginMailingManager_mailnew  .inp_group label{
        display: grid;
        grid-template-columns: 10% 75% auto;
    }
    #PluginMailingManager_mailnew .right-block .inp_group b{
        width: auto;
    }

    #PluginMailingManager_mailnew  textarea{
        width: 100%;
        height: 300px;
    }
    #PluginMailingManager_mailnew .iframe-block{
        display: grid;
        grid-template-columns: 85% 15%;
    }
    #PluginMailingManager_mailnew .iframe-buttons{
        background-color: #ffffff82;
        border: 1px solid lightgray;
    }
    #PluginMailingManager_mailnew .iframe-buttons button{
        display: block;
        width: 97%;
        background-color: white;
        border: 1px solid lightgray;
        padding: 0.7em;
        border-radius: 0;
        margin: 5px 3px;
        cursor: pointer;
        transition: 0.2s ease;
    }
    #PluginMailingManager_mailnew .iframe-buttons button:hover{
        background: #4884d5;
        color: white;
    }
    #PluginMailingManager_mailnew .templates-row{
        padding: 0.5em;
        background-color: white;
        border-bottom: 1px solid lightgray;
    }
    
    #PluginMailingManager_mailnew .submit-row{
        padding: 0.5em;
        text-align: center;
    }
    #PluginMailingManager_mailview .inp_group{
        padding: 0.5em;
        margin: 0;
    }
    #PluginMailingManager_mailview .inp_group.info-row{
        display: block ruby
    }
    #PluginMailingManager_mailnew .inp_group b,
    #PluginMailingManager_mailview .inp_group b{
        font-weight: bold;
    }
    #PluginMailingManager_mailview .info-column{
        margin-left: 0.5em;
        font-style: italic;
    }
    #PluginMailingManager_mailview .message-body,
    #PluginMailingManager_mailview .message-table{
        width: 100% !important; 
    }
    #PluginMailingManager_mailview .message-body-column{
        margin: 2em auto;
        padding: 1.5em;
    }
</style>
