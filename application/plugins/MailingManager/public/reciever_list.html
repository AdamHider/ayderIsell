<script>
    App.MailingManager_reciever_list={
        data: {},
        current_reciever_list_index: 0,
        filter:{
            manager_include: '',
            manager_exclude: '',
            whitelist: ''
        },
        properties:{
	    title: 'Списки адресатов',
	    width: 950,
	    height: 'auto',
	    shadow:false,
	    onClose: function(){
		App.MailingManager_reciever_list.handler.notify('close',App.MailingManager_reciever_list.data);
		App.MailingManager_reciever_list.node.window('destroy');
		App.MailingManager_reciever_list.node.remove();
                App.mailing_manager.reload_recievers(App.MailingManager_reciever_list.data.settings.reciever_list);
		delete App.MailingManager_reciever_list;
	    }
	},
	init:function () {
	    var props=App.MailingManager_reciever_list.properties;
            if(App.MailingManager_reciever_list.data.inline){
                props.title='';
                App.MailingManager_reciever_list.node.panel(props);
            } else {
                App.MailingManager_reciever_list.node.window(props);
        	this.node.window('hcenter');
                this.node.window('window').css('position','fixed');
                this.node.window('window').css('top','40px');
            }
            App.MailingManager_reciever_list.load();
	},
        initControls: function (){
            $('.reciever-list-item').click(function(e){
                if(e.target.className == 'delete-reciver-list'){
                    return;
                };
                var reciever_list_id = $(this).attr('data-reciever_list_id');
                App.MailingManager_reciever_list.current_reciever_list_index = reciever_list_id;
                if( reciever_list_id === '-1' ){
                    App.MailingManager_reciever_list.create();
                    return;
                }
                App.MailingManager_reciever_list.markSelectedList();
                App.MailingManager_reciever_list.client_list_settings.init();
                App.MailingManager_reciever_list.client_list_grid.init();
            });
            $('.delete-reciver-list').click(function(e){
                var reciever_list_id = $(this).attr('data-reciever_list_id');
                App.MailingManager_reciever_list.delete(reciever_list_id);
                App.MailingManager_reciever_list.update();
            });
            $('#PluginMailing_recievers_blacklist input').change(function(e){
                App.MailingManager_reciever_list.data.settings.reciever_blacklist = this.value;
                App.MailingManager_reciever_list.update();
            });
        },
        load: function () {
            $.post('MailingManager/settingsGet', function (resp) {
                if (resp) {
                    var response = JSON.parse(resp);
                    if( !response.settings.reciever_list || Array.isArray(response.settings.reciever_list) ){
                        response.settings.reciever_list={};
                    }
                    App.MailingManager_reciever_list.data = response;
                    App.MailingManager_reciever_list.render();
                    App.MailingManager_reciever_list.initControls();
                    App.MailingManager_reciever_list.client_list_settings.init();
                    App.MailingManager_reciever_list.client_list_grid.init();
                }
            });
        },
        render: function () {
            var reciever_list_array=[];
            for(let reciever_list_id in App.MailingManager_reciever_list.data.settings.reciever_list){
                let filter=App.MailingManager_reciever_list.data.settings.reciever_list[reciever_list_id];
                filter.reciever_list_id=reciever_list_id;
                reciever_list_array.push(filter);
            }
            App.MailingManager_reciever_list.reciever_list_length=reciever_list_array.length;
            App.renderTpl('PluginMailing_recievers_list',{reciever_list: reciever_list_array});
            App.MailingManager_reciever_list.markSelectedList();
        },
        create: function(){
            var reciever_list_id = Date.now();
            App.MailingManager_reciever_list.data.settings.reciever_list[reciever_list_id]=
                {
                    reciever_list_name: 'Новый список '+(App.MailingManager_reciever_list.reciever_list_length+1),
                    subject_path_include: '',
                    subject_path_exclude: '',
                    subject_manager_include: [],
                    subject_manager_exclude: []
                };
            App.MailingManager_reciever_list.current_reciever_list_index = reciever_list_id;
            App.MailingManager_reciever_list.update();
        },
        update: function () {
            $.post("MailingManager/settingsUpdate", {settings: JSON.stringify(App.MailingManager_reciever_list.data.settings)}, function (ok) {
                if ( ok * 1 ){
                    App.MailingManager_reciever_list.load();
                    App.mailing_manager.reload_recievers(App.MailingManager_reciever_list.data.settings.reciever_list);
                }
            });
        },
        delete: function (reciever_list_id) {
            delete App.MailingManager_reciever_list.data.settings.reciever_list[reciever_list_id];
            App.MailingManager_reciever_list.current_reciever_list_index = '0';
        },
        markSelectedList: function(){
            $('.reciever-list-item').removeClass('reciever-list-item-active');
            $('.reciever-list-item[data-reciever_list_id="'+App.MailingManager_reciever_list.current_reciever_list_index+'"]').addClass('reciever-list-item-active');
        },
        client_list_settings: {
            init: function () {
                var current_reciever_list = App.MailingManager_reciever_list.data.settings.reciever_list[App.MailingManager_reciever_list.current_reciever_list_index];
                App.MailingManager_reciever_list.client_list_settings.load();
                App.setupForm('#PluginMailing_recievers_details', current_reciever_list, 'use_inp_values').change(function (node) {
                    App.MailingManager_reciever_list.client_list_settings.updateList(this.name, App.val(this), this.title);
                    App.MailingManager_reciever_list.update();
                    App.MailingManager_reciever_list.client_list_grid.tools.reload();
                    return;
                });
            },
            load: function () {
                App.MailingManager_reciever_list.client_list_settings.render();
            },
            render: function () {
                App.renderTpl('PluginMailing_recievers_details',{
                    blacklist: App.MailingManager_reciever_list.data.settings.blacklist,
                    staff_list: App.MailingManager_reciever_list.data.staff_list
                });
            },
            updateList: function (field, value, title) {
                App.MailingManager_reciever_list.data.settings.reciever_list[App.MailingManager_reciever_list.current_reciever_list_index][field] = value;
                return;
            }
        },
        client_list_grid: {
            init: function () {
                var settings = {
                    columns: [
                        {id: 'label1', field: 'label', name: 'Имя', width: 103},
                        {id: 'company_name', field: 'company_name', name: 'Название', width: 325},
                        {id: 'path1', field: 'path', name: 'Путь', width: 236}
                    ],
                    options: {
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter: true,
                        url: 'MailingManager/recieverListFetch',
                        params: {
                            reciever_list_id: App.MailingManager_reciever_list.current_reciever_list_index
                        }
                    }
                };
                App.MailingManager_reciever_list.client_list_grid.grid = new SlickInfinite("#PluginMailing_recievers_sg", settings);
            },
            load: function () {
                App.MailingManager_reciever_list.client_list_grid.grid;
            },
            tools: {
                reload: function () {
                    App.MailingManager_reciever_list.client_list_grid.grid.reload();

                }
            }
        }
    };
</script>
<div id="PluginMailing_recievers" style="display: grid;grid-template-columns:1fr 3fr;grid-gap:5px;padding: 5px;">
    <div id="PluginMailing_recievers_list"  style="" title="Название списка">
        <div class="reciever-list-item" data-reciever_list_id="-1">Добавить новый список</div>
        <!--{{reciever_list}}-->
        <div class="reciever-list-item" data-reciever_list_id="{{reciever_list_id}}">{{ reciever_list_name }} <b class="delete-reciver-list" data-reciever_list_id="{{reciever_list_id}}" style="cursor: pointer;">❌</b></div>
        <!--{{/reciever_list}}-->
    </div>
    <div id="PluginMailing_recievers_details" class="" title="Подробности" >
        <input type="text" title="Название" name="reciever_list_name" style="width:562px">
        <div style="display: grid;grid-template-columns:  auto">
            <div class="x-client_filter" style="display: grid;grid-template-columns:  auto auto">
                    <div>
                        <textarea title="Включить" name="subject_path_include" placeholder="Список через запятую"></textarea>
                        <select name="subject_manager_include" title="Включить" multiple size="6">
                            <!--{{staff_list}}
                            {{if full_name}}-->
                            <option value="{{user_id}}">{{full_name}}</option>
                            <!--{{/if}}
                            {{/staff_list}}-->
                        </select>
                    </div>
                    <div>
                        <textarea title="Исключить" name="subject_path_exclude" placeholder="Список через запятую"></textarea>
                        <select name="subject_manager_exclude"  title="Исключить" multiple size="6">
                            <!--{{staff_list}}
                            {{if full_name}}-->
                            <option value="{{user_id}}">{{full_name}}</option>
                            <!--{{/if}}
                            {{/staff_list}}-->
                        </select>
                    </div>
            </div>
            <div id="PluginMailing_recievers_sg" style="height: 300px;"></div>
        </div>
    </div>
</div>
<div id="PluginMailing_recievers_blacklist" >
    <label>
        <b>Черный список</b>
        <input type="text" title="Исключить" name="reciever_blacklist" value="{{reciever_blacklist}}">
    </label>
</div>
<style>
    .reciever-list-item{
        margin: 1px;
        padding: 5px;
        background: #fff;
    }
    .reciever-list-item:hover,.reciever-list-item-active{
        background-color: #fe9;
    }

</style>