<script>
    App.MailingManager_reciever_list={
        data: {},
        current_reciever_list_index: 0,
        filter:{
            manager_include: '',
            manager_exclude: '',
            whitelist: ''
        },
        properties:{
	    title: 'Управление списками получетелей',
	    width: 950,
	    height: 'auto',
	    shadow:false,
	    onClose: function(){
		App.MailingManager_reciever_list.handler.notify('close',App.MailingManager_reciever_list.data);
		App.MailingManager_reciever_list.node.window('destroy');
		App.MailingManager_reciever_list.node.remove();
		delete App.MailingManager_reciever_list;
	    }
	},
	init:function () {
	    var props=App.MailingManager_reciever_list.properties;
            App.MailingManager_reciever_list.node.window(props);
            this.node.window('hcenter');
            this.node.window('window').css('position','fixed');
            this.node.window('window').css('top','40px');
            
            App.MailingManager_reciever_list.initControls();
            App.MailingManager_reciever_list.render();
            App.MailingManager_reciever_list.reciever_filter.init();
            App.MailingManager_reciever_list.reciever_grid.init();
	},
        initControls: function (){
            $('#PluginMailing_recievers_list').click(function(e){
                var reciever_list_id = $(e.target).attr('data-reciever_list_id');
                if( !reciever_list_id ){
                    return;
                }
                if(e.target.className === 'delete-reciver-list'){
                    App.MailingManager_reciever_list.delete(reciever_list_id);
                } else {
                    App.MailingManager_reciever_list.current_reciever_list_index = reciever_list_id;
                    if( reciever_list_id === '-1' ){
                        App.MailingManager_reciever_list.create();
                    }
                    App.MailingManager_reciever_list.markSelectedList();
                    App.MailingManager_reciever_list.reciever_filter.init();
                    App.MailingManager_reciever_list.reciever_grid.init();
                }
            });
            $('#PluginMailing_recievers_blacklist input').change(function(e){
                App.MailingManager_reciever_list.data.reciever_blacklist = this.value;
                App.MailingManager_reciever_list.update();
            });
        },
        load: function () {
        },
        render: function () {
            function object2array( obj ){
                var _array=[];
                for(let _id in obj){
                    let item=obj[_id];
                    item.id=_id;
                    _array.push(item);
                }
                return _array;
            }
            var reciever_list_array=object2array(App.MailingManager_reciever_list.data.reciever_list);
            App.MailingManager_reciever_list.reciever_list_length=reciever_list_array.length;
            App.renderTpl('PluginMailing_recievers_list',{reciever_list: reciever_list_array});
            App.MailingManager_reciever_list.markSelectedList();
        },
        create: function(){
            var reciever_list_id = Date.now();
            App.MailingManager_reciever_list.data.reciever_list[reciever_list_id]=
                {
                    reciever_list_name: 'Новый список '+(App.MailingManager_reciever_list.reciever_list_length+1),
                    subject_path_include: '',
                    subject_path_exclude: '',
                    subject_manager_include: [],
                    subject_manager_exclude: []
                };
            App.MailingManager_reciever_list.current_reciever_list_index = reciever_list_id;
            App.MailingManager_reciever_list.update();
        },
        update: function () {
            App.MailingManager_reciever_list.render();
            App.MailingManager_reciever_list.handler.notify('reciever_list_updated',App.MailingManager_reciever_list.data.reciever_list);
        },
        delete: function (reciever_list_id) {
            delete App.MailingManager_reciever_list.data.reciever_list[reciever_list_id];
            App.MailingManager_reciever_list.current_reciever_list_index = '0';
            App.MailingManager_reciever_list.update();
        },
        markSelectedList: function(){
            $('.reciever-list-item').removeClass('reciever-list-item-active');
            $('.reciever-list-item[data-reciever_list_id="'+App.MailingManager_reciever_list.current_reciever_list_index+'"]').addClass('reciever-list-item-active');
        },
        reciever_filter: {
            staff_list:[],
            init: function () {
                App.MailingManager_reciever_list.reciever_filter.load();
                $('#PluginMailing_recievers_details').change(function (e) {
                    var name=e.target.name;
                    var val=App.val(e.target);
                    App.MailingManager_reciever_list.reciever_filter.updateList(name, val, '');
                    App.MailingManager_reciever_list.update();
                    App.MailingManager_reciever_list.reciever_grid.tools.reload();
                });
            },
            load: function () {
                $.post("Pref/getStaffList",function(resp){
                    App.MailingManager_reciever_list.reciever_filter.staff_list=App.json(resp);
                    App.MailingManager_reciever_list.reciever_filter.render();
                });
            },
            render: function () {
                var current_reciever_list = App.MailingManager_reciever_list.data.reciever_list[App.MailingManager_reciever_list.current_reciever_list_index];
                App.renderTpl('.x-client_filter',{
                    staff_list: App.MailingManager_reciever_list.reciever_filter.staff_list,
                    current_reciever_list:current_reciever_list
                });
                App.setupForm('#PluginMailing_recievers_details', current_reciever_list, 'use_inp_values');
            },
            updateList: function (field, value, title) {
                if(!App.MailingManager_reciever_list.data.reciever_list[App.MailingManager_reciever_list.current_reciever_list_index]){
                    App.MailingManager_reciever_list.create();
                }
                App.MailingManager_reciever_list.data.reciever_list[App.MailingManager_reciever_list.current_reciever_list_index][field] = value;
            }
        },
        reciever_grid: {
            init: function () {
                var settings = {
                    columns: [
                        {id: 'label1', field: 'label', name: 'Имя', width: 95},
                        {id: 'company_name', field: 'company_name', name: 'Название', width: 250},
                        {id: 'path1', field: 'path', name: 'Путь', width: 355}
                    ],
                    options: {
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter: true,
                        url: 'MailingManager/recieverListFetch',
                        params: {
                            reciever_list_id: App.MailingManager_reciever_list.current_reciever_list_index
                        }
                    }
                };
                App.MailingManager_reciever_list.reciever_grid.grid = new SlickInfinite("#PluginMailing_recievers_sg", settings);
            },
            load: function () {
            },
            tools: {
                reload: function () {
                    App.MailingManager_reciever_list.reciever_grid.grid.reload();

                }
            }
        }
    };
</script>
<div id="PluginMailing_recievers" style="display: grid;grid-template-columns:1fr 3fr;grid-gap:5px;padding: 5px;">
    <div id="PluginMailing_recievers_list" title="Название списка">
        <div class="reciever-list-item" data-reciever_list_id="-1">Добавить новый список</div>
        <!--{{reciever_list}}-->
        <div class="reciever-list-item" data-reciever_list_id="{{id}}">{{ reciever_list_name }} <b class="delete-reciver-list" data-reciever_list_id="{{id}}" style="cursor: pointer;">❌</b></div>
        <!--{{/reciever_list}}-->
    </div>
    <div id="PluginMailing_recievers_details">
        <input type="text" name="reciever_list_name" placeholder="Название списка" style="width:100%;height: 30px;">
        <div class="x-client_filter" style="display: grid;grid-template-columns:  auto auto">
            <div>
                Включить клиентов
                <textarea name="subject_path_include" placeholder="Список через запятую" data-skip="1" style="width:100%;color:green"></textarea>
                <select name="subject_manager_include" multiple size="6" data-skip="1" style="width:100%;color:green">
                    <!--{{staff_list}}
                    {{if full_name}}-->
                    <option value="{{user_id}}">{{full_name}}</option>
                    <!--{{/if}}
                    {{/staff_list}}-->
                </select>
            </div>
            <div>
                Исключить клиентов
                <textarea name="subject_path_exclude" placeholder="Список через запятую" data-skip="1" style="width:100%;color:darkred"></textarea>
                <select name="subject_manager_exclude" multiple size="6" data-skip="1" style="width:100%;color:darkred">
                    <!--{{staff_list}}
                    {{if full_name}}-->
                    <option value="{{user_id}}">{{full_name}}</option>
                    <!--{{/if}}
                    {{/staff_list}}-->
                </select>
            </div>
        </div>
        
        <div id="PluginMailing_recievers_sg" style="height: 200px;width:700px;"></div>
    </div>
</div>
<style>
    .reciever-list-item{
        margin: 1px;
        padding: 5px;
        background: #fff;
    }
    .reciever-list-item:hover,.reciever-list-item-active{
        background-color: #fe9;
    }
</style>