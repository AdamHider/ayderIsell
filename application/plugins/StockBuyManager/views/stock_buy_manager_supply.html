<script>
    (function ($) {
        function init() {
	    Layout.init();
	    Supplier.init();
	    Supply.init();
        }

	var Layout={
	    init:function(){
		Layout.adjustHolders();
		setTimeout(function(){
		    Layout.adjustHolders();
		},1000);
		
	    },
	    adjustHolders:function(){
		Layout.calcDimensions("#suppliers_ac",0,-30);
		Layout.calcDimensions("#supply_list_sg",0,-30);
	    },
	    calcDimensions:function(query, dw, dh){
		var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
		var height = (wheight  + (dh || 0)) + 'px';// - $(query).position().top - 0
		var width = $(query).parent().width() + (dw || 0);
		$(query).css('height', height);
		$(query).css('width', width);
	    },
	    Accordion:function(query){
		var container = $(query);
		var observer = {
		    onselect: function () {}
		};
		function collapse(mode) {
		    container.find(".accordion").each(function (i) {
			if( mode==='first_is_open' && i===0 ){
			    $(this).addClass("active");
			    return;
			}
			$(this).removeClass("active");
			if ($(this).data('for')) {
			    $("#" + $(this).data('for')).addClass("hidden");
			} else {
			    $(this).next().addClass("hidden");
			}
		    });
		}
		collapse('first_is_open');
		container.find(".accordion").on("click", function () {
		    collapse();
		    $(this).addClass("active");
		    if ($(this).data('for')) {
			$("#" + $(this).data('for')).removeClass("hidden");
		    } else {
			$(this).next().removeClass("hidden");
		    }
		    observer.onselect(this);
		});
		return observer;
	    }
	};
	/////////////////////////////////////////////////////////
	// SUPPLIER SECTION
	/////////////////////////////////////////////////////////
	var Supplier={
	    selected:{},
	    list:{},
	    init:function(){
		Supplier.accordion.load();
		$(".x-stock-buy-manager-suplier-tools").click(function (e) {
		    var action = $(e.target).data('action');
		    if (action) {
			Supplier.tools[action] && Supplier.tools[action]();
		    }
		});		
	    },
	    accordion:{
		render:function(){
		    var acc = new Layout.Accordion("#suppliers_ac");
		    Supplier.selected=null;
		    acc.onselect = function (header_node) {
			var panel = header_node.nextElementSibling;
			var index=$(panel).data('index');
			var name='';
			Supplier.selected=Supplier.list[index];
			if( Supplier.selected.supplier_id ){
			    var name=Supplier.selected.supplier_name;
			}
			Supply.grid.setFilter({supplier_name:name});
		    };
		    $("#suppliers_ac input").change(function (e) {
			var formholder = $(this).parent().parent();
			var index = formholder.data('index');
			var field = $(this).attr('name');
			var value = $(this).val();
			$.post('StockBuyManager/supplierUpdate', {supplier_id: Supplier.list[index].supplier_id, field: field, value: value}, function (ok) {
			    if (ok * 1) {
				Supply.grid.reload();
				if (field === 'supplier_sell_discount') {
				    formholder.find('input[name=supplier_sell_gain]').val('');
				}
				if (field === 'supplier_sell_gain') {
				    formholder.find('input[name=supplier_sell_discount]').val('');
				}
				if (field === 'supplier_name') {
				    Supplier.accordion.load();
				}
			    }
			});
		    });
                    $("#suppliers_ac .accordion_panel button").click(function (e) {
                        if( !confirm("Обновить цены закупки/продажи на товары от этого поставщика?") ){
                            return;
                        }
			var formholder = $(this).parent();
			var index = formholder.data('index');
                        var action = $(this).data('action');
                        console.log(Supplier.list,index);
                        $.post("StockBuyManager/supplierUpdatePrices",{supplier_id: Supplier.list[index].supplier_id},function(ok){
                            if (ok * 1) {
                                App.flash("Справочник цен обновлен");
                            }
                        });
                    });
		},
		load:function(){
		    $.get('StockBuyManager/supplierListFetch', function (resp) {
			Supplier.list = App.json(resp);
			App.renderTpl('suppliers_ac', {suppliers: Supplier.list});
			Supplier.accordion.render();
		    });
		}
	    },
	    tools:{
		reload: function () {
		    Supplier.accordion.load();
		},
		entryDelete: function () {
		    if (!Supplier.selected || !Supplier.selected.supplier_id) {
			App.flash("Поставщик не выбран!");
			return;
		    }
		    if (!confirm("Удалить выделенных поставщиков?")) {
			return;
		    }
		    var also_products = confirm("Удалить товары этого поставщика?");
		    $.post('StockBuyManager/supplierDelete', {supplier_id: Supplier.selected.supplier_id, also_products: also_products?1:0}, function (ok) {
			if (ok * 1) {
			    Supplier.accordion.load();
			    Supply.grid.setFilter({supplier_name:''});
			}
		    });
		},
		entryCreate: function () {
		    App.loadWindow('page/company/tree', {}).progress(function (status, comp) {
			if (status === 'select') {
			    $.post('StockBuyManager/supplierCreate', {supplier_company_id: comp.company_id, label: comp.label}, function (ok) {
				if (ok * 1) {
				    Supplier.accordion.load();
				    App.flash("Поставщик "+comp.label+" добавлен");
				}
			    });
			}
		    });
		}		
	    }
	};
	/////////////////////////////////////////////////////////
	// SUPPLY DATA BASE SECTION
	/////////////////////////////////////////////////////////
	var Supply={
	    grid:null,
	    init:function(){
		Supply.initTable();
		$(".x-stock-buy-manager-tools").click(function (e) {
		    var action = $(e.target).data('action');
		    if (action) {
			Supply.tools[action] && Supply.tools[action]();
		    }
		});
	    },
	    tools:{
		entryImport: function () {
		    var config = [
			{field: "supply_code", name: "Код пост.", required: true},
			{field: "supply_name", name: "Название"},
			{field: "supply_leftover", name: "Остаток"},
			{field: "supply_buy", name: "Закупка база"},
			{field: "supply_comment", name: "Комментарий"},
			{field: "product_code", name: "Код наш"},
			{field: "supply_spack", name: "В Коробке"},
			{field: "supply_bpack", name: "В Ящике"},
			{field: "supply_weight", name: "Вес"},
			{field: "supply_volume", name: "Объем"},
			{field: "supply_unit", name: "Единица"}
		    ];
		    App.loadWindow('page/dialog/importer', {label: 'закуп', fields_to_import: config}).progress(function (status, fvalue, Importer) {
			if (status === 'submit') {
			    var question = "Импортировать эти строчки без указания поставщика?";
			    fvalue.supplier_id = 0;
			    if (Supplier.selected && Supplier.selected.supplier_id) {
				question = "Импортировать эти строчки поставщику '" + Supplier.selected.supplier_name + "'?";
				fvalue.supplier_id = Supplier.selected.supplier_id;
			    }
			    if (confirm(question)) {
				App.post("StockBuyManager/entryImport/", fvalue, function (ok) {
				    App.flash("Импортировано " + ok);
				    Importer.reload();
				    Supply.tools.reload();
				});
			    }
			}
		    });
		},
		importIntoStockTable: function () {
		    var config = [
			{name: 'Код товара', field: 'product_code', required: true, assigned: 'A'},
			{name: 'Название Рус.', field: 'ru'},
			{name: 'Покупка', field: 'buy'},
			{name: 'Продажа', field: 'sell', assigned: 'D'},
			{name: 'В коробке', field: 'product_spack'},
			{name: 'В ящике', field: 'product_bpack'},
			{name: 'Вес кг', field: 'product_weight'},
			{name: 'Объем м3', field: 'product_volume'},
			{name: 'Единица', field: 'product_unit'}
		    ];
		    App.loadWindow('page/dialog/importer', {label: 'склад', fields_to_import: config}).progress(function (status, fvalue, Importer) {
			if (status === 'submit') {
			    fvalue.parent_id = 0;
			    $.post("Stock/import/", fvalue, function (ok) {
				App.flash("Добавлено/Изменено " + ok);
				Importer.reload();
			    });
			}
		    });
		},
		entryExport: function () {
		    var selected_rows = Supply.grid.getSelectedRows();
		    if (!selected_rows.length) {
			App.flash("Выберите строчки для экспорта");
		    }
		    var supply_ids = [];
		    for (var i in selected_rows) {
			supply_ids.push(Supply.grid.getDataItem(selected_rows[i]).supply_id);
		    }
		    $.post('StockBuyManager/supplyExport', {supply_ids: supply_ids}, function (ok) {
			if (ok * 1) {
			    App.flash("В таблицу Импортера добавлено строк: " + ok);
			}
			Supply.tools.importIntoStockTable();
		    });

		},
		reload: function () {
		    Supply.grid.reload();
		},
		entryDelete: function () {
		    var selected_rows = Supply.grid.getSelectedRows();
		    if (!selected_rows.length) {
			App.flash("Ни одна строка не выбрана!");
			return;
		    }
		    if (!confirm("Удалить выделенные товары?")) {
			return;
		    }

		    var supply_ids = [];
		    for (var i in selected_rows) {
			supply_ids.push(Supply.grid.getDataItem(selected_rows[i]).supply_id);
		    }
		    $.post('StockBuyManager/supplyDelete', {supply_ids: supply_ids}, function (ok) {
			if (ok * 1) {
			    Supply.grid.reload();
			}
		    });
		},
		entryCreate: function () {
		    var supplier_id = 0;
		    if (Supplier.selected && Supplier.selected.supplier_id) {
			supplier_id = Supplier.selected.supplier_id;
		    }
		    $.post('StockBuyManager/supplyCreate', {supplier_id: supplier_id}, function (insert_id) {
			if (insert_id * 1) {
			    Supply.grid.setFilter({supply_code: insert_id});
			}
		    });
		},
		out: function (out_type) {
		    var sorted = Supply.grid.getSortColumns();
		    var params = {
			sortby: sorted.length ? sorted[0].columnId : '',
			sortdir: sorted.length ? (sorted[0].sortAsc ? 'ASC' : 'DESC') : '',
			filter: JSON.stringify(Supply.grid.getFilter()),
			out_type: (out_type || '.xlsx')
		    };
		    var url = 'StockBuyManager/viewGet/?' + $.param(params);
		    if (out_type === '.print') {
			window.open(url, 'print_tab');
		    } else {
			location.href = url;
		    }
		},
		print: function () {
		    this.out('.print');
		}
	    },
	    initTable:function(){
		function AutoCompleteEditor(args) {
		    var $input;
		    var defaultValue;
		    this.keyCaptureList = [Slick.keyCode.UP, Slick.keyCode.DOWN, Slick.keyCode.ENTER];
		    this.init = function () {
			var html = "<select style='width:100%'>";
			for (var i in Supplier.list) {
			    html += Supplier.list[i].supplier_name ? "<option value='" + Supplier.list[i].supplier_name + "'>" + Supplier.list[i].supplier_name + "</option>" : "";
			}
			html += "</select>";
			$input = $(html);
			$input.appendTo(args.container);
			$input.focus();
		    };
		    this.destroy = function () {
			$input.remove();
		    };
		    this.focus = function () {
			$input.focus();
		    };
		    this.loadValue = function (item) {
			defaultValue = item[args.column.field];
			$input.val(defaultValue);
		    };
		    this.serializeValue = function () {
			return $input.val();
		    };
		    this.applyValue = function (item, state) {
			item[args.column.field] = state;
		    };
		    this.isValueChanged = function () {
			return (!($input.val() == "" && defaultValue == null)) && ($input.val() != defaultValue);
		    };
		    this.validate = function () {
			return {
			    valid: true,
			    msg: null
			};
		    };
		    this.init();
		}
		function perc(row, cell, value, columnDef, dataContext) {
		    if (!value || value == 0) {
			return "";
		    }
		    return value + " %";
		}
		function dateFormatter(row, cell, value, columnDef, dataContext) {
		    var date = value.split(' ');
		    return '<span title="' + value + '">' + date[0] + '</span>';
		}
		var settings = {
		    columns: [
			{id: "supplier_name", field: "supplier_name", name: "Поставщик", width: 110, editor: AutoCompleteEditor},
			{id: "supply_code", field: "supply_code", name: "Артикул", width: 100, sortable: true, editor: Slick.Editors.Text},
			{id: "supply_name", field: "supply_name", name: "Название", width: 300, sortable: true, editor: Slick.Editors.Text},
			{id: "supply_leftover", field: "supply_leftover", name: "Остаток", width: 50, sortable: true, editor: Slick.Editors.Text},
			{id: "supply_buy", field: "supply_buy", name: "Закупка база", width: 80, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
			{id: "supply_self", field: "supply_self", name: "Себестоимость", width: 90, sortable: true, cssClass: 'slick-align-right'},
			{id: "supply_sell_ratio", field: "supply_sell_ratio", formatter: perc, name: "Корректировка", width: 80, editor: Slick.Editors.Float, sortable: true, cssClass: 'slick-align-right'},
			{id: "supply_sell", field: "supply_sell", name: "Продажа", width: 70, sortable: true, cssClass: 'slick-align-right'},
			{id: "product_code", field: "product_code", name: "Код", width: 100, sortable: true, editor: Slick.Editors.Text},
			{id: "path", field: "path", name: "Категория на складе", sortable: true, width: 150},
			{id: "supply_comment", field: "supply_comment", name: "Комментарий", width: 150, editor: Slick.Editors.Text},
			{id: "supply_modified", field: "supply_modified", name: "Изменено", sortable: true, width: 70, formatter: dateFormatter},
			{id: "supply_spack", field: "supply_spack", name: "В Коробке", sortable: true, width: 55, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
			{id: "supply_bpack", field: "supply_bpack", name: "В Ящике", sortable: true, width: 55, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
			{id: "supply_volume", field: "supply_volume", name: "Объем", sortable: true, width: 70, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
			{id: "supply_weight", field: "supply_weight", name: "Вес", sortable: true, width: 50, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
			{id: "supply_unit", field: "supply_unit", name: "Единица", sortable: true, width: 50, editor: Slick.Editors.Text, cssClass: 'slick-align-right'}
		    ],
		    options: {
			editable: true,
			autoedit: true,
			//enableCellNavigation: true,
			enableColumnReorder: false,
			enableFilter: true,
			multiSelect: true,
			url: 'StockBuyManager/listFetch'
		    }
		};
		function supplyTableEntryUpdate(supply_id, field, value) {
		    return $.post('StockBuyManager/supplyUpdate', {supply_id: supply_id, field: field, value: value}, function (ok) {
			if (ok < 1) {
			    Supply.grid.reload();
			}
		    });
		}
		Supply.grid = new SlickInfinite("#supply_list_sg", settings);
		Supply.grid.onCellChange.subscribe(function (e, data) {
		    var updatedEntry = data.item;
		    var field = settings.columns[data.cell].field;
		    var value = updatedEntry[field];
		    supplyTableEntryUpdate(updatedEntry.supply_id, field, value).done(function () {
			//Supply.grid.rowReload(data.row);
		    });
		});
	    }
	};
        init();
    })(jQuery);
</script>
<style>
    #suppliers_ac input{
        width: 40px;
        margin-left: 5px;
    }
    #suppliers_ac label{
        display: block;
        clear: both;
        padding: 2px;
        text-align: right;
    }
    button.accordion {
        color: #444;
        cursor: pointer;
        padding: 5px;
        margin-bottom: 1px;
        width: 100%;
        border: none;
        border-radius: 0px;
        text-align: left;
        outline: none;
        font-size: 12px;
        transition: 0.8s;
    }
    button.accordion.active, button.accordion:hover {
        background-color: #Fe9; 
    }
    .accordion_panel {
        display: block;
        background-color: rgba(255,255,255,.3);
    }
    .x-stock-buy-manager-supply-holder{
        display: grid;
        grid-template-columns:200px auto;
        grid-gap:2px;
    }
</style>
<div class="x-stock-buy-manager-supply-holder">
    <div>
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Поставщики
	</div>
	<div style="float: right;" class="x-stock-buy-manager-suplier-tools">
	    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
	    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	</div>
	<div id="suppliers_ac" style="overflow-y: auto;clear: both;" class="covert">
	    {{suppliers}}
		<button class="accordion">{{supplier_name}} ({{supplier_product_count}})</button>
		<div class="accordion_panel" data-index="{{#}}">
		    {{if supplier_id}}
		    <div style="background: rgba(255,255,255,.6);padding: 3px;">{{real_name}}</div>
		    <label title="Псевдоним">Ник: <input name="supplier_name" value="{{supplier_name|blank>}}" style="width:120px"/></label>
		    <div style="background: rgba(255,255,255,.6);padding: 3px;">Расчет себестоимости</div>
		    <label>Доставка дн: <input name="supplier_delivery" value="{{supplier_delivery|blank>}}"></label>
		    <label>Отсрочка дн: <input name="supplier_defferment" value="{{supplier_defferment|blank>}}"></label>
		    <div style="background: rgba(255,255,255,.6);padding: 3px;">Расчет себестоимости</div>
		    <label>Скидка от базы %: <input name="supplier_buy_discount" value="{{supplier_buy_discount|blank>}}"></label>
		    <label>Затраты %: <input name="supplier_buy_expense" value="{{supplier_buy_expense|blank>}}"></label>
		    <div style="background:  rgba(255,255,255,.6);padding: 3px;">Расчет цены продажи</div>
		    <label>Cкидка от базы %: <input name="supplier_sell_discount" value="{{supplier_sell_discount|blank>}}"></label>
		    <label>Наценка %: <input name="supplier_sell_gain" value="{{supplier_sell_gain|blank>}}"></label>
                    <button>Обновить цены на складе</button>
		    {{/if}}
		</div>
	    {{/suppliers}}
	</div>
    </div>
    <div>
	<div style="margin-right: 20px">
	    <div style="float: left;font-weight: bold;padding-top: 8px;">
		<img src="img/table16.png" style="width:16px;height: 16px;"> Товары поставщиков
	    </div>
	    <div style="float: right;margin-right: 20px" class="x-stock-buy-manager-tools">
		<span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
		<span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
		<span class="icon-24 icon-export" title="Экспорт" data-action="entryExport"> </span> 
		<span class="icon-24 icon-import" title="Импортировать" data-action="entryImport"> </span> 
		<span class="icon-24 icon-download" title="Скачать таблицу" data-action="out"> </span> 
		<span class="icon-24 icon-print" title="Напечатать" data-action="print"> </span> 
		<span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	    </div>
	</div>
	<div id="supply_list_sg" style="clear: both;width:calc(100%);"></div>
    </div>
</div>
