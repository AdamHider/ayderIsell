<script>
    (function ($) {
	var supplylist;
	var supplierlist;
	var selectedSupplier;
	function init() {
            initTableHolders();
	    //initSupplyTable();
	    //initSupplyTableTools();
            initSupplierAccordion();
	    //initSupplierTable();
	    //initSupplierTools();
            $( window ).on("resize",initTableHolders);
	}
	function day(row, cell, value, columnDef, dataContext) {
	    if(!value || value<1){
		return "";
	    }
	    return value+" дн";
	}
	function perc(row, cell, value, columnDef, dataContext) {
	    if(!value || value==0){
		return "";
	    }
	    return value+" %";
	}
        function initTableHolders(){
            //calcDimensions( "#supplierlist_sg" );
            calcDimensions( "#supplylist_sg" );
        }
	function calcDimensions( query,dw ){
	    var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	    var height=(wheight - $(query).position().top-20) + 'px';// - $(query).position().top - 0
	    var width=$(query).parent().width();
	    $(query).css('height', height);
	    $(query).css('width', width);	    
	}
        
        function initSupplierAccordion(){
            $("#suppliers_acc").accordion({
		onSelect:function(title,index){
		    var node=$("#suppliers_acc").accordion('getPanel',index).panel('body');
		    var form=node.find('form');
		    if( form ){
			var supplier_index=$(node).attr('id').split('_')[1];
			$(node).form('load',supplierlist[supplier_index]);
			console.log(node);
		    }
		}
	    });
	    
            function loadSuppliers(){
                $.get('StockBuyManager/supplierListFetch',{offset:0,limit:1000},function(resp){
                    supplierlist=App.json(resp);
                    for(var i in supplierlist){
                        $("#suppliers_acc").accordion('add',{
                            title: supplierlist[i].supplier_name+' ('+supplierlist[i].supplier_product_count+')',
                            content: i!=0?$("#supplier_frm_tpl form").html():'',
                            selected: false,
			    id:'s_'+i
                        });
                    }
                    
                });
            }
            loadSuppliers();
        }
        /*
	 * 
	 * Supplier section
	 */
	function initSupplierTable() {
	    var settings = {
		columns: [
		    {id: "supplier_name", field: "supplier_name", name: "Поставщик", width: 110, sortable: true},
		    {id: "supplier_product_count", field: "supplier_product_count", name: "Товаров",toolTip:"Колличество товаров загруженных для поставщика", width: 60, sortable: true, cssClass: 'slick-align-right'},
		    {id: "supplier_defferment", field: "supplier_defferment",formatter:day, name: "Отсрочка",toolTip:"Отсрочка оплаты поставщику", width: 60, sortable: true, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supplier_delivery", field: "supplier_delivery",formatter:day, name: "Доставка",toolTip:"Колличество дней на доставку", width: 60, sortable: true, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supplier_buy_discount", field: "supplier_buy_discount",formatter:perc, name: "Скидка от базы",toolTip:"Процент скидки для рассчета закупочной цены", width: 100, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right',headerCssClass:'header_buy'},
		    {id: "supplier_buy_expense", field: "supplier_buy_expense",formatter:perc, name: "Затраты",toolTip:"Процент затрат при покупке для рассчета продажной цены", width: 100, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right',headerCssClass:'header_buy'},
		    {id: "supplier_sell_discount", field: "supplier_sell_discount",formatter:perc, name: "Cкидка от базы",toolTip:"Процент скидки для рассчета продажной цены", width: 100, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right',headerCssClass:'header_sell'},
		    {id: "supplier_sell_gain", field: "supplier_sell_gain",formatter:perc, name: "Наценка к себестоимости",toolTip:"Процент наценки к себестоимости для расчета продажной цены", width: 100, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right',headerCssClass:'header_sell'}
		],
		options: {
		    editable: true,
		    autoEdit: false,
		    //enableCellNavigation: true,
		    enableColumnReorder: false,
		    forceFitColumns:false,
		    url: 'StockBuyManager/supplierListFetch'
		}
	    };
	    supplierlist=new SlickInfinite("#supplierlist_sg", settings);
	    supplierlist.onBeforeEditCell.subscribe(function (e, data) {
		if (data.row < 1) {
		    return false;
		}
	    });
	    supplierlist.onCellChange.subscribe(function (e, data) {
		var updatedEntry = data.item;
		var field = settings.columns[data.cell].field;
		var value = updatedEntry[field];
		supplierTableEntryUpdate(updatedEntry.supplier_company_id, field, value).done(function(){
		    supplierlist.rowReload(data.row);
		});;
	    });
	    supplierlist.onSelectedRowsChanged.subscribe(function(e,selection){
		if( selectedSupplier===supplierlist.getDataItem(selection.rows[0]) ){
		    return false;
		}
		selectedSupplier=supplierlist.getDataItem(selection.rows[0]);
		var name=selectedSupplier.supplier_company_id?selectedSupplier.supplier_name:'';
		supplylist.setFilter({supplier_name:name});
	    });
	}
	var supplierTableTools = {
	    reload: function () {
		supplierlist.reload();
	    },
	    entryDelete: function () {
		var selected_rows = supplierlist.getSelectedRows();
		if (!selected_rows.length) {
		    App.flash("Ни одна строка не выбрана!");
		    return;
		}
		if (!confirm("Удалить выделенных поставщиков?")) {
		    return;
		}
		var also_products = confirm("Удалить товары этого поставщика?");
		var supplier_company_id = supplierlist.getDataItem(selected_rows[0]).supplier_company_id;
		$.post('StockBuyManager/supplierDelete', {supplier_company_id: supplier_company_id, also_products: also_products}, function (ok) {
		    if (ok * 1) {
			supplierlist.reload();
		    }
		});
	    },
	    entryCreate: function () {
		App.loadWindow('page/company/tree', {}).progress(function (status, comp) {
		    if (status === 'select') {
			$.post('StockBuyManager/supplierCreate', {supplier_company_id: comp.company_id, label: comp.label}, function (ok) {
			    if (ok * 1) {
				supplierlist.reload();
			    }
			});
		    }
		});
	    }
	};
	function initSupplierTools() {
	    $(".x-stock-buy-manager-suplier-tools").click(function (e) {
		var action = $(e.target).data('action');
		if (action) {
		    supplierTableTools[action] && supplierTableTools[action]();
		}
	    });
	}
	function supplierTableEntryUpdate(supplier_company_id, field, value) {
	    return $.post('StockBuyManager/supplierUpdate', {supplier_company_id: supplier_company_id, field: field, value: value}, function (ok) {
		if (ok * 1) {
		    supplierlist.reload();
		    supplylist.reload();
		}
	    });
	}
	/*
	 * Supply section
	 */
	function initSupplyTable() {
	    function AutoCompleteEditor(args) {
		var $input;
		var defaultValue;
		var scope = this;
		var calendarOpen = false;
		this.keyCaptureList = [ Slick.keyCode.UP, Slick.keyCode.DOWN, Slick.keyCode.ENTER ];
		this.init = function () {
		    var html="<select style='width:100%'>";
		    var suppliers=supplierlist.getData();
		    for(var i in suppliers){
			html+=suppliers[i].supplier_name?"<option>"+suppliers[i].supplier_name+"</option>":"";
		    }
		    html+="</select>";
		    $input = $(html);
		    $input.appendTo(args.container);
		    $input.focus();
		};
		this.destroy = function () {
		    $input.remove();
		};
		this.focus = function () {
		    $input.focus();
		};
		this.loadValue = function (item) {
		    defaultValue = item[args.column.field];
		    $input.val(defaultValue);
		    //$input[0].defaultValue = defaultValue;
		    //$input.select();
		};
		this.serializeValue = function () {
		    return $input.val();
		};
		this.applyValue = function (item, state) {
		    item[args.column.field] = state;
		};
		this.isValueChanged = function () {
		    return (!($input.val() == "" && defaultValue == null)) && ($input.val() != defaultValue);
		};
		this.validate = function () {
		    return {
			valid: true,
			msg: null
		    };
		};
		this.init();
	    }
	
	    function dateFormatter(row, cell, value, columnDef, dataContext) {
		var date_parts = value.split(' ')[0].split('-');
		var date = value.split(' ');
		return '<span title="' + value + '">' + date[0] + '</span>';
	    }
	    var settings = {
		columns: [
		    {id: "supplier_name", field: "supplier_name", name: "Поставщик", width: 110, editor: AutoCompleteEditor},
		    {id: "supply_code", field: "supply_code", name: "Артикул", width: 100, sortable: true, editor: Slick.Editors.Text},
		    {id: "supply_name", field: "supply_name", name: "Название", width: 300, sortable: true, editor: Slick.Editors.Text},
		    {id: "supply_buy", field: "supply_buy", name: "Закупка база", width: 80, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
		    {id: "supply_self", field: "supply_self", name: "Себестоимость", width: 90, sortable: true, cssClass: 'slick-align-right'},
		    {id: "supply_sell_ratio", field: "supply_sell_ratio",formatter:perc, name: "Корректировка", width: 80, editor: Slick.Editors.Float, sortable: true, cssClass: 'slick-align-right'},
		    {id: "supply_sell", field: "supply_sell", name: "Продажа", width: 70, sortable: true, cssClass: 'slick-align-right'},
		    {id: "product_code", field: "product_code", name: "Код", width: 100, sortable: true, editor: Slick.Editors.Text},
		    {id: "supply_stock_path", field: "supply_stock_path", name: "Категория на складе", sortable: true, width: 150},
		    {id: "supply_comment", field: "supply_comment", name: "Комментарий", width: 150, editor: Slick.Editors.Text},
                    {id: "supply_modified", field: "supply_modified", name: "Изменено", sortable: true, width: 70, formatter: dateFormatter},
		    {id: "supply_spack", field: "supply_spack", name: "В Коробке", sortable: true, width: 70, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supply_bpack", field: "supply_bpack", name: "В Ящике", sortable: true, width: 70, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supply_volume", field: "supply_volume", name: "Объем", sortable: true, width: 70, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
		    {id: "supply_weight", field: "supply_weight", name: "Вес", sortable: true, width: 70, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
		    {id: "supply_unit", field: "supply_unit", name: "Единица", sortable: true, width: 80, editor: Slick.Editors.Text, cssClass: 'slick-align-right'}
		],
		options: {
		    editable: true,
		    autoedit: true,
		    //enableCellNavigation: true,
		    enableColumnReorder: false,
		    enableFilter: true,
		    multiSelect: true,
		    url: 'StockBuyManager/listFetch'
		}
	    };
	    supplylist = new SlickInfinite("#supplylist_sg", settings);
	    supplylist.onCellChange.subscribe(function (e, data) {
		var updatedEntry = data.item;
		var field = settings.columns[data.cell].field;
		var value = updatedEntry[field];
		supplyTableEntryUpdate(updatedEntry.supply_id, field, value).done(function(){
		    supplylist.rowReload(data.row);
		});
	    });
	}
	var supplyTableTools = {
	    entryImport: function () {
		var config = [
		    {field: "supply_code", name: "Код пост.", required: true},
		    {field: "supply_name", name: "Название"},
		    {field: "supply_buy", name: "Закупка база"},
		    {field: "supply_comment", name: "Комментарий"},
		    {field: "product_code", name: "Код наш"},
		    {field: "supply_spack", name: "В Коробке"},
		    {field: "supply_bpack", name: "В Ящике"},
		    {field: "supply_weight", name: "Вес"},
		    {field: "supply_volume", name: "Объем"},
		    {field: "supply_unit", name: "Единица"}
		];
		App.loadWindow('page/dialog/importer', {label: 'закуп', fields_to_import: config}).progress(function (status, fvalue, Importer) {
		    if (status === 'submit') {
			var question="Импортировать эти строчки без указания поставщика?";
			fvalue.supplier_company_id=0;
			if( selectedSupplier && selectedSupplier.supplier_company_id ){
			    question="Импортировать эти строчки поставщику '"+selectedSupplier.supplier_name+"'?";
			    fvalue.supplier_company_id = selectedSupplier.supplier_company_id;
			}
			if( confirm(question) ){
			    App.post("StockBuyManager/entryImport/", fvalue, function (ok) {
				App.flash("Импортировано " + ok);
				Importer.reload();
				supplyTableTools.reload();
			    });
			}
		    }
		});
	    },
	    importIntoStockTable:function(){
		var config=[
		    {name:'Код товара',field:'product_code',required:true,assigned:'A'},
		    {name:'Название Рус.',field:'ru'},
		    {name:'Покупка',field:'buy'},
		    {name:'Продажа',field:'sell',assigned:'D'},
		    {name:'В коробке',field:'product_spack'},
		    {name:'В ящике',field:'product_bpack'},
		    {name:'Вес кг',field:'product_weight'},
		    {name:'Объем м3',field:'product_volume'},
		    {name:'Единица',field:'product_unit'}
		];
		App.loadWindow('page/dialog/importer',{label:'склад',fields_to_import:config}).progress(function(status,fvalue,Importer){
		    if( status==='submit' ){
			fvalue.parent_id=0;
			App.post("Stock/import/",fvalue,function(ok){
			    App.flash("Добавлено/Изменено "+ok);
			    Importer.reload();
			});
		    }
		});
	    },
            entryExport:function(){
		var selected_rows = supplylist.getSelectedRows();
		if (!selected_rows.length) {
		    App.flash("Выберите строчки для экспорта");
		}
		var supply_ids=[];
		for(var i in selected_rows){
		    supply_ids.push(supplylist.getDataItem(selected_rows[i]).supply_id);
		}
		$.post('StockBuyManager/supplyExport', {supply_ids: supply_ids}, function (ok) {
		    if (ok * 1) {
			App.flash("В таблицу Импортера добавлено строк: "+ok);
		    }
		    supplyTableTools.importIntoStockTable();
		});
                
            },
	    reload: function () {
		supplylist.reload();
	    },
	    entryDelete: function () {
		var selected_rows = supplylist.getSelectedRows();
		if (!selected_rows.length) {
		    App.flash("Ни одна строка не выбрана!");
		    return;
		}
		if (!confirm("Удалить выделенные товары?")) {
		    return;
		}
		
		var supply_ids=[];
		for(var i in selected_rows){
		    supply_ids.push(supplylist.getDataItem(selected_rows[i]).supply_id);
		}
		$.post('StockBuyManager/supplyDelete', {supply_ids: supply_ids}, function (ok) {
		    if (ok * 1) {
			supplylist.reload();
			supplierlist.reload();
		    }
		});
	    },
	    entryCreate: function () {
		var supplier_company_id=0;
		if( selectedSupplier && selectedSupplier.supplier_company_id ){
		    supplier_company_id = selectedSupplier.supplier_company_id;
		}
		$.post('StockBuyManager/supplyCreate',{supplier_company_id:supplier_company_id},function(insert_id){
		    if( insert_id*1 ){
			supplylist.setFilter({supply_code:insert_id});
		    }
		});
	    },
	    out:function( out_type ){
		var sorted=supplylist.getSortColumns();
		var params={
		    sortby:sorted.length?sorted[0].columnId:'',
		    sortdir:sorted.length?(sorted[0].sortAsc?'ASC':'DESC'):'',
		    filter:JSON.stringify(supplylist.getFilter()),
		    out_type:(out_type||'.xlsx')
		};
		var url='StockBuyManager/viewGet/?'+$.param( params );
		if( out_type==='.print' ){
		    window.open(url,'print_tab');
		} else {
		    location.href=url;
		}
	    },
	    print:function(){
		this.out('.print');
	    }
	};
	function initSupplyTableTools() {
	    $(".x-stock-buy-manager-tools").click(function (e) {
		var action = $(e.target).data('action');
		if (action) {
		    supplyTableTools[action] && supplyTableTools[action]();
		}
	    });
	}
	function supplyTableEntryUpdate(supply_id, field, value) {
	    return $.post('StockBuyManager/supplyUpdate', {supply_id: supply_id, field: field, value: value}, function (ok) {
		if (ok<1) {
		    supplylist.reload();
		}
		if( field==='supplier_name' ){
		    supplierlist.reload();
		}
	    });
	}	

	App.require([
	    "js/slick/lib/jquery.event.drag-2.3.0.js",
	    "js/slick/slick.core.js",
	    "js/slick/slick.grid.js",
	    "js/slick/plugins/slick.rowselectionmodel.js",
	    "js/slick/slick.editors.js",
	    "js/slick/slickinfinite.js"
	], init);
    })(jQuery);
</script>
<style>
    .header_buy{
	color: magenta;
    }
    .header_sell{
	color: green;
    }
    #suppliers_acc{
	text-align: center;
    }
    #suppliers_acc input{
	ofloat:right;
	width: 80px;
	margin-left: 5px;
    }
    #suppliers_acc label{
	display: block;
	clear: both;
	margin: 4px;
	text-align: right;
    }
    .accordion{
	border: none;
	background: none;
    }
</style>
<div id="supplier_frm_tpl" style="display: none">
    <form>
	<label>Отсрочка: <input name="supplier_defferment"></label>
	<label>Доставка: <input name="supplier_delivery"></label>
	<div style="background: rgba(255,255,255,.6);padding: 3px;">Расчет себестоимости</div>
	<label>Скидка от базы: <input name="supplier_buy_discount"></label>
	<label>Затраты: <input name="supplier_buy_expense"></label>
	<div style="background:  rgba(255,255,255,.6);padding: 3px;">Расчет цены продажи</div>
	<label>Cкидка от базы: <input name="supplier_sell_discount"></label>
	<label>Наценка: <input name="supplier_sell_gain"></label>
    </form>
</div>


<table style="width:100%">
    <tr>
        <td style="width:200px;vertical-align: top">
            <div id="suppliers_acc">
                
            </div>
            
            
                <div style="display: none;float: left;font-weight: bold;padding-top: 8px;">
                    <img src="img/table16.png" style="width:16px;height: 16px;"> Поставщики
                </div>
                <div style="display: none;float: right;margin-right: 20px" class="x-stock-buy-manager-suplier-tools">
                    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
                    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
                    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
                </div>
                <div id="supplierlist_sg" style="display: none;clear: both;overflow-x: auto;"></div>
        </td>
        <td style="vertical-align: top">
            <div>
                <div style="float: left;font-weight: bold;padding-top: 8px;">
                    <img src="img/table16.png" style="width:16px;height: 16px;"> Товары поставщиков
                </div>
                <div style="float: right;margin-right: 20px" class="x-stock-buy-manager-tools">
                    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
                    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
                    <span class="icon-24 icon-export" title="Экспорт" data-action="entryExport"> </span> 
                    <span class="icon-24 icon-import" title="Импортировать" data-action="entryImport"> </span> 
                    <span class="icon-24 icon-download" title="Скачать таблицу" data-action="out"> </span> 
                    <span class="icon-24 icon-print" title="Напечатать" data-action="print"> </span> 
                    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
                </div>
                <div id="supplylist_sg" style="clear: both;overflow-x: auto;"></div>
            </div>
        </td>
    </tr>
</table>


