<script>
    (function($){
	var supplylist;
	var supplierlist;
	function init(){
	    initSupplyTable();
	    initSupplyTableTools();
	    initSupplierTable();
	}
	function initSupplyTable(){
	    function dateFormatter(row, cell, value, columnDef, dataContext){
		var date_parts=value.split(' ')[0].split('-');
		var date=value.split(' ');
		return '<span title="'+value+'">'+date[0]+'</span>';
	    }
	    function tooltip(row, cell, value, columnDef, dataContext){
		if( !value ){
		    return '';
		}
		var parts = value.split(' ');
		var cmd = parts.shift();
		if (cmd){
		    var style='max-width:16px;height:auto';
		    return '<img src="img/' + cmd + '.png" style="'+style+'" title="' + parts.join(' ') + '">';
		}
		else{
		    return '';
		}
	    }	    
	    var settings={
		columns:[
		    {id:"product_code", field: "product_code",name: "Код", width: 50, sortable: true},
		    {id:"supplier_company", field: "supplier_company",name: "Поставщик", width: 70 },
		    {id:"supply_code", field: "supply_code",name: "Код поставщика",  width: 50, sortable: true},
		    {id:"supply_name", field: "supply_name",name: "Название поставщика", width: 200, sortable: true },
		    {id:"supply_buy", field: "supply_buy",name: "Закупка", width: 30, sortable: true,cssClass:'slick-align-right' },
		    {id:"supply_self", field: "supply_self",name: "Себестоимость", width: 30, sortable: true,cssClass:'slick-align-right'},
		    {id:"supply_delivery", field: "supply_delivery",name: "Доставка дн.", width: 30, sortable: true},
		    {id:"supply_comment", field: "supply_comment",name: "Комментарий", width: 150},
		    {id:"supply_modified", field: "supply_modified",name: "Изменено", sortable: true, width: 30,formatter:dateFormatter },
		    {id:"supply_spack", field: "supply_spack",name: "В Коробке", sortable: true, width: 30 },
		    {id:"supply_bpack", field: "supply_bpack",name: "В Ящике", sortable: true, width: 30 },
		    {id:"supply_volume", field: "supply_volume",name: "Объем", sortable: true, width: 30 },
		    {id:"supply_weight", field: "supply_weight",name: "Вес", sortable: true, width: 30 },
		    {id:"supply_unit", field: "supply_unit",name: "Единица", sortable: true, width: 30}
		],
		options:{
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    enableFilter:true,
		    multiSelect :true,
		    forceFitColumns:true,
		    fullWidthRows:false,
		    url:'StockBuyManager/listFetch'
		}
	    };
	    var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	    $("#supplylist_sg").css('height',(h-$("#supplylist_sg").position().top-30)+'px');
	    supplylist=$("#supplylist_sg").slickgrid(settings);
	}
	var supplyTableTools={
	    entryImport:function(){
		var config=[
		    {field: "supply_code",name: "Код пост.",required:true},
		    {field: "product_code",name: "Код"},
		    {field: "supply_name",name: "Название"},
		    {field: "supply_buy",name: "Закупка"},
		    {field: "supply_comment",name: "Комментарий"},
		    {field: "supply_spack",name: "В Коробке"},
		    {field: "supply_bpack",name: "В Ящике"},
		    {field: "supply_volume",name: "Объем"},
		    {field: "supply_weight",name: "Вес"},
		    {field: "supply_unit",name: "Единица"}
		];
		App.loadWindow('page/dialog/importer',{label:'закуп',fields_to_import:config}).progress(function(status,fvalue,Importer){
		    if( status==='submit' ){
			fvalue.supplier_company_id=11;
			App.post("StockBuyManager/entryImport/",fvalue,function(ok){
			    App.flash("Импортировано "+ok);
			    Importer.reload();
			    supplyTableTools.reload();
			});
		    }
		});		
	    },
	    reload:function(){
		supplylist.reload();
	    }
	};
	function initSupplyTableTools(){
	    $(".x-stock-buy-manager-tools").click(function(e){
		var action=$(e.target).data('action');
		if( action ){
		    supplyTableTools[action] && supplyTableTools[action]();
		}
	    });
	}

	function initSupplierTable(){
	    var settings={
		columns:[
		    {id:"supplier_name", field: "supplier_name",name: "Название Поставщика", width: 50, sortable: true},
		    {id:"supplier_discount", field: "supplier_discount",name: "Скидка", width: 70 },
		    {id:"supplier_defferment", field: "supplier_defferment",name: "Отсрочка",  width: 50, sortable: true},
		    {id:"supplier_delivery", field: "supplier_delivery",name: "Время дост.", width: 200, sortable: true },
		    {id:"supplier_expense", field: "supplier_expense",name: "Затраты %", width: 30, sortable: true,cssClass:'slick-align-right' }
		],
		options:{
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    url:'StockBuyManager/supplierListFetch'
		}
	    };
	    supplierlist=new SlickInfinite("#supplierlist_sg", settings);
	}
	
	
	
	
	
	
	App.require([
	    "js/slick/lib/jquery.event.drag-2.3.0.js",
	    "js/slick/slick.core.js",
	    "js/slick/slick.grid.js",
	    "js/slick/plugins/slick.rowselectionmodel.js",
	    "js/slick/slick.editors.js",
	    "js/slick/slickwrapper.js"
	],init);
    })(jQuery);
</script>
<div>
    <div id="supplierlist_sg" style="height: 100px"></div>
    <div id="supplylist_sg_tools" class="transp60">
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Документы
	</div>
	<div style="float: left" class="x-stock-buy-manager-tools">
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	    <span class="icon-24 icon-import" title="Импортировать" data-action="entryImport"> </span> 
	</div>
    </div>
    <div id="supplylist_sg" style="width:100%;height:700px;"></div>
</div>