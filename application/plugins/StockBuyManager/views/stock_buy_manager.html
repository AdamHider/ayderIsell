<script>
    (function ($) {
	var supplylist;
	var supplierlist;
	function init() {
	    initSupplyTable();
	    initSupplyTableTools();
	    initSupplierTable();
	    initSupplierTools();
	}
	function initSupplyTable() {
	    function dateFormatter(row, cell, value, columnDef, dataContext) {
		var date_parts = value.split(' ')[0].split('-');
		var date = value.split(' ');
		return '<span title="' + value + '">' + date[0] + '</span>';
	    }
	    var settings = {
		columns: [
		    {id: "supplier_name", field: "supplier_name", name: "Поставщик", width: 120},
		    {id: "supply_code", field: "supply_code", name: "Код поставщика", width: 100, sortable: true},
		    {id: "supply_name", field: "supply_name", name: "Название поставщика", width: 300, sortable: true},
		    {id: "supply_buy", field: "supply_buy", name: "Закупка", width: 70, sortable: true, cssClass: 'slick-align-right'},
		    {id: "supply_self", field: "supply_self", name: "Себестоимость", width: 70, sortable: true, cssClass: 'slick-align-right'},
		    {id: "supply_sell", field: "supply_sell", name: "Продажа", width: 70, sortable: true},
		    {id: "supply_comment", field: "supply_comment", name: "Комментарий", width: 150},
		    {id: "product_code", field: "product_code", name: "Код", width: 100, sortable: true},
		    {id: "supply_modified", field: "supply_modified", name: "Изменено", sortable: true, width: 70, formatter: dateFormatter},
		    {id: "supply_spack", field: "supply_spack", name: "В Коробке", sortable: true, width: 70},
		    {id: "supply_bpack", field: "supply_bpack", name: "В Ящике", sortable: true, width: 70},
		    {id: "supply_volume", field: "supply_volume", name: "Объем", sortable: true, width: 70},
		    {id: "supply_weight", field: "supply_weight", name: "Вес", sortable: true, width: 70},
		    {id: "supply_unit", field: "supply_unit", name: "Единица", sortable: true, width: 30}
		],
		options: {
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    enableFilter: true,
		    multiSelect: true,
		    url: 'StockBuyManager/listFetch'
		}
	    };
	    calcDimensions( "#supplylist_sg" );
	    supplylist = $("#supplylist_sg").slickgrid(settings);
	}
	function calcDimensions( query ){
	    var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	    var height=(wheight - $(query).position().top - 30) + 'px';
	    var width=$(query).parent().width();
	    $(query).css('height', height);
	    $(query).css('width', width);	    
	}
	var supplyTableTools = {
	    entryImport: function () {
		var config = [
		    {field: "supply_code", name: "Код пост.", required: true},
		    {field: "product_code", name: "Код"},
		    {field: "supply_name", name: "Название"},
		    {field: "supply_buy", name: "Закупка"},
		    {field: "supply_comment", name: "Комментарий"},
		    {field: "supply_spack", name: "В Коробке"},
		    {field: "supply_bpack", name: "В Ящике"},
		    {field: "supply_volume", name: "Объем"},
		    {field: "supply_weight", name: "Вес"},
		    {field: "supply_unit", name: "Единица"}
		];
		App.loadWindow('page/dialog/importer', {label: 'закуп', fields_to_import: config}).progress(function (status, fvalue, Importer) {
		    if (status === 'submit') {
			fvalue.supplier_company_id = 11;
			App.post("StockBuyManager/entryImport/", fvalue, function (ok) {
			    App.flash("Импортировано " + ok);
			    Importer.reload();
			    supplyTableTools.reload();
			});
		    }
		});
	    },
	    reload: function () {
		supplylist.reload();
	    }
	};
	function initSupplyTableTools() {
	    $(".x-stock-buy-manager-tools").click(function (e) {
		var action = $(e.target).data('action');
		if (action) {
		    supplyTableTools[action] && supplyTableTools[action]();
		}
	    });
	}

	function initSupplierTable() {
	    var settings = {
		columns: [
		    {id: "supplier_name", field: "supplier_name", name: "Поставщик", width: 130, sortable: true},
		    {id: "supplier_defferment", field: "supplier_defferment", name: "Отсрочка", width: 60, sortable: true, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supplier_delivery", field: "supplier_delivery", name: "Доставка", width: 60, sortable: true, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
		    {id: "supplier_discount", field: "supplier_discount", name: "% Скидка", width: 60, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right'},
		    {id: "supplier_expense", field: "supplier_expense", name: "% Затраты", width: 65, sortable: true, editor: Slick.Editors.Float, cssClass: 'slick-align-right'}
		],
		options: {
		    editable: true,
		    autoedit: true,
		    enableCellNavigation: true,
		    enableColumnReorder: false,
		    url: 'StockBuyManager/supplierListFetch'
		}
	    };
	    supplierlist = new SlickInfinite("#supplierlist_sg", settings);
	    supplierlist.onBeforeEditCell.subscribe(function (e, data) {
		if (data.row < 1) {
		    return false;
		}
	    });
	    supplierlist.onCellChange.subscribe(function (e, data) {
		var updatedEntry = data.item;
		var field = settings.columns[data.cell].field;
		var value = updatedEntry[field];
		supplierTableEntryUpdate(updatedEntry.supplier_company_id, field, value);
	    });
	}
	var supplierTableTools = {
	    reload: function () {
		supplierlist.reload();
	    },
	    entryDelete: function () {
		var selected_rows = supplierlist.getSelectedRows();
		if (!selected_rows.length) {
		    App.flash("Ни одна строка не выбрана!");
		    return;
		}
		if (!confirm("Удалить выделенных поставщиков?")) {
		    return;
		}
		var also_products = confirm("Удалить товары этого поставщика?");
		var supplier_company_id = supplierlist.getDataItem(selected_rows[0]).supplier_company_id;
		$.post('StockBuyManager/supplierDelete', {supplier_company_id: supplier_company_id, also_products: also_products}, function (ok) {
		    if (ok * 1) {
			supplierlist.reload();
		    }
		});
	    },
	    entryCreate: function () {
		App.loadWindow('page/company/tree', {}).progress(function (status, comp) {
		    if (status === 'select') {
			$.post('StockBuyManager/supplierCreate', {supplier_company_id: comp.company_id, label: comp.label}, function (ok) {
			    if (ok * 1) {
				supplierlist.reload();
			    }
			});
		    }
		});
	    }
	};
	function initSupplierTools() {
	    $(".x-stock-buy-manager-suplier-tools").click(function (e) {
		var action = $(e.target).data('action');
		if (action) {
		    supplierTableTools[action] && supplierTableTools[action]();
		}
	    });
	}
	function supplierTableEntryUpdate(supplier_company_id, field, value) {
	    $.post('StockBuyManager/supplierUpdate', {supplier_company_id: supplier_company_id, field: field, value: value}, function (ok) {
		if (ok * 1) {
		    supplierlist.reload();
		}
	    });
	}






	App.require([
	    "js/slick/lib/jquery.event.drag-2.3.0.js",
	    "js/slick/slick.core.js",
	    "js/slick/slick.grid.js",
	    "js/slick/plugins/slick.rowselectionmodel.js",
	    "js/slick/slick.editors.js",
	    "js/slick/slickwrapper.js"
	], init);
    })(jQuery);
</script>
<style>
    .bman_wrapper{
	display: grid;
	grid-template-columns: 400px auto;
	grid-gap: 10px;
	grid-auto-rows: minmax(100px, auto);
    }
</style>

<div class="bman_wrapper">
    <div>
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Поставщики
	</div>
	<div style="float: right" class="x-stock-buy-manager-suplier-tools">
	    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
	    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	</div>
	<div id="supplierlist_sg" style="height: 150px;clear: both"></div>
    </div>
    <div>
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Товары поставщиков
	</div>
	<div style="float: right;margin-right: 20px" class="x-stock-buy-manager-tools">
	    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
	    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
	    <span class="icon-24 icon-import" title="Импортировать" data-action="entryImport"> </span> 
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	</div>

	<div id="supplylist_sg" style="clear: both;width: 100%"></div>
    </div>
</div>   


